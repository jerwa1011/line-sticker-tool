<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINE Sticker Master V7 - å°ˆæ¥­å°èˆªç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;900&family=Mochiy+Pop+One&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; user-select: none; overflow: hidden; } /* ç¦æ­¢ç€è¦½å™¨é è¨­æ²è»¸ */
        .canvas-bg { 
            /* æ£‹ç›¤æ ¼èƒŒæ™¯ */
            background-image: linear-gradient(45deg, #e5e5e5 25%, transparent 25%), linear-gradient(-45deg, #e5e5e5 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #e5e5e5 75%), linear-gradient(-45deg, transparent 75%, #e5e5e5 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            background-color: #ffffff; 
        }
        .tool-btn { @apply p-2 rounded-lg border border-gray-600 hover:bg-gray-700 transition flex flex-col items-center justify-center text-xs gap-1 text-gray-300; }
        .tool-btn.active { @apply bg-blue-600 text-white border-blue-500 shadow-lg ring-2 ring-blue-400 transform scale-105; }
        input[type="range"] { @apply accent-blue-500 cursor-pointer; }
        .dark-input { @apply bg-gray-900 border border-gray-600 rounded px-2 py-1 text-sm text-white focus:ring-2 focus:ring-blue-500 outline-none; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 h-screen flex flex-col" oncontextmenu="return false;"> 
<header class="h-16 bg-gray-800 border-b border-gray-700 flex items-center justify-between px-4 shadow-lg z-20 shrink-0">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-purple-600 rounded-full flex items-center justify-center text-xl font-bold text-white shadow-lg">V7</div>
            <div>
                <h1 class="font-bold text-lg tracking-wide text-white leading-tight">è²¼åœ–å¤§å¸« V7</h1>
                <p class="text-[10px] text-gray-400">æ»¾è¼ªç¸®æ”¾ â€¢ å³éµå¹³ç§»</p>
            </div>
        </div>

        <div class="flex items-center gap-1 bg-gray-700/50 p-1 rounded-lg border border-gray-600 mx-2">
            <button onclick="undo()" id="btn-undo" disabled class="w-8 h-8 rounded hover:bg-gray-600 disabled:opacity-30 transition"><i class="fas fa-undo"></i></button>
            <button onclick="redo()" id="btn-redo" disabled class="w-8 h-8 rounded hover:bg-gray-600 disabled:opacity-30 transition"><i class="fas fa-redo"></i></button>
        </div>

        <div class="flex items-center gap-2 bg-gray-700/30 px-3 py-1 rounded border border-gray-600">
            <input type="number" id="canvas-w" value="370" class="w-12 dark-input text-center" onchange="resizeCanvasDimension()">
            <span class="text-xs">x</span>
            <input type="number" id="canvas-h" value="320" class="w-12 dark-input text-center" onchange="resizeCanvasDimension()">
            <button onclick="setStandardSize()" class="text-xs bg-gray-600 hover:bg-gray-500 px-2 py-1 rounded">æ¨™æº–</button>
        </div>

        <div class="flex items-center gap-2">
            <label class="cursor-pointer bg-blue-600 hover:bg-blue-500 px-3 py-2 rounded font-bold text-white transition shadow border border-blue-400 flex items-center gap-2 text-sm">
                <i class="fas fa-folder-open"></i> è¼‰åœ–
                <input type="file" id="imgLoader" accept="image/*" class="hidden">
            </label>
            <button onclick="downloadImage()" class="bg-green-600 hover:bg-green-500 text-white px-3 py-2 rounded font-bold shadow transition flex items-center gap-2 border border-green-500 text-sm">
                <i class="fas fa-download"></i> è¼¸å‡º
            </button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden relative">
        
        <div class="w-20 bg-gray-800 border-r border-gray-700 flex flex-col items-center py-4 space-y-3 z-10 overflow-y-auto shrink-0 shadow-xl">
            <button onclick="setMode('select')" id="btn-select" class="tool-btn active w-14 h-14" title="é¸å– (V)">
                <i class="fas fa-mouse-pointer text-lg"></i><span>é¸å–</span>
            </button>
            <button onclick="addText()" class="tool-btn w-14 h-14 text-yellow-400 border-yellow-800/50 hover:bg-yellow-900/20" title="åŠ æ–‡å­— (T)">
                <i class="fas fa-font text-lg"></i><span>æ–‡å­—</span>
            </button>
            <div class="w-10 h-[1px] bg-gray-600 my-1"></div>
            <button onclick="setMode('draw')" id="btn-draw" class="tool-btn w-14 h-14" title="ç•«ç­† (B)">
                <i class="fas fa-pen text-lg"></i><span>æ‰‹ç¹ª</span>
            </button>
            <button onclick="setMode('eraser')" id="btn-eraser" class="tool-btn w-14 h-14 hover:text-red-300" title="æ©¡çš®æ“¦ (E)">
                <i class="fas fa-eraser text-lg"></i><span>æ“¦é™¤</span>
            </button>
            <div class="w-10 h-[1px] bg-gray-600 my-1"></div>
            <button onclick="setMode('pan')" id="btn-pan" class="tool-btn w-14 h-14" title="æŠ“æ‰‹å·¥å…· (H)">
                <i class="fas fa-hand-paper text-lg"></i><span>ç§»å‹•</span>
            </button>
            <button onclick="startCrop()" id="btn-crop" class="tool-btn w-14 h-14" title="è£åˆ‡ (C)">
                <i class="fas fa-crop-alt text-lg"></i><span>è£åˆ‡</span>
            </button>
        </div>

        <div class="flex-1 bg-gray-900 overflow-hidden relative" id="workspace">
            
            <div class="absolute inset-0 flex items-center justify-center">
                <canvas id="c"></canvas>
            </div>

            <div class="absolute top-4 left-4 z-30 pointer-events-none bg-black/40 p-2 rounded text-[10px] text-gray-300 backdrop-blur-sm">
                <p>ğŸ–±ï¸ æ»¾è¼ªï¼šç¸®æ”¾ç•«å¸ƒ</p>
                <p>ğŸ–±ï¸ å³éµæŒ‰ä½ï¼šç§»å‹•ç•«å¸ƒ</p>
                <p>âŒ¨ï¸ ç©ºç™½éµ+å·¦éµï¼šç§»å‹•ç•«å¸ƒ</p>
            </div>

            <div class="absolute bottom-5 right-5 bg-gray-800 p-1.5 rounded-full shadow-xl border border-gray-600 flex items-center gap-1 z-30 opacity-90">
                <button onclick="resetViewport()" class="px-3 py-1 rounded-full hover:bg-gray-700 text-blue-400 text-xs font-bold flex items-center gap-1" title="é‡ç½®è¦–åœ–">
                    <span id="zoom-val">100%</span> <i class="fas fa-compress-arrows-alt"></i>
                </button>
            </div>

            <div id="crop-controls" class="absolute bottom-20 left-1/2 -translate-x-1/2 bg-gray-800 p-3 rounded-xl shadow-2xl border border-gray-500 flex gap-3 hidden z-30 animate-bounce">
                <button onclick="applyCrop()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-1 rounded shadow">ç¢ºèªè£åˆ‡</button>
                <button onclick="cancelCrop()" class="bg-gray-600 hover:bg-gray-500 text-white px-4 py-1 rounded">å–æ¶ˆ</button>
            </div>
        </div>

        <div class="w-80 bg-gray-800 border-l border-gray-700 flex flex-col z-20 shadow-xl shrink-0">
            <div class="p-3 border-b border-gray-700 font-bold text-gray-300 bg-gray-800/50">
                <i class="fas fa-sliders-h mr-2"></i>å±¬æ€§é¢æ¿
            </div>

            <div class="p-4 flex-1 overflow-y-auto space-y-6">
                
                <div id="panel-none" class="text-center text-gray-500 py-10">
                    <i class="fas fa-mouse-pointer text-4xl mb-3 opacity-50"></i>
                    <p class="text-sm">è«‹é¸å–ç‰©ä»¶</p>
                </div>

                <div id="panel-brush" class="hidden space-y-4">
                    <h3 class="text-xs font-bold text-blue-400 uppercase tracking-wider border-b border-gray-700 pb-1">ç­†åˆ·å·¥å…·</h3>
                    <div id="brush-color-wrap">
                        <label class="text-xs text-gray-400 mb-1 block">é¡è‰²</label>
                        <div class="flex gap-2 mb-2">
                             <input type="color" id="draw-color" value="#000000" class="w-8 h-8 rounded cursor-pointer border-0 p-0" onchange="updateBrush()">
                             <button onclick="setBrushColor('#000000')" class="w-8 h-8 bg-black rounded border border-gray-600"></button>
                             <button onclick="setBrushColor('#ffffff')" class="w-8 h-8 bg-white rounded border border-gray-600"></button>
                             <button onclick="setBrushColor('#ef4444')" class="w-8 h-8 bg-red-500 rounded border border-gray-600"></button>
                        </div>
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 flex justify-between mb-1">ç²—ç´° <span id="brush-size-val">5</span></label>
                        <input type="range" id="draw-width" min="1" max="50" value="5" class="w-full h-2 bg-gray-600 rounded-lg appearance-none" oninput="updateBrush()">
                    </div>
                </div>

                <div id="panel-object" class="hidden space-y-6">
                    <div class="grid grid-cols-2 gap-2">
                        <button id="btn-group" onclick="groupObjects()" class="hidden col-span-2 bg-indigo-600 hover:bg-indigo-500 text-white py-2 rounded text-sm font-bold shadow-lg transition"><i class="fas fa-object-group mr-2"></i>ç¾¤çµ„</button>
                        <button id="btn-ungroup" onclick="ungroupObjects()" class="hidden col-span-2 bg-gray-600 hover:bg-gray-500 text-white py-2 rounded text-sm font-bold transition"><i class="fas fa-object-ungroup mr-2"></i>è§£ç¾¤çµ„</button>
                        <button onclick="toggleLock()" id="btn-lock" class="text-xs bg-gray-700 hover:bg-gray-600 py-2 rounded text-gray-300 border border-gray-600"><i class="fas fa-lock-open mr-1"></i>é–å®š</button>
                        <button onclick="duplicateObject()" class="text-xs bg-gray-700 hover:bg-gray-600 py-2 rounded text-gray-300 border border-gray-600"><i class="fas fa-clone mr-1"></i>è¤‡è£½</button>
                    </div>

                    <div class="space-y-2 bg-gray-700/30 p-2 rounded border border-gray-600">
                        <label class="text-xs text-gray-300 font-bold flex justify-between">
                            <span><i class="fas fa-sync-alt mr-1"></i>è§’åº¦</span>
                            <span id="rotation-val" class="text-blue-400">0Â°</span>
                        </label>
                        <div class="flex items-center gap-2">
                            <button onclick="rotateObject(-90)" class="text-xs bg-gray-600 px-2 py-1 rounded hover:bg-gray-500 text-white">-90</button>
                            <input type="range" id="angle-control" min="-180" max="180" value="0" class="flex-1 h-2 bg-gray-600 rounded-lg appearance-none" oninput="setRotation(this.value)">
                            <button onclick="rotateObject(90)" class="text-xs bg-gray-600 px-2 py-1 rounded hover:bg-gray-500 text-white">+90</button>
                        </div>
                    </div>

                    <div class="space-y-2">
                        <h3 class="text-xs font-bold text-green-400 uppercase tracking-wider border-b border-gray-700 pb-1">é¡è‰²</h3>
                        <input type="color" id="obj-color" class="w-full h-8 rounded cursor-pointer border border-gray-600 bg-transparent p-0" onchange="updateObject()">
                    </div>

                    <div id="text-controls" class="hidden space-y-5 pt-2 border-t border-gray-700">
                        <div class="space-y-2">
                            <label class="text-xs text-gray-300 font-bold block mb-1">å­—å‹</label>
                            <select id="font-family" class="w-full bg-gray-800 border border-gray-600 rounded px-2 py-1 text-sm mb-2" onchange="handleFontChange()">
                                <optgroup label="â­ æˆ‘çš„è¨˜æ†¶" id="saved-fonts-group"></optgroup>
                                <optgroup label="ç³»çµ±å­—å‹">
                                    <option value="Noto Sans TC">æ€æºé»‘é«”</option>
                                    <option value="Mochiy Pop One">å¯æ„›åœ“é«”</option>
                                    <option value="Microsoft JhengHei">å¾®è»Ÿæ­£é»‘é«”</option>
                                    <option value="PMingLiU">æ–°ç´°æ˜é«”</option>
                                    <option value="Arial">Arial</option>
                                </optgroup>
                                <option value="custom_input">â• æ–°å¢...</option>
                            </select>
                            <div id="custom-font-area" class="hidden flex gap-2">
                                <input type="text" id="custom-font-input" placeholder="å­—å‹åç¨±" class="dark-input flex-1">
                                <button onclick="saveCustomFont()" class="bg-blue-600 hover:bg-blue-500 text-white px-2 rounded text-xs"><i class="fas fa-save"></i></button>
                            </div>
                        </div>
                        <div class="space-y-2 bg-gray-700/30 p-2 rounded border border-gray-600">
                            <label class="text-xs text-white font-bold flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-white"></span> ç™½æé‚Š
                            </label>
                            <div class="flex gap-2 items-center">
                                <input type="color" id="text-stroke-color" value="#ffffff" class="w-8 h-8 rounded border border-gray-500 cursor-pointer p-0" onchange="updateObject()">
                                <input type="range" id="text-stroke-width" min="0" max="20" value="8" step="0.5" class="flex-1 h-2 bg-gray-600 rounded-lg appearance-none" oninput="updateObject()">
                            </div>
                        </div>
                    </div>

                    <button onclick="deleteActiveObject()" class="w-full bg-red-900/40 hover:bg-red-900/60 text-red-300 py-2 rounded border border-red-800/50 transition text-sm">
                        <i class="fas fa-trash-alt mr-2"></i>åˆªé™¤ (Del)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Fabric Setup ---
        fabric.Object.prototype.set({
            transparentCorners: false, cornerColor: '#3b82f6', cornerStyle: 'circle', borderColor: '#3b82f6', cornerSize: 10, padding: 5, borderScaleFactor: 1, rotatingPointOffset: 20
        });

        // V7 è®Šæ›´ï¼šè®“ Canvas åˆå§‹ä½”æ»¿æ•´å€‹å®¹å™¨ï¼Œä½†æˆ‘å€‘ç•«ä¸€å€‹æ¡†ä¾†æ¨™ç¤ºã€Œè²¼åœ–ç¯„åœã€
        const canvas = new fabric.Canvas('c', {
            // å¯¬é«˜æœƒç”± resizeCanvasToContainer å‹•æ…‹æ±ºå®š
            backgroundColor: '#111827', // èƒŒæ™¯æ·±è‰²
            preserveObjectStacking: true
        });

        // è²¼åœ–å·¥ä½œå€ (Artboard) è®Šæ•¸
        let artboardW = 370;
        let artboardH = 320;
        let artboardRect = null; // ç™½è‰²å·¥ä½œå€çŸ©å½¢
        
        // ç‹€æ…‹è®Šæ•¸
        let currentMode = 'select';
        let cropRect = null;
        let isDragging = false; // å¹³ç§»ç‹€æ…‹
        let lastPosX, lastPosY; // å¹³ç§»åº§æ¨™
        let undoStack = [], redoStack = [], isRedoing = false;
        let myFonts = JSON.parse(localStorage.getItem('sticker_my_fonts')) || [];

        // --- åˆå§‹åŒ– ---
        window.onload = function() {
            renderFontOptions();
            resizeCanvasToContainer();
            createArtboard(); // å»ºç«‹ç™½è‰²å·¥ä½œå€
            window.addEventListener('resize', resizeCanvasToContainer);
        };

        // --- V7 æ ¸å¿ƒï¼šç•«å¸ƒç³»çµ±é‡æ§‹ ---
        
        // 1. è®“ Fabric Canvas æ°¸é å¡«æ»¿è¦–çª—ï¼Œä½†æˆ‘å€‘åªåœ¨ä¸­é–“ç•«ç™½è‰²å€åŸŸ
        function resizeCanvasToContainer() {
            const container = document.getElementById('workspace');
            canvas.setWidth(container.offsetWidth);
            canvas.setHeight(container.offsetHeight);
            if(artboardRect) centerArtboard(); // é‡æ–°ç½®ä¸­å·¥ä½œå€
        }

        // 2. å»ºç«‹ç™½è‰²è²¼åœ–å·¥ä½œå€ (Artboard)
        function createArtboard() {
            // æ¸…é™¤èˆŠçš„
            if(artboardRect) canvas.remove(artboardRect);
            
            // å»ºç«‹ä¸€å€‹ä¸å¯é¸å–çš„ç™½è‰²çŸ©å½¢ä½œç‚ºåº•
            artboardRect = new fabric.Rect({
                width: artboardW,
                height: artboardH,
                fill: 'white',
                selectable: false,
                evented: false, // è®“æ»‘é¼ äº‹ä»¶ç©¿é€å®ƒï¼Œé€™æ¨£æŒ‰å³éµå¹³ç§»æ‰é †
                hoverCursor: 'default',
                shadow: new fabric.Shadow({ color: 'rgba(0,0,0,0.5)', blur: 20 })
            });
            
            // ç¹ªè£½æ£‹ç›¤æ ¼ç´‹ç† (Optional, ç‚ºäº†ç°¡å–®å…ˆç”¨ç™½åº•ï¼Œè‹¥è¦é€æ˜æ„Ÿå¯åŠ )
            // é€™è£¡ç°¡å–®ç”¨ç™½è‰²ï¼Œå› ç‚º Line è²¼åœ–é è¨­æ˜¯é€æ˜ï¼Œä½†ç·¨è¼¯æ™‚çœ‹ç™½åº•æ¯”è¼ƒæ¸…æ¥š
            
            canvas.add(artboardRect);
            artboardRect.sendToBack();
            centerArtboard();
        }

        function centerArtboard() {
            if(!artboardRect) return;
            // å°‡è¦–åœ–é‡ç½®åˆ°ä¸­å¿ƒ
            const vpt = canvas.viewportTransform;
            vpt[0] = 1; vpt[3] = 1; // scale reset
            vpt[4] = (canvas.width - artboardW) / 2; // pan x
            vpt[5] = (canvas.height - artboardH) / 2; // pan y
            canvas.requestRenderAll();
            updateZoomDisplay();
        }
        
        // ä½¿ç”¨è€…ä¿®æ”¹å°ºå¯¸æ™‚
        function resizeCanvasDimension() {
            artboardW = parseInt(document.getElementById('canvas-w').value);
            artboardH = parseInt(document.getElementById('canvas-h').value);
            // æ›´æ–°ç™½è‰²å€åŸŸ
            artboardRect.set({ width: artboardW, height: artboardH });
            centerArtboard();
        }
        function setStandardSize() {
            document.getElementById('canvas-w').value = 370;
            document.getElementById('canvas-h').value = 320;
            resizeCanvasDimension();
        }


        // --- V7 æ ¸å¿ƒï¼šå°èˆªç³»çµ± (Zoom & Pan) ---

        // 1. æ»‘é¼ æ»¾è¼ªç¸®æ”¾ (Wheel Zoom)
        canvas.on('mouse:wheel', function(opt) {
            var delta = opt.e.deltaY;
            var zoom = canvas.getZoom();
            
            // è¨ˆç®—æ–°ç¸®æ”¾å€¼
            zoom *= 0.999 ** delta;
            if (zoom > 10) zoom = 10;
            if (zoom < 0.1) zoom = 0.1;

            // ä»¥æ»‘é¼ ä½ç½®ç‚ºä¸­å¿ƒç¸®æ”¾
            canvas.zoomToPoint({ x: opt.e.offsetX, y: opt.e.offsetY }, zoom);
            
            opt.e.preventDefault();
            opt.e.stopPropagation();
            updateZoomDisplay();
        });

        // 2. å¹³ç§» (Panning) é‚è¼¯
        canvas.on('mouse:down', function(opt) {
            var evt = opt.e;
            
            // è§¸ç™¼å¹³ç§»çš„æ¢ä»¶ï¼š
            // A. æŒ‰ä¸‹å³éµ (button 2)
            // B. æŒ‰ä½ Alt éµ + å·¦éµ
            // C. æŒ‰ä½ ç©ºç™½éµ + å·¦éµ (é€šå¸¸ç€è¦½å™¨æœƒè™•ç†ç©ºç™½éµï¼Œæ‰€ä»¥æˆ‘å€‘åœ¨ keydown è™•ç† cursor)
            // D. åœ¨ã€ŒæŠ“æ‰‹æ¨¡å¼ (pan)ã€ä¸‹æŒ‰å·¦éµ
            
            // æ³¨æ„ï¼šFabric çš„ opt.e.button åœ¨å³éµæ™‚æ˜¯ 2
            const isRightClick = evt.button === 2;
            const isAltClick = evt.altKey;
            const isSpaceClick = spacePressed; 
            const isPanMode = currentMode === 'pan';

            if (isRightClick || isAltClick || isSpaceClick || isPanMode) {
                this.isDragging = true;
                this.selection = false; // æš«åœé¸å–æ¡†
                this.lastPosX = evt.clientX;
                this.lastPosY = evt.clientY;
                canvas.defaultCursor = 'grabbing';
            }
        });

        canvas.on('mouse:move', function(opt) {
            if (this.isDragging) {
                var e = opt.e;
                var vpt = this.viewportTransform;
                vpt[4] += e.clientX - this.lastPosX; // Xè»¸ç§»å‹•
                vpt[5] += e.clientY - this.lastPosY; // Yè»¸ç§»å‹•
                this.requestRenderAll();
                this.lastPosX = e.clientX;
                this.lastPosY = e.clientY;
            }
        });

        canvas.on('mouse:up', function(opt) {
            // çµæŸå¹³ç§»
            if(this.isDragging) {
                this.setViewportTransform(this.viewportTransform); // ç¢ºèªè®Šæ›´
                this.isDragging = false;
                this.selection = true; // æ¢å¾©é¸å–
                canvas.defaultCursor = currentMode === 'pan' ? 'grab' : 'default';
            }
        });

        // 3. ç©ºç™½éµåµæ¸¬
        let spacePressed = false;
        window.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && !spacePressed) {
                // å¦‚æœæ­£åœ¨æ‰“å­—ï¼Œä¸è¦è§¸ç™¼
                if(document.activeElement.tagName === 'INPUT') return;
                spacePressed = true;
                canvas.defaultCursor = 'grab';
            }
            // å¿«æ·éµ
            if (e.key === 'v' || e.key === 'V') setMode('select');
            if (e.key === 'b' || e.key === 'B') setMode('draw');
            if (e.key === 'e' || e.key === 'E') setMode('eraser');
            if (e.key === 'h' || e.key === 'H') setMode('pan');
            if ((e.key === 'Delete' || e.key === 'Backspace')) deleteActiveObject();
            if (e.ctrlKey && e.key === 'z') { e.preventDefault(); undo(); }
            if (e.ctrlKey && e.key === 'y') { e.preventDefault(); redo(); }
        });
        window.addEventListener('keyup', (e) => {
            if (e.code === 'Space') {
                spacePressed = false;
                if(currentMode !== 'pan') canvas.defaultCursor = 'default';
            }
        });

        // é‡ç½®è¦–åœ–
        function resetViewport() {
            centerArtboard();
        }
        function updateZoomDisplay() {
            document.getElementById('zoom-val').innerText = Math.round(canvas.getZoom() * 100) + '%';
        }


        // --- åŸæœ‰åŠŸèƒ½ (é©é… V7) ---

        // è¼‰å…¥åœ–ç‰‡ (éœ€èª¿æ•´ä½ç½®åˆ° Artboard ä¸­å¿ƒ)
        function loadToCanvas(dataURL) {
            fabric.Image.fromURL(dataURL, function(img) {
                // ç¸®æ”¾åœ–ç‰‡ä»¥é©æ‡‰ Artboardï¼Œè€Œä¸æ˜¯ Canvas
                if (img.width > artboardW || img.height > artboardH) {
                    const scale = Math.min(artboardW / img.width, artboardH / img.height) * 0.9;
                    img.scale(scale);
                }
                // è¨ˆç®— Artboard çš„ä¸­å¿ƒé» (å› ç‚º Artboard å·¦ä¸Šè§’é è¨­åœ¨ canvas ä¸­å¿ƒåç§»è™•ï¼Œé€™è£¡ç°¡åŒ–è™•ç†)
                // å…¶å¯¦åªè¦åˆ©ç”¨ viewport åº§æ¨™è½‰æ›ï¼Œæˆ–è€…ç°¡å–®åœ°æ”¾åœ¨ Artboard çŸ©å½¢çš„ä¸­å¿ƒ
                
                // Artboard æ˜¯å¾ (0,0) é–‹å§‹ç•«çš„çŸ©å½¢ç‰©ä»¶ (åœ¨ Fabric ä¸–ç•Œåº§æ¨™ä¸­)
                // æˆ‘å€‘çš„ centerArtboard æŠŠ (0,0) æ¬åˆ°äº†ç•«é¢ä¸­å¤®
                // æ‰€ä»¥æˆ‘å€‘æŠŠåœ–ç‰‡æ”¾åœ¨ (artboardW/2, artboardH/2) å³å¯
                img.set({
                    left: artboardW / 2,
                    top: artboardH / 2,
                    originX: 'center',
                    originY: 'center'
                });

                canvas.add(img);
                // ç¢ºä¿åœ¨ Artboard ä¹‹ä¸Šï¼Œå…¶ä»–ç‰©ä»¶ä¹‹ä¸‹
                canvas.moveTo(img, 1); 
                canvas.setActiveObject(img);
                saveState();
            });
            document.getElementById('panel-none').style.display = 'none'; 
        }

        // ä¸‹è¼‰ (é—œéµï¼šéœ€è£åˆ‡å‡º Artboard ç¯„åœ)
        function downloadImage() {
            canvas.discardActiveObject();
            
            // æš«å­˜ç•¶å‰çš„è¦–åœ–ç‹€æ…‹
            const originalVpt = canvas.viewportTransform.slice();
            
            // 1. é‡ç½®è¦–åœ–åˆ°åŸé» (scale:1, x:0, y:0) ä»¥ä¾¿è£åˆ‡
            canvas.viewportTransform = [1, 0, 0, 1, 0, 0];
            
            // 2. éš±è— Artboard ç™½è‰²åº•åœ– (å¦‚æœè¦é€æ˜åº•)
            // å¦‚æœæ‚¨æƒ³è¦ä¸‹è¼‰ç™½åº•ï¼Œå°±è¨»è§£æ‰é€™è¡Œ
            artboardRect.visible = false; 
            
            canvas.renderAll(); // æ¸²æŸ“ä¸€ä¸‹ä»¥æ‡‰ç”¨è®Šæ›´

            setTimeout(() => {
                const link = document.createElement('a');
                link.download = `sticker-${Date.now()}.png`;
                
                // 3. åªè¼¸å‡º Artboard ç¯„åœ (0,0, width, height)
                link.href = canvas.toDataURL({
                    format: 'png',
                    quality: 1,
                    multiplier: 1,
                    left: 0,
                    top: 0,
                    width: artboardW,
                    height: artboardH
                });
                link.click();

                // 4. æ¢å¾©åŸç‹€
                canvas.viewportTransform = originalVpt;
                artboardRect.visible = true;
                canvas.requestRenderAll();
            }, 50);
        }

        // --- å…¶ä»–å·¥å…·å‡½å¼ (ä¿æŒä¸è®Š) ---
        // (çœç•¥é‡è¤‡çš„ä»£ç¢¼ä»¥ç¯€çœç¯‡å¹…ï¼Œé€™éƒ¨åˆ†é‚è¼¯èˆ‡ V6 å®Œå…¨ç›¸åŒï¼šç¾¤çµ„ã€æ—‹è½‰ã€å­—å‹ã€ç•«ç­†ç­‰)
        // ç‚ºäº†ç¢ºä¿å®Œæ•´æ€§ï¼Œé€™è£¡å¿«é€Ÿåˆ—å‡ºé—œéµå‡½å¼åï¼Œè«‹ç¢ºä¿è¤‡è£½æ™‚åŒ…å«å®ƒå€‘ï¼š
        
        function setMode(mode) {
            if(currentMode === 'crop' && mode !== 'crop') cancelCrop();
            currentMode = mode;
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            const map = { 'select': 'btn-select', 'draw': 'btn-draw', 'eraser': 'btn-eraser', 'crop': 'btn-crop', 'pan': 'btn-pan' };
            if(map[mode]) document.getElementById(map[mode]).classList.add('active');

            if (mode === 'draw' || mode === 'eraser') {
                canvas.isDrawingMode = true; canvas.discardActiveObject(); updateBrush();
            } else if (mode === 'pan') {
                canvas.isDrawingMode = false; canvas.defaultCursor = 'grab'; canvas.discardActiveObject();
            } else {
                canvas.isDrawingMode = false; canvas.defaultCursor = 'default';
            }
            canvas.requestRenderAll(); updatePanel();
        }

        // å­—å‹ã€ç•«ç­†ã€ç¾¤çµ„ã€æ­·å²ç´€éŒ„ç­‰å‡½å¼èˆ‡ V6 ç›¸åŒï¼Œç›´æ¥æ²¿ç”¨...
        function renderFontOptions() { /* åŒ V6 */ const group = document.getElementById('saved-fonts-group'); group.innerHTML = ''; if (myFonts.length === 0) { const opt = document.createElement('option'); opt.text = "(å°šç„¡ç´€éŒ„)"; opt.disabled = true; group.appendChild(opt); } else { myFonts.forEach(fontName => { const opt = document.createElement('option'); opt.value = fontName; opt.text = fontName; group.appendChild(opt); }); } }
        function handleFontChange() { /* åŒ V6 */ const select = document.getElementById('font-family'); const customArea = document.getElementById('custom-font-area'); if (select.value === 'custom_input') { customArea.classList.remove('hidden'); document.getElementById('custom-font-input').focus(); } else { customArea.classList.add('hidden'); updateObject(); } }
        function saveCustomFont() { /* åŒ V6 */ const name = document.getElementById('custom-font-input').value.trim(); if (!name) return; if (!myFonts.includes(name)) { myFonts.unshift(name); localStorage.setItem('sticker_my_fonts', JSON.stringify(myFonts)); renderFontOptions(); document.getElementById('font-family').value = name; document.getElementById('custom-font-area').classList.add('hidden'); updateObject(); alert(`å·²è¨˜æ†¶å­—å‹ï¼šã€Œ${name}ã€`); } else { document.getElementById('font-family').value = name; updateObject(); } }
        function addText() { setMode('select'); const text = new fabric.IText('è¼¸å…¥æ–‡å­—', { left: artboardW/2, top: artboardH/2, originX: 'center', originY: 'center', fontFamily: 'Noto Sans TC', fontSize: 60, fill: '#000000', stroke: '#ffffff', strokeWidth: 8, paintFirst: 'stroke', fontWeight: '900' }); canvas.add(text); canvas.setActiveObject(text); }
        function updateObject() { const obj = canvas.getActiveObject(); if (!obj) return; obj.set('fill', document.getElementById('obj-color').value); if (obj.type === 'i-text') { let fontVal = document.getElementById('font-family').value; if (fontVal === 'custom_input') fontVal = document.getElementById('custom-font-input').value || 'sans-serif'; obj.set({ fontFamily: fontVal, stroke: document.getElementById('text-stroke-color').value, strokeWidth: parseFloat(document.getElementById('text-stroke-width').value) }); } canvas.requestRenderAll(); }
        function updatePanelFromSelection() { updatePanel(); const obj = canvas.getActiveObject(); if (!obj) return; const angle = parseInt(obj.angle % 360); document.getElementById('angle-control').value = angle; document.getElementById('rotation-val').innerText = angle + "Â°"; const btnLock = document.getElementById('btn-lock'); if(obj.lockMovementX) { btnLock.innerHTML = '<i class="fas fa-lock mr-1"></i>å·²é–å®š'; btnLock.classList.add('bg-red-900', 'text-red-200'); } else { btnLock.innerHTML = '<i class="fas fa-lock-open mr-1"></i>é–å®š'; btnLock.classList.remove('bg-red-900', 'text-red-200'); } if (obj.type === 'activeSelection') { document.getElementById('btn-group').classList.remove('hidden'); } else { document.getElementById('btn-group').classList.add('hidden'); } if (obj.type === 'group') { document.getElementById('btn-ungroup').classList.remove('hidden'); } else { document.getElementById('btn-ungroup').classList.add('hidden'); } if(typeof obj.fill === 'string') document.getElementById('obj-color').value = obj.fill; if (obj.type === 'i-text') { document.getElementById('text-stroke-color').value = obj.stroke || '#ffffff'; document.getElementById('text-stroke-width').value = obj.strokeWidth || 0; } }
        function updatePanel() { const obj = canvas.getActiveObject(); document.getElementById('panel-none').classList.toggle('hidden', !!obj || canvas.isDrawingMode); document.getElementById('panel-brush').classList.toggle('hidden', !canvas.isDrawingMode); document.getElementById('panel-object').classList.toggle('hidden', !obj); const isText = obj && obj.type === 'i-text'; document.getElementById('text-controls').classList.toggle('hidden', !isText); }
        function groupObjects() { if (!canvas.getActiveObject()) return; if (canvas.getActiveObject().type !== 'activeSelection') return; canvas.getActiveObject().toGroup(); canvas.requestRenderAll(); updatePanel(); saveState(); }
        function ungroupObjects() { if (!canvas.getActiveObject()) return; if (canvas.getActiveObject().type !== 'group') return; canvas.getActiveObject().toActiveSelection(); canvas.requestRenderAll(); updatePanel(); saveState(); }
        function setRotation(angle) { const obj = canvas.getActiveObject(); if(!obj) return; obj.set('angle', parseInt(angle)); document.getElementById('rotation-val').innerText = parseInt(angle) + "Â°"; canvas.requestRenderAll(); }
        document.getElementById('angle-control').addEventListener('change', saveState);
        function rotateObject(deg) { const obj = canvas.getActiveObject(); if(!obj) return; let currentAngle = obj.angle; obj.rotate(currentAngle + deg); canvas.requestRenderAll(); updatePanelFromSelection(); saveState(); }
        function toggleLock() { const obj = canvas.getActiveObject(); if(!obj) return; const isLocked = !obj.lockMovementX; obj.set({ lockMovementX: isLocked, lockMovementY: isLocked, lockRotation: isLocked, lockScalingX: isLocked, lockScalingY: isLocked }); const btn = document.getElementById('btn-lock'); if(isLocked) { btn.innerHTML = '<i class="fas fa-lock mr-1"></i>å·²é–å®š'; btn.classList.add('bg-red-900', 'text-red-200'); canvas.discardActiveObject(); canvas.requestRenderAll(); } else { btn.innerHTML = '<i class="fas fa-lock-open mr-1"></i>é–å®š'; btn.classList.remove('bg-red-900', 'text-red-200'); } saveState(); }
        function duplicateObject() { const obj = canvas.getActiveObject(); if(!obj) return; obj.clone(function(cloned) { canvas.discardActiveObject(); cloned.set({ left: cloned.left + 20, top: cloned.top + 20, evented: true }); if (cloned.type === 'activeSelection') { cloned.canvas = canvas; cloned.forEachObject(function(obj) { canvas.add(obj); }); cloned.setCoords(); } else { canvas.add(cloned); } canvas.setActiveObject(cloned); canvas.requestRenderAll(); saveState(); }); }
        function setBrushColor(c) { document.getElementById('draw-color').value = c; updateBrush(); }
        function updateBrush() { if (!canvas.freeDrawingBrush) return; const size = parseInt(document.getElementById('draw-width').value); document.getElementById('brush-size-val').innerText = size; canvas.freeDrawingBrush.width = size; canvas.freeDrawingBrush.strokeLineCap = 'round'; if (currentMode === 'eraser') { canvas.freeDrawingBrush.color = 'rgba(0,0,0,1)'; canvas.defaultCursor = 'crosshair'; document.getElementById('brush-color-wrap').classList.add('opacity-30', 'pointer-events-none'); } else { canvas.freeDrawingBrush.color = document.getElementById('draw-color').value; canvas.defaultCursor = 'crosshair'; document.getElementById('brush-color-wrap').classList.remove('opacity-30', 'pointer-events-none'); } }
        function startCrop() { setMode('crop'); document.getElementById('crop-controls').classList.remove('hidden'); resetViewport(); cropRect = new fabric.Rect({ fill: 'rgba(0,0,0,0.3)', stroke: '#3b82f6', strokeWidth: 2, strokeDashArray: [10, 5], left: 0, top: 0, width: artboardW, height: artboardH, selectable: true, hasRotatingPoint: false, lockRotation: true, cornerColor: 'white', cornerStrokeColor: '#3b82f6', transparentCorners: false }); canvas.add(cropRect); canvas.setActiveObject(cropRect); }
        function cancelCrop() { if (cropRect) canvas.remove(cropRect); document.getElementById('crop-controls').classList.add('hidden'); setMode('select'); }
        function applyCrop() { if (!cropRect) return; const { left, top, width, height } = cropRect.getBoundingRect(); cropRect.visible = false; const url = canvas.toDataURL({ left, top, width, height, format: 'png', multiplier: 1 }); canvas.clear(); createArtboard(); fabric.Image.fromURL(url, (img) => { img.set({left: artboardW/2, top: artboardH/2, originX:'center', originY:'center'}); canvas.add(img); img.set({ selectable: true }); saveState(); cancelCrop(); }); }
        function saveState() { if (isRedoing) return; redoStack = []; if(undoStack.length > 20) undoStack.shift(); undoStack.push(canvas.toJSON()); document.getElementById('btn-undo').disabled = undoStack.length === 0; document.getElementById('btn-redo').disabled = redoStack.length === 0; }
        function undo() { if (undoStack.length > 0) { isRedoing = true; redoStack.push(canvas.toJSON()); const state = undoStack.pop(); canvas.loadFromJSON(state, () => { canvas.renderAll(); isRedoing = false; updatePanelFromSelection(); }); } document.getElementById('btn-undo').disabled = undoStack.length === 0; document.getElementById('btn-redo').disabled = redoStack.length === 0; }
        function redo() { if (redoStack.length > 0) { isRedoing = true; undoStack.push(canvas.toJSON()); const state = redoStack.pop(); canvas.loadFromJSON(state, () => { canvas.renderAll(); isRedoing = false; updatePanelFromSelection(); }); } document.getElementById('btn-undo').disabled = undoStack.length === 0; document.getElementById('btn-redo').disabled = redoStack.length === 0; }

        document.getElementById('imgLoader').addEventListener('change', loadFile);
    </script>
</body>
</html>
