<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINE Sticker Master V5 - 智慧字型版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;900&family=Mochiy+Pop+One&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; user-select: none; }
        .canvas-bg { 
            background-image: linear-gradient(45deg, #e5e5e5 25%, transparent 25%), linear-gradient(-45deg, #e5e5e5 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #e5e5e5 75%), linear-gradient(-45deg, transparent 75%, #e5e5e5 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            background-color: #ffffff; 
        }
        .tool-btn { @apply p-2 rounded-lg border border-gray-600 hover:bg-gray-700 transition flex flex-col items-center justify-center text-xs gap-1 text-gray-300; }
        .tool-btn.active { @apply bg-blue-600 text-white border-blue-500 shadow-lg ring-2 ring-blue-400 transform scale-105; }
        input[type="range"] { @apply accent-blue-500 cursor-pointer; }
        /* 讓輸入框好看一點 */
        .dark-input { @apply bg-gray-900 border border-gray-600 rounded px-2 py-1 text-sm text-white focus:ring-2 focus:ring-blue-500 outline-none; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 h-screen flex flex-col overflow-hidden">

    <header class="h-16 bg-gray-800 border-b border-gray-700 flex items-center justify-between px-4 shadow-lg z-20 shrink-0">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center text-xl font-bold text-white shadow-lg">L</div>
            <div>
                <h1 class="font-bold text-lg tracking-wide text-white leading-tight">貼圖大師 V5</h1>
                <p class="text-[10px] text-gray-400">底圖自由縮放 • 字型記憶</p>
            </div>
        </div>

        <div class="flex items-center gap-1 bg-gray-700/50 p-1 rounded-lg border border-gray-600 mx-2">
            <button onclick="undo()" id="btn-undo" disabled class="w-8 h-8 rounded hover:bg-gray-600 disabled:opacity-30 transition"><i class="fas fa-undo"></i></button>
            <button onclick="redo()" id="btn-redo" disabled class="w-8 h-8 rounded hover:bg-gray-600 disabled:opacity-30 transition"><i class="fas fa-redo"></i></button>
        </div>

        <div class="flex items-center gap-2 bg-gray-700/30 px-3 py-1 rounded border border-gray-600">
            <span class="text-xs text-gray-400">畫布:</span>
            <input type="number" id="canvas-w" value="370" class="w-14 dark-input text-center" onchange="resizeCanvasDimension()">
            <span class="text-xs">x</span>
            <input type="number" id="canvas-h" value="320" class="w-14 dark-input text-center" onchange="resizeCanvasDimension()">
            <button onclick="setStandardSize()" class="text-xs bg-gray-600 hover:bg-gray-500 px-2 py-1 rounded" title="重設為貼圖標準大小">標準</button>
        </div>

        <div class="flex items-center gap-2">
            <label class="cursor-pointer bg-blue-600 hover:bg-blue-500 px-3 py-2 rounded font-bold text-white transition shadow border border-blue-400 flex items-center gap-2 text-sm">
                <i class="fas fa-image"></i> 載入素材
                <input type="file" id="imgLoader" accept="image/*" class="hidden">
            </label>
            <button onclick="downloadImage()" class="bg-green-600 hover:bg-green-500 text-white px-3 py-2 rounded font-bold shadow transition flex items-center gap-2 border border-green-500 text-sm">
                <i class="fas fa-download"></i> 輸出
            </button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden relative">
        
        <div class="w-20 bg-gray-800 border-r border-gray-700 flex flex-col items-center py-4 space-y-3 z-10 overflow-y-auto shrink-0 shadow-xl">
            <button onclick="setMode('select')" id="btn-select" class="tool-btn active w-14 h-14" title="選取 (V)">
                <i class="fas fa-mouse-pointer text-lg"></i><span>選取</span>
            </button>
            <button onclick="addText()" class="tool-btn w-14 h-14 text-yellow-400 border-yellow-800/50 hover:bg-yellow-900/20" title="加文字 (T)">
                <i class="fas fa-font text-lg"></i><span>文字</span>
            </button>
            <div class="w-10 h-[1px] bg-gray-600 my-1"></div>
            <button onclick="setMode('draw')" id="btn-draw" class="tool-btn w-14 h-14" title="畫筆 (B)">
                <i class="fas fa-pen text-lg"></i><span>手繪</span>
            </button>
            <button onclick="setMode('eraser')" id="btn-eraser" class="tool-btn w-14 h-14 hover:text-red-300" title="橡皮擦 (E)">
                <i class="fas fa-eraser text-lg"></i><span>擦除</span>
            </button>
            <div class="w-10 h-[1px] bg-gray-600 my-1"></div>
            <button onclick="startCrop()" id="btn-crop" class="tool-btn w-14 h-14" title="裁切 (C)">
                <i class="fas fa-crop-alt text-lg"></i><span>裁切</span>
            </button>
        </div>

        <div class="flex-1 bg-gray-900/80 relative overflow-hidden flex items-center justify-center" id="workspace">
            
            <div class="canvas-bg shadow-2xl border-4 border-gray-700 relative z-10 transition-all duration-300" id="canvas-container">
                <canvas id="c"></canvas>
            </div>

            <div class="absolute bottom-5 right-5 bg-gray-800 p-1.5 rounded-full shadow-xl border border-gray-600 flex items-center gap-1 z-30 opacity-90 hover:opacity-100 transition">
                <button onclick="zoomView(0.9)" class="w-8 h-8 rounded-full hover:bg-gray-700 text-gray-300"><i class="fas fa-minus"></i></button>
                <span id="zoom-val" class="text-xs font-mono w-10 text-center text-gray-300">100%</span>
                <button onclick="zoomView(1.1)" class="w-8 h-8 rounded-full hover:bg-gray-700 text-gray-300"><i class="fas fa-plus"></i></button>
                <button onclick="resetViewZoom()" class="w-8 h-8 rounded-full hover:bg-gray-700 text-blue-400 ml-1" title="重置視圖"><i class="fas fa-compress"></i></button>
            </div>

            <div id="crop-controls" class="absolute bottom-20 bg-gray-800 p-3 rounded-xl shadow-2xl border border-gray-500 flex gap-3 hidden z-30 animate-bounce">
                <button onclick="applyCrop()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-1 rounded shadow">確認裁切</button>
                <button onclick="cancelCrop()" class="bg-gray-600 hover:bg-gray-500 text-white px-4 py-1 rounded">取消</button>
            </div>
        </div>

        <div class="w-80 bg-gray-800 border-l border-gray-700 flex flex-col z-20 shadow-xl shrink-0">
            <div class="p-3 border-b border-gray-700 font-bold text-gray-300 bg-gray-800/50">
                <i class="fas fa-sliders-h mr-2"></i>屬性面板
            </div>

            <div class="p-4 flex-1 overflow-y-auto space-y-6">
                
                <div id="panel-none" class="text-center text-gray-500 py-10">
                    <i class="fas fa-mouse-pointer text-4xl mb-3 opacity-50"></i>
                    <p class="text-sm">點選物件以編輯</p>
                    <p class="text-xs mt-2 text-gray-600">小撇步：按住 Alt 拖曳可平移畫面</p>
                </div>

                <div id="panel-brush" class="hidden space-y-4">
                    <h3 class="text-xs font-bold text-blue-400 uppercase tracking-wider border-b border-gray-700 pb-1">筆刷工具</h3>
                    <div id="brush-color-wrap">
                        <label class="text-xs text-gray-400 mb-1 block">顏色</label>
                        <div class="flex gap-2 mb-2">
                             <input type="color" id="draw-color" value="#000000" class="w-8 h-8 rounded cursor-pointer border-0 p-0" onchange="updateBrush()">
                             <div class="flex gap-1">
                                 <button onclick="setBrushColor('#000000')" class="w-8 h-8 bg-black rounded border border-gray-600"></button>
                                 <button onclick="setBrushColor('#ffffff')" class="w-8 h-8 bg-white rounded border border-gray-600"></button>
                                 <button onclick="setBrushColor('#ef4444')" class="w-8 h-8 bg-red-500 rounded border border-gray-600"></button>
                                 <button onclick="setBrushColor('#3b82f6')" class="w-8 h-8 bg-blue-500 rounded border border-gray-600"></button>
                             </div>
                        </div>
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 flex justify-between mb-1">筆畫粗細 <span id="brush-size-val">5</span></label>
                        <input type="range" id="draw-width" min="1" max="50" value="5" class="w-full h-2 bg-gray-600 rounded-lg appearance-none" oninput="updateBrush()">
                    </div>
                </div>

                <div id="panel-object" class="hidden space-y-6">
                    
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="bringToFront()" class="text-xs bg-gray-700 hover:bg-gray-600 py-2 rounded text-gray-300"><i class="fas fa-arrow-up mr-1"></i>移至最上層</button>
                        <button onclick="sendToBack()" class="text-xs bg-gray-700 hover:bg-gray-600 py-2 rounded text-gray-300"><i class="fas fa-arrow-down mr-1"></i>移至最下層</button>
                    </div>

                    <div class="space-y-2">
                        <h3 class="text-xs font-bold text-green-400 uppercase tracking-wider border-b border-gray-700 pb-1">填充顏色</h3>
                        <input type="color" id="obj-color" class="w-full h-8 rounded cursor-pointer border border-gray-600 bg-transparent p-0" onchange="updateObject()">
                    </div>

                    <div id="text-controls" class="hidden space-y-5 pt-4 border-t border-gray-700">
                        <h3 class="text-xs font-bold text-yellow-400 uppercase tracking-wider border-b border-gray-700 pb-1">文字大師</h3>

                        <div class="space-y-2 bg-gray-700/30 p-2 rounded border border-gray-600">
                            <label class="text-xs text-gray-300 font-bold block mb-1">選擇字型</label>
                            <select id="font-family" class="w-full bg-gray-800 border border-gray-600 rounded px-2 py-1 text-sm mb-2" onchange="handleFontChange()">
                                <optgroup label="⭐ 我的最愛 (本地記憶)" id="saved-fonts-group">
                                    </optgroup>
                                <optgroup label="常用系統字型">
                                    <option value="Noto Sans TC">思源黑體 (Web)</option>
                                    <option value="Mochiy Pop One">可愛圓體 (Web)</option>
                                    <option value="Microsoft JhengHei">微軟正黑體</option>
                                    <option value="PMingLiU">新細明體</option>
                                    <option value="DFKai-SB">標楷體</option>
                                    <option value="Arial">Arial</option>
                                </optgroup>
                                <option value="custom_input">➕ 新增電腦字型...</option>
                            </select>

                            <div id="custom-font-area" class="hidden flex gap-2">
                                <input type="text" id="custom-font-input" placeholder="例如: 華康少女文字W5" class="dark-input flex-1">
                                <button onclick="saveCustomFont()" class="bg-blue-600 hover:bg-blue-500 text-white px-2 rounded text-xs" title="儲存並套用"><i class="fas fa-save"></i></button>
                            </div>
                            <button onclick="clearSavedFonts()" class="text-[10px] text-red-400 hover:text-red-300 underline w-full text-right mt-1">清除記憶字型</button>
                        </div>

                        <div class="space-y-2 bg-gray-700/30 p-2 rounded border border-gray-600">
                            <label class="text-xs text-white font-bold flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-white"></span> 白描邊 (Stroke)
                            </label>
                            <div class="flex gap-2 items-center">
                                <input type="color" id="text-stroke-color" value="#ffffff" class="w-8 h-8 rounded border border-gray-500 cursor-pointer p-0" onchange="updateObject()">
                                <input type="range" id="text-stroke-width" min="0" max="20" value="8" step="0.5" class="flex-1 h-2 bg-gray-600 rounded-lg appearance-none" oninput="updateObject()">
                            </div>
                        </div>
                    </div>

                    <button onclick="deleteActiveObject()" class="w-full bg-red-900/40 hover:bg-red-900/60 text-red-300 py-2 rounded border border-red-800/50 transition text-sm">
                        <i class="fas fa-trash-alt mr-2"></i>刪除物件 (Del)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 0. 基礎設定 ---
        fabric.Object.prototype.set({
            transparentCorners: false, cornerColor: '#3b82f6', cornerStyle: 'circle', borderColor: '#3b82f6', cornerSize: 10, padding: 5, borderScaleFactor: 1
        });

        // 預設尺寸：Line 貼圖最大值
        const DEFAULT_W = 370;
        const DEFAULT_H = 320;

        const canvas = new fabric.Canvas('c', {
            width: DEFAULT_W, height: DEFAULT_H, backgroundColor: null, preserveObjectStacking: true
        });

        let currentMode = 'select';
        let cropRect = null;
        let viewZoom = 1; // 視圖縮放比例 (非圖片縮放)

        // 歷史紀錄
        let undoStack = [];
        let redoStack = [];
        let isRedoing = false;

        // 字型記憶
        let myFonts = JSON.parse(localStorage.getItem('sticker_my_fonts')) || [];

        // --- 1. 初始化與事件監聽 ---
        window.onload = function() {
            renderFontOptions();
            resizeCanvasDimension(); // 確保畫布置中
        };

        // 監聽畫布點擊 (處理點空白處取消選取)
        canvas.on('selection:cleared', updatePanel);
        canvas.on('selection:created', updatePanelFromSelection);
        canvas.on('selection:updated', updatePanelFromSelection);
        
        // 歷史紀錄監聽
        canvas.on('object:added', saveState);
        canvas.on('object:modified', saveState);
        canvas.on('object:removed', saveState);
        canvas.on('path:created', (opt) => {
            if(currentMode === 'eraser') {
                opt.path.globalCompositeOperation = 'destination-out';
                opt.path.selectable = false; opt.path.evented = false;
            }
        });

        // --- 2. 畫布尺寸與視圖控制 (解決問題 1) ---
        function resizeCanvasDimension() {
            const w = parseInt(document.getElementById('canvas-w').value);
            const h = parseInt(document.getElementById('canvas-h').value);
            canvas.setWidth(w);
            canvas.setHeight(h);
            canvas.requestRenderAll();
        }

        function setStandardSize() {
            document.getElementById('canvas-w').value = DEFAULT_W;
            document.getElementById('canvas-h').value = DEFAULT_H;
            resizeCanvasDimension();
        }

        // 視圖縮放 (View Zoom) - 純粹放大給眼睛看，不改變輸出尺寸
        function zoomView(factor) {
            viewZoom *= factor;
            viewZoom = Math.min(Math.max(viewZoom, 0.5), 5); // 限制 0.5x ~ 5x
            document.getElementById('zoom-val').innerText = Math.round(viewZoom * 100) + '%';
            
            // 使用 CSS Transform 進行視覺縮放，比 canvas.setZoom 更單純，不會影響裁切邏輯
            const container = document.getElementById('canvas-container');
            container.style.transform = `scale(${viewZoom})`;
        }

        function resetViewZoom() {
            viewZoom = 1;
            document.getElementById('zoom-val').innerText = '100%';
            document.getElementById('canvas-container').style.transform = `scale(1)`;
        }

        // --- 3. 圖片載入 (改為物件模式，解決底圖縮放問題) ---
        document.getElementById('imgLoader').addEventListener('change', loadFile);
        window.addEventListener('paste', (e) => {
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            for (let item of items) {
                if (item.kind === 'file') {
                    const reader = new FileReader();
                    reader.onload = (event) => loadToCanvas(event.target.result);
                    reader.readAsDataURL(item.getAsFile());
                }
            }
        });

        function loadFile(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (f) => loadToCanvas(f.target.result);
            reader.readAsDataURL(file);
        }

        function loadToCanvas(dataURL) {
            fabric.Image.fromURL(dataURL, function(img) {
                // 這裡不再改變 Canvas 大小，而是調整圖片大小
                const canvasW = canvas.width;
                const canvasH = canvas.height;
                
                // 如果圖片比畫布大，縮放到適合畫布
                if (img.width > canvasW || img.height > canvasH) {
                    const scale = Math.min(canvasW / img.width, canvasH / img.height) * 0.9; // 留一點邊
                    img.scale(scale);
                }

                // 置中
                img.set({
                    left: canvasW / 2,
                    top: canvasH / 2,
                    originX: 'center',
                    originY: 'center'
                });

                canvas.add(img);
                img.sendToBack(); // 預設放到最下層
                canvas.setActiveObject(img); // 選中它，讓使用者知道可以調整
                saveState();
            });
            // 載入新圖時清空歡迎訊息
            document.getElementById('panel-none').style.display = 'none'; 
        }

        // --- 4. 字型記憶系統 (解決問題 2) ---
        function renderFontOptions() {
            const group = document.getElementById('saved-fonts-group');
            group.innerHTML = ''; // 清空
            if (myFonts.length === 0) {
                const opt = document.createElement('option');
                opt.text = "(尚無紀錄)";
                opt.disabled = true;
                group.appendChild(opt);
            } else {
                myFonts.forEach(fontName => {
                    const opt = document.createElement('option');
                    opt.value = fontName;
                    opt.text = fontName;
                    group.appendChild(opt);
                });
            }
        }

        function handleFontChange() {
            const select = document.getElementById('font-family');
            const customArea = document.getElementById('custom-font-area');
            
            if (select.value === 'custom_input') {
                customArea.classList.remove('hidden');
                document.getElementById('custom-font-input').focus();
            } else {
                customArea.classList.add('hidden');
                updateObject(); // 直接套用選單字型
            }
        }

        function saveCustomFont() {
            const name = document.getElementById('custom-font-input').value.trim();
            if (!name) return;

            // 儲存到 LocalStorage
            if (!myFonts.includes(name)) {
                myFonts.unshift(name); // 加到最前面
                localStorage.setItem('sticker_my_fonts', JSON.stringify(myFonts));
                
                // 重新渲染選單並選中它
                renderFontOptions();
                document.getElementById('font-family').value = name;
                document.getElementById('custom-font-area').classList.add('hidden');
                
                // 套用字型
                updateObject();
                alert(`已記憶字型：「${name}」`);
            } else {
                // 已存在，直接套用
                document.getElementById('font-family').value = name;
                updateObject();
            }
        }

        function clearSavedFonts() {
            if(confirm('確定要清除所有記憶的字型嗎？')) {
                myFonts = [];
                localStorage.removeItem('sticker_my_fonts');
                renderFontOptions();
                document.getElementById('font-family').value = 'Noto Sans TC';
            }
        }

        // --- 5. 物件操作與面板 ---
        function addText() {
            setMode('select');
            const text = new fabric.IText('輸入文字', {
                left: canvas.width / 2, top: canvas.height / 2, originX: 'center', originY: 'center',
                fontFamily: 'Noto Sans TC', fontSize: 60, fill: '#000000', stroke: '#ffffff', strokeWidth: 8, paintFirst: 'stroke', fontWeight: '900'
            });
            canvas.add(text);
            canvas.setActiveObject(text);
        }

        function updateObject() {
            const obj = canvas.getActiveObject();
            if (!obj) return;
            
            obj.set('fill', document.getElementById('obj-color').value);
            
            if (obj.type === 'i-text') {
                let fontVal = document.getElementById('font-family').value;
                if (fontVal === 'custom_input') {
                    // 如果還在輸入狀態，暫時不更新，或者使用輸入框的值
                    fontVal = document.getElementById('custom-font-input').value || 'sans-serif';
                }

                obj.set({
                    fontFamily: fontVal,
                    stroke: document.getElementById('text-stroke-color').value,
                    strokeWidth: parseFloat(document.getElementById('text-stroke-width').value)
                });
            }
            canvas.requestRenderAll();
            // saveState 透過 object:modified 觸發
        }

        function updatePanelFromSelection() {
            updatePanel();
            const obj = canvas.getActiveObject();
            if (!obj) return;
            
            if(typeof obj.fill === 'string') document.getElementById('obj-color').value = obj.fill;
            
            if (obj.type === 'i-text') {
                document.getElementById('text-stroke-color').value = obj.stroke || '#ffffff';
                document.getElementById('text-stroke-width').value = obj.strokeWidth || 0;
                
                // 同步字型選單
                const options = Array.from(document.getElementById('font-family').options).map(o => o.value);
                if (options.includes(obj.fontFamily)) {
                    document.getElementById('font-family').value = obj.fontFamily;
                    document.getElementById('custom-font-area').classList.add('hidden');
                } else {
                    // 如果是之前輸入過但沒存的，或是系統預設外的
                    document.getElementById('font-family').value = 'custom_input';
                    document.getElementById('custom-font-area').classList.remove('hidden');
                    document.getElementById('custom-font-input').value = obj.fontFamily;
                }
            }
        }

        function updatePanel() {
            const obj = canvas.getActiveObject();
            document.getElementById('panel-none').classList.toggle('hidden', !!obj || canvas.isDrawingMode);
            document.getElementById('panel-brush').classList.toggle('hidden', !canvas.isDrawingMode);
            document.getElementById('panel-object').classList.toggle('hidden', !obj);
            const isText = obj && obj.type === 'i-text';
            document.getElementById('text-controls').classList.toggle('hidden', !isText);
        }

        // 圖層順序
        function bringToFront() { const obj = canvas.getActiveObject(); if(obj) { obj.bringToFront(); saveState(); } }
        function sendToBack() { const obj = canvas.getActiveObject(); if(obj) { obj.sendToBack(); saveState(); } }

        function deleteActiveObject() {
            const obj = canvas.getActiveObject();
            if (obj && !obj.isEditing) {
                canvas.remove(obj);
                canvas.discardActiveObject();
                updatePanel();
            }
        }

        // --- 6. 工具模式 ---
        function setMode(mode) {
            if(currentMode === 'crop' && mode !== 'crop') cancelCrop();
            currentMode = mode;
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            const map = { 'select': 'btn-select', 'draw': 'btn-draw', 'eraser': 'btn-eraser', 'crop': 'btn-crop' };
            if(map[mode]) document.getElementById(map[mode]).classList.add('active');

            if (mode === 'draw' || mode === 'eraser') {
                canvas.isDrawingMode = true;
                canvas.discardActiveObject();
                updateBrush();
            } else {
                canvas.isDrawingMode = false;
            }
            canvas.requestRenderAll();
            updatePanel();
        }

        function setBrushColor(c) {
            document.getElementById('draw-color').value = c;
            updateBrush();
        }

        function updateBrush() {
            if (!canvas.freeDrawingBrush) return;
            const size = parseInt(document.getElementById('draw-width').value);
            document.getElementById('brush-size-val').innerText = size;
            canvas.freeDrawingBrush.width = size;
            canvas.freeDrawingBrush.strokeLineCap = 'round';
            
            if (currentMode === 'eraser') {
                canvas.freeDrawingBrush.color = 'rgba(0,0,0,1)'; 
                canvas.defaultCursor = 'crosshair';
                document.getElementById('brush-color-wrap').classList.add('opacity-30', 'pointer-events-none');
            } else {
                canvas.freeDrawingBrush.color = document.getElementById('draw-color').value;
                canvas.defaultCursor = 'crosshair';
                document.getElementById('brush-color-wrap').classList.remove('opacity-30', 'pointer-events-none');
            }
        }

        // --- 7. 裁切 (配合 View Zoom 修正) ---
        function startCrop() {
            setMode('crop');
            document.getElementById('crop-controls').classList.remove('hidden');
            // 裁切時暫時恢復視圖縮放，以免計算錯誤
            resetViewZoom();
            
            cropRect = new fabric.Rect({
                fill: 'rgba(0,0,0,0.3)', stroke: '#3b82f6', strokeWidth: 2, strokeDashArray: [10, 5],
                left: 0, top: 0, width: canvas.width, height: canvas.height,
                selectable: true, hasRotatingPoint: false, lockRotation: true,
                cornerColor: 'white', cornerStrokeColor: '#3b82f6', transparentCorners: false
            });
            canvas.add(cropRect);
            canvas.setActiveObject(cropRect);
        }

        function cancelCrop() {
            if (cropRect) canvas.remove(cropRect);
            document.getElementById('crop-controls').classList.add('hidden');
            setMode('select');
        }

        function applyCrop() {
            if (!cropRect) return;
            const { left, top, width, height } = cropRect.getBoundingRect();
            cropRect.visible = false;
            // 匯出當前範圍的圖片
            const url = canvas.toDataURL({ left, top, width, height, format: 'png', multiplier: 1 });
            
            // 清空並重設畫布大小
            canvas.clear();
            canvas.setWidth(width);
            canvas.setHeight(height);
            document.getElementById('canvas-w').value = Math.round(width);
            document.getElementById('canvas-h').value = Math.round(height);

            fabric.Image.fromURL(url, (img) => {
                canvas.add(img);
                img.set({ selectable: true });
                saveState();
                cancelCrop();
            });
        }

        // --- 8. 歷史紀錄實作 ---
        function saveState() {
            if (isRedoing) return;
            redoStack = [];
            if(undoStack.length > 20) undoStack.shift(); // 限制紀錄 20 步
            undoStack.push(canvas.toJSON());
            updateHistoryButtons();
        }

        function updateHistoryButtons() {
            document.getElementById('btn-undo').disabled = undoStack.length === 0;
            document.getElementById('btn-redo').disabled = redoStack.length === 0;
        }

        function undo() {
            if (undoStack.length > 0) {
                isRedoing = true;
                redoStack.push(canvas.toJSON());
                const state = undoStack.pop();
                canvas.loadFromJSON(state, () => {
                    canvas.renderAll();
                    isRedoing = false;
                    updateHistoryButtons();
                });
            }
        }

        function redo() {
            if (redoStack.length > 0) {
                isRedoing = true;
                undoStack.push(canvas.toJSON());
                const state = redoStack.pop();
                canvas.loadFromJSON(state, () => {
                    canvas.renderAll();
                    isRedoing = false;
                    updateHistoryButtons();
                });
            }
        }

        // --- 9. 下載 ---
        function downloadImage() {
            canvas.discardActiveObject();
            resetViewZoom(); // 確保輸出不受視圖影響
            canvas.requestRenderAll();
            setTimeout(() => {
                const link = document.createElement('a');
                link.download = `sticker-${Date.now()}.png`;
                link.href = canvas.toDataURL({ format: 'png', quality: 1, multiplier: 1 });
                link.click();
            }, 100);
        }

        // 鍵盤監聽
        window.addEventListener('keydown', (e) => {
            if ((e.key === 'Delete' || e.key === 'Backspace')) deleteActiveObject();
            if (e.ctrlKey && e.key === 'z') { e.preventDefault(); undo(); }
            if (e.ctrlKey && e.key === 'y') { e.preventDefault(); redo(); }
            // Alt 拖曳平移 (Fabric 內建邏輯)
        });
    </script>
</body>
</html>
