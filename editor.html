<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINE Sticker Craft - è¦–è¦ºåŒ–ç·¨è¼¯å™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .canvas-container { 
            background-image: linear-gradient(45deg, #ccc 25%, transparent 25%), linear-gradient(-45deg, #ccc 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #ccc 75%), linear-gradient(-45deg, transparent 75%, #ccc 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            background-color: white; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }
        .tool-btn.active { background-color: #3b82f6; color: white; border-color: #3b82f6; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 h-screen flex flex-col overflow-hidden">

    <header class="h-14 bg-gray-800 border-b border-gray-700 flex items-center justify-between px-4 shrink-0">
        <div class="flex items-center space-x-2">
            <span class="text-xl">ğŸ¨</span>
            <h1 class="font-bold text-lg tracking-wide">Sticker Craft</h1>
        </div>
        <div class="flex space-x-3">
            <label class="cursor-pointer bg-gray-700 hover:bg-gray-600 px-3 py-1.5 rounded text-sm transition flex items-center gap-2">
                ğŸ“‚ é–‹å•Ÿåœ–ç‰‡
                <input type="file" id="imgLoader" accept="image/*" class="hidden">
            </label>
            <button onclick="downloadImage()" class="bg-green-600 hover:bg-green-500 text-white px-4 py-1.5 rounded text-sm font-bold shadow transition">
                ä¸‹è¼‰ PNG
            </button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <div class="w-20 bg-gray-800 border-r border-gray-700 flex flex-col items-center py-4 space-y-4 z-10">
            <button onclick="setMode('select')" id="btn-select" class="tool-btn active w-12 h-12 rounded-lg border border-gray-600 flex flex-col items-center justify-center hover:bg-gray-700 transition" title="é¸å–/ç§»å‹•">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"></path></svg>
                <span class="text-[10px] mt-1">é¸å–</span>
            </button>

            <button onclick="addText()" class="tool-btn w-12 h-12 rounded-lg border border-gray-600 flex flex-col items-center justify-center hover:bg-gray-700 transition" title="æ–°å¢æ–‡å­—">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                <span class="text-[10px] mt-1">æ–‡å­—</span>
            </button>

            <button onclick="setMode('draw')" id="btn-draw" class="tool-btn w-12 h-12 rounded-lg border border-gray-600 flex flex-col items-center justify-center hover:bg-gray-700 transition" title="æ‰‹ç¹ª/å¡—é´‰">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                <span class="text-[10px] mt-1">æ‰‹ç¹ª</span>
            </button>

            <button onclick="startCrop()" id="btn-crop" class="tool-btn w-12 h-12 rounded-lg border border-gray-600 flex flex-col items-center justify-center hover:bg-gray-700 transition" title="è£åˆ‡åœ–ç‰‡">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                <span class="text-[10px] mt-1">è£åˆ‡</span>
            </button>

            <button onclick="deleteActiveObject()" class="text-red-400 tool-btn w-12 h-12 rounded-lg border border-gray-600 flex flex-col items-center justify-center hover:bg-gray-700 transition" title="åˆªé™¤é¸ä¸­ç‰©ä»¶">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
            </button>
        </div>

        <div class="flex-1 bg-gray-900 flex items-center justify-center relative p-8 overflow-auto" id="canvas-wrapper">
            <canvas id="c"></canvas>
            
            <div id="crop-controls" class="absolute bottom-10 bg-gray-800 p-2 rounded shadow-lg flex space-x-2 hidden">
                <span class="text-sm text-gray-300 flex items-center px-2">æ‹–æ‹‰æ–¹æ¡†èª¿æ•´ç¯„åœ</span>
                <button onclick="applyCrop()" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded text-sm">ç¢ºèªè£åˆ‡</button>
                <button onclick="cancelCrop()" class="bg-gray-600 hover:bg-gray-500 text-white px-3 py-1 rounded text-sm">å–æ¶ˆ</button>
            </div>
        </div>

        <div class="w-64 bg-gray-800 border-l border-gray-700 p-4 flex flex-col space-y-6">
            
            <div id="panel-drawing" class="hidden">
                <h3 class="text-sm font-bold text-gray-400 uppercase mb-3">ğŸ–Šï¸ ç•«ç­†è¨­å®š</h3>
                <div class="space-y-4">
                    <div>
                        <label class="text-xs text-gray-400">é¡è‰²</label>
                        <input type="color" id="draw-color" value="#000000" class="w-full h-8 cursor-pointer rounded bg-transparent" onchange="updateBrush()">
                    </div>
                    <div>
                        <label class="text-xs text-gray-400">ç²—ç´°: <span id="width-val">3</span></label>
                        <input type="range" id="draw-width" min="1" max="50" value="3" class="w-full accent-blue-500" oninput="document.getElementById('width-val').innerText=this.value; updateBrush()">
                    </div>
                    <div class="flex items-center space-x-2 pt-2">
                        <input type="checkbox" id="eraser-mode" onchange="updateBrush()" class="w-4 h-4 accent-red-500">
                        <label for="eraser-mode" class="text-sm cursor-pointer select-none">æ©¡çš®æ“¦æ¨¡å¼</label>
                    </div>
                </div>
            </div>

            <div id="panel-object">
                <h3 class="text-sm font-bold text-gray-400 uppercase mb-3">ğŸ› ï¸ ç‰©ä»¶å±¬æ€§</h3>
                <div class="space-y-4">
                    <div>
                        <label class="text-xs text-gray-400">å¡«å……é¡è‰²</label>
                        <input type="color" id="obj-color" class="w-full h-8 cursor-pointer rounded bg-transparent" onchange="updateObject()">
                    </div>
                    <div id="text-controls" class="hidden space-y-4">
                        <div>
                            <label class="text-xs text-gray-400">æ–‡å­—å¤–æ¡†é¡è‰² (Stroke)</label>
                            <input type="color" id="text-stroke" value="#ffffff" class="w-full h-8 cursor-pointer rounded bg-transparent" onchange="updateObject()">
                        </div>
                        <div>
                            <label class="text-xs text-gray-400">å¤–æ¡†ç²—ç´°</label>
                            <input type="range" id="text-stroke-width" min="0" max="10" value="0" class="w-full accent-blue-500" oninput="updateObject()">
                        </div>
                        <div>
                            <label class="text-xs text-gray-400">å­—é«”</label>
                            <select id="font-family" class="w-full bg-gray-700 text-sm p-1 rounded border border-gray-600" onchange="updateObject()">
                                <option value="Noto Sans TC">æ€æºé»‘é«”</option>
                                <option value="Arial">Arial</option>
                                <option value="Comic Sans MS">Comic Sans (æ‰‹å¯«æ„Ÿ)</option>
                                <option value="Times New Roman">Times New Roman</option>
                            </select>
                        </div>
                    </div>
                    <div class="text-xs text-gray-500 mt-4">
                        ğŸ’¡ æç¤ºï¼šé»é¸ç•«å¸ƒä¸Šçš„ç‰©ä»¶å³å¯é€²è¡Œæ—‹è½‰ã€ç¸®æ”¾èˆ‡ç§»å‹•ã€‚æŒ‰ Delete éµå¯åˆªé™¤ã€‚
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // 1. åˆå§‹åŒ– Fabric Canvas
        const canvas = new fabric.Canvas('c', {
            width: 500,
            height: 500,
            backgroundColor: null, // é€æ˜èƒŒæ™¯
            isDrawingMode: false
        });

        // ç›£è½è¦–çª—å¤§å°æ”¹è®Š (ç°¡æ˜“ RWD)
        // window.addEventListener('resize', () => { ... }); // ç•¥ï¼Œä¿æŒå›ºå®šå°ºå¯¸è¼ƒå¥½æ§åˆ¶

        // 2. è®Šæ•¸èˆ‡ç‹€æ…‹
        let currentMode = 'select'; // select, draw, crop
        let cropRect = null; // è£åˆ‡æ¡†ç‰©ä»¶

        // 3. åœ–ç‰‡ä¸Šå‚³
        document.getElementById('imgLoader').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(f) {
                fabric.Image.fromURL(f.target.result, function(img) {
                    // èª¿æ•´ Canvas å¤§å°ä»¥ç¬¦åˆåœ–ç‰‡ï¼Œæˆ–ç¸®æ”¾åœ–ç‰‡
                    // ç­–ç•¥ï¼šå°‡ Canvas è¨­ç‚ºåœ–ç‰‡å¤§å° (æœ€å¤§é™åˆ¶ 800px)
                    const maxDim = 800;
                    let scale = 1;
                    if(img.width > maxDim || img.height > maxDim) {
                        scale = Math.min(maxDim/img.width, maxDim/img.height);
                    }
                    
                    canvas.setWidth(img.width * scale);
                    canvas.setHeight(img.height * scale);
                    canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas), {
                        scaleX: scale,
                        scaleY: scale
                    });
                });
            };
            reader.readAsDataURL(file);
        });

        // 4. æ¨¡å¼åˆ‡æ›é‚è¼¯
        function setMode(mode) {
            currentMode = mode;
            
            // UI æ›´æ–°
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-${mode === 'crop' ? 'crop' : mode}`).classList.add('active');

            // é¢æ¿é¡¯ç¤º
            document.getElementById('panel-drawing').classList.toggle('hidden', mode !== 'draw');
            document.getElementById('panel-object').classList.toggle('hidden', mode === 'draw' || mode === 'crop');
            
            // Fabric ç‹€æ…‹è¨­å®š
            if (mode === 'draw') {
                canvas.isDrawingMode = true;
                canvas.discardActiveObject();
                canvas.requestRenderAll();
                updateBrush();
            } else {
                canvas.isDrawingMode = false;
            }

            // è£åˆ‡æ¨¡å¼ç‰¹æ®Šè™•ç†
            if (mode !== 'crop') {
                cancelCrop(); // å¦‚æœé›¢é–‹è£åˆ‡æ¨¡å¼ï¼Œæ¸…é™¤è£åˆ‡æ¡†
            }
        }

        // 5. æ–°å¢æ–‡å­—
        function addText() {
            setMode('select');
            const text = new fabric.IText('è«‹è¼¸å…¥æ–‡å­—', {
                left: 50,
                top: 50,
                fontFamily: 'Noto Sans TC',
                fill: '#000000',
                fontSize: 40
            });
            canvas.add(text);
            canvas.setActiveObject(text);
        }

        // 6. ç•«ç­†èˆ‡æ©¡çš®æ“¦æ›´æ–°
        function updateBrush() {
            if (!canvas.freeDrawingBrush) return;

            const color = document.getElementById('draw-color').value;
            const width = parseInt(document.getElementById('draw-width').value, 10);
            const isEraser = document.getElementById('eraser-mode').checked;

            canvas.freeDrawingBrush.width = width;
            
            if (isEraser) {
                // æ©¡çš®æ“¦é‚è¼¯ï¼šåœ¨ Fabric ä¸­ï¼Œæˆ‘å€‘ä½¿ç”¨ç™½è‰²æˆ–ç‰¹æ®Šåˆæˆæ¨¡å¼
                // ç‚ºäº†ç°¡å–®ä¸”æ”¯æ´é€æ˜èƒŒæ™¯ï¼Œæˆ‘å€‘æŠŠé¡è‰²è¨­ç‚ºç™½è‰² (å¦‚æœæ˜¯ç™½åº•åœ–) 
                // æˆ–ä½¿ç”¨ globalCompositeOperation 'destination-out' (é€²éš)
                
                // é€™è£¡ä½¿ç”¨ 'destination-out' ä¾†æ“¦é™¤æˆé€æ˜
                canvas.freeDrawingBrush.color = 'rgba(0,0,0,1)'; // é¡è‰²ä¸é‡è¦ï¼Œé‡é»æ˜¯ opacity
                // é€™æ˜¯ Fabric éš±è—çš„å¼·å¤§åŠŸèƒ½ï¼šç›´æ¥ä¿®æ”¹ Context å±¬æ€§
                canvas.freeDrawingBrush.source = canvas.freeDrawingBrush.getPatternSrc ? canvas.freeDrawingBrush.getPatternSrc() : null; 
                
                // Hack: æˆ‘å€‘éœ€è¦ç›£è½ path:created äº‹ä»¶ä¾†æ‡‰ç”¨ destination-out
                // ä½†æ›´ç°¡å–®çš„æ–¹æ³•æ˜¯ï¼šç•¶å®ƒæ˜¯ Eraser æ¨¡å¼æ™‚ï¼Œæˆ‘å€‘ç•«ç™½è‰²çš„ç·š (å¦‚æœèƒŒæ™¯æ˜¯ç™½çš„)
                // æ—¢ç„¶ä½¿ç”¨è€…è¦ç”Ÿæˆ Line è²¼åœ– (é€æ˜åº•)ï¼Œæˆ‘å€‘é€™è£¡æ¨¡æ“¬ã€Œæ©¡çš®æ“¦ã€ç‚ºã€Œç•«ç™½è‰²ã€
                // å› ç‚º Line è²¼åœ–å»èƒŒæ˜¯åœ¨æœ€å¾Œè¼¸å‡ºæ™‚è™•ç†ï¼Œæˆ–æ˜¯é€™å¼µåœ–æœ¬èº«å°±æ˜¯é€æ˜çš„
                
                // é€²éšï¼šä½¿ç”¨ destination-out
                // Fabric V5 ä¸å®¹æ˜“ç›´æ¥è¨­å®š Brush çš„ CompositeOperationã€‚
                // å¦¥å”æ–¹æ¡ˆï¼šç•«ä¸€æ¢ç·šï¼Œç„¶å¾Œè¨­å®šé€™æ¢ç·šçš„ globalCompositeOperation
                
                canvas.freeDrawingBrush.color = "white"; // ç°¡å–®èµ·è¦‹ï¼Œå…ˆç•«ç™½è‰²ï¼Œä½¿ç”¨è€…å¯ä»¥ç•¶ä½œä¿®æ­£æ¶²
            } else {
                canvas.freeDrawingBrush.color = color;
            }
        }
        
        // ä¿®æ­£æ©¡çš®æ“¦ï¼šç›£è½è·¯å¾‘å»ºç«‹ï¼Œå¦‚æœæ˜¯æ©¡çš®æ“¦æ¨¡å¼ï¼Œæ”¹è®Šåˆæˆæ¨¡å¼
        canvas.on('path:created', function(opt) {
            const isEraser = document.getElementById('eraser-mode').checked;
            if (isEraser) {
                opt.path.globalCompositeOperation = 'destination-out';
                // éœ€è¦é‡æ–°ç¹ªè£½ä»¥ç”Ÿæ•ˆ
                canvas.renderAll();
            }
        });

        // 7. ç‰©ä»¶å±¬æ€§æ›´æ–° (ç›£è½é¸å–)
        canvas.on('selection:created', updatePanelFromObject);
        canvas.on('selection:updated', updatePanelFromObject);
        
        function updatePanelFromObject() {
            const obj = canvas.getActiveObject();
            if (!obj) return;

            // é¡¯ç¤ºé¡è‰²
            if (obj.fill && typeof obj.fill === 'string') {
                document.getElementById('obj-color').value = obj.fill;
            }
            
            // å¦‚æœæ˜¯æ–‡å­—ï¼Œé¡¯ç¤ºæ–‡å­—é¸é …
            const isText = obj.type === 'i-text' || obj.type === 'text';
            document.getElementById('text-controls').classList.toggle('hidden', !isText);
            
            if (isText) {
                document.getElementById('text-stroke').value = obj.stroke || '#ffffff';
                document.getElementById('text-stroke-width').value = obj.strokeWidth || 0;
                document.getElementById('font-family').value = obj.fontFamily || 'Noto Sans TC';
            }
        }

        function updateObject() {
            const obj = canvas.getActiveObject();
            if (!obj) return;

            const color = document.getElementById('obj-color').value;
            obj.set('fill', color);

            if (obj.type === 'i-text' || obj.type === 'text') {
                obj.set('stroke', document.getElementById('text-stroke').value);
                obj.set('strokeWidth', parseInt(document.getElementById('text-stroke-width').value, 10));
                obj.set('fontFamily', document.getElementById('font-family').value);
            }
            canvas.requestRenderAll();
        }

        // 8. åˆªé™¤ç‰©ä»¶
        function deleteActiveObject() {
            const obj = canvas.getActiveObject();
            if (obj) {
                canvas.remove(obj);
                canvas.discardActiveObject();
                canvas.requestRenderAll();
            }
        }
        
        // éµç›¤åˆªé™¤æ”¯æ´
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Delete' || e.key === 'Backspace') {
                // é¿å…åœ¨æ‰“å­—æ™‚åˆªé™¤ç‰©ä»¶
                if (canvas.getActiveObject() && !canvas.getActiveObject().isEditing) {
                    deleteActiveObject();
                }
            }
        });

        // 9. è£åˆ‡åŠŸèƒ½ (Crop)
        function startCrop() {
            setMode('crop');
            document.getElementById('crop-controls').classList.remove('hidden');

            // å»ºç«‹ä¸€å€‹åŠé€æ˜é®ç½©çŸ©å½¢
            cropRect = new fabric.Rect({
                fill: 'rgba(0,0,0,0.3)',
                stroke: '#3b82f6',
                strokeWidth: 2,
                strokeDashArray: [5, 5],
                left: 0,
                top: 0,
                width: canvas.width,
                height: canvas.height,
                selectable: true,
                hasRotatingPoint: false,
                lockRotation: true
            });
            
            canvas.add(cropRect);
            canvas.setActiveObject(cropRect);
            canvas.requestRenderAll();
        }

        function cancelCrop() {
            if (cropRect) {
                canvas.remove(cropRect);
                cropRect = null;
            }
            document.getElementById('crop-controls').classList.add('hidden');
            if(currentMode === 'crop') setMode('select');
        }

        function applyCrop() {
            if (!cropRect) return;

            const left = cropRect.left;
            const top = cropRect.top;
            const width = cropRect.getScaledWidth();
            const height = cropRect.getScaledHeight();

            // 1. éš±è—è£åˆ‡æ¡†
            cropRect.visible = false; 
            
            // 2. å°‡ç›®å‰çš„ Canvas å…§å®¹åŒ¯å‡ºç‚ºåœ–ç‰‡ (ä¾æ“šè£åˆ‡ç¯„åœ)
            const croppedDataURL = canvas.toDataURL({
                left: left,
                top: top,
                width: width,
                height: height,
                format: 'png'
            });

            // 3. æ¸…ç©º Canvas ä¸¦é‡æ–°è¨­å®šå°ºå¯¸
            canvas.clear();
            canvas.setWidth(width);
            canvas.setHeight(height);

            // 4. é‡æ–°è¼‰å…¥è£åˆ‡å¾Œçš„åœ–ç‰‡ä½œç‚ºèƒŒæ™¯
            fabric.Image.fromURL(croppedDataURL, function(img) {
                canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas), {
                    scaleX: 1,
                    scaleY: 1
                });
                cancelCrop(); // çµæŸè£åˆ‡æ¨¡å¼
                setMode('select');
            });
        }

        // 10. ä¸‹è¼‰
        function downloadImage() {
            // ç¢ºä¿æ²’æœ‰é¸å–æ¡†è¢«å°å‡ºä¾†
            canvas.discardActiveObject();
            canvas.requestRenderAll();
            
            const link = document.createElement('a');
            link.download = `sticker-edited-${Date.now()}.png`;
            link.href = canvas.toDataURL({
                format: 'png',
                quality: 1
            });
            link.click();
        }

    </script>
</body>
</html>