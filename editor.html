<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINE Sticker Finisher - æœ€çµ‚ä¿®æ•´</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@500;900&family=Mochiy+Pop+One&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        /* é€æ˜èƒŒæ™¯æ£‹ç›¤æ ¼ */
        .canvas-bg { 
            background-image: linear-gradient(45deg, #e0e0e0 25%, transparent 25%), linear-gradient(-45deg, #e0e0e0 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #e0e0e0 75%), linear-gradient(-45deg, transparent 75%, #e0e0e0 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            background-color: #ffffff; 
        }
        .tool-btn.active { @apply bg-blue-600 text-white border-blue-600; }
        /* Fabric è‡ªå®šç¾©æ¨£å¼ - è®“æ§åˆ¶é …æ›´æ˜é¡¯ */
        .canvas-container { outline: none; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 h-screen flex flex-col overflow-hidden">

    <header class="h-14 bg-gray-800 border-b border-gray-700 flex items-center justify-between px-4 shrink-0 z-20 shadow-md">
        <h1 class="font-bold text-lg tracking-wide flex items-center"><span class="text-xl mr-2">âœ¨</span>Sticker Finisher</h1>
        <div class="flex space-x-3">
            <label class="cursor-pointer bg-gray-700 hover:bg-gray-600 px-3 py-1.5 rounded text-sm transition flex items-center gap-2 border border-gray-600">
                ğŸ–¼ï¸ è¼‰å…¥åœ–ç‰‡
                <input type="file" id="imgLoader" accept="image/*" class="hidden">
            </label>
            <button onclick="downloadImage()" class="bg-green-600 hover:bg-green-500 text-white px-5 py-1.5 rounded text-sm font-bold shadow transition flex items-center gap-2">
                ğŸ“¥ ä¸‹è¼‰ PNG
            </button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden relative">
        
        <div class="w-16 bg-gray-800 border-r border-gray-700 flex flex-col items-center py-4 space-y-3 z-10 shadow-lg">
            <button onclick="setMode('select')" id="btn-select" class="tool-btn active w-10 h-10 rounded-lg border border-gray-600 flex items-center justify-center hover:bg-gray-700 transition" title="é¸å–/ç§»å‹• (V)">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"></path></svg>
            </button>
            <button onclick="addText()" class="tool-btn w-10 h-10 rounded-lg border border-gray-600 flex items-center justify-center hover:bg-gray-700 transition" title="æ–°å¢æ–‡å­— (T)">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
            </button>
            <button onclick="setMode('draw')" id="btn-draw" class="tool-btn w-10 h-10 rounded-lg border border-gray-600 flex items-center justify-center hover:bg-gray-700 transition" title="æ‰‹ç¹ªç­†åˆ· (B)">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
            </button>
            <button onclick="setMode('eraser')" id="btn-eraser" class="tool-btn w-10 h-10 rounded-lg border border-gray-600 flex items-center justify-center hover:bg-gray-700 transition group" title="æ©¡çš®æ“¦ (E)">
               <svg class="w-5 h-5 group-[.active]:text-red-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
            </button>
             <div class="w-8 h-[1px] bg-gray-700 my-2"></div>
            <button onclick="startCrop()" id="btn-crop" class="tool-btn w-10 h-10 rounded-lg border border-gray-600 flex items-center justify-center hover:bg-gray-700 transition" title="è£åˆ‡åœ–ç‰‡ (C)">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
            </button>
        </div>

        <div class="flex-1 bg-gray-900/50 flex items-center justify-center relative p-4 overflow-auto backdrop-blur-sm" id="canvas-wrapper">
            <div class="canvas-bg shadow-2xl rounded-sm overflow-hidden border border-gray-600/50">
                <canvas id="c"></canvas>
            </div>
            
            <div id="crop-controls" class="absolute bottom-8 bg-gray-800 p-2 rounded-lg shadow-xl border border-gray-700 flex space-x-2 hidden z-30 animate-bounce">
                <span class="text-xs text-gray-300 flex items-center px-2 font-bold">âœ‚ï¸ èª¿æ•´è£åˆ‡ç¯„åœ</span>
                <button onclick="applyCrop()" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded text-xs font-bold">ç¢ºèª âˆš</button>
                <button onclick="cancelCrop()" class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-1 rounded text-xs">å–æ¶ˆ X</button>
            </div>
        </div>

        <div class="w-64 bg-gray-800 border-l border-gray-700 p-5 flex flex-col space-y-6 z-10 shadow-lg overflow-y-auto">
            
            <div id="panel-none" class="text-center text-gray-500 text-sm mt-10">
                <p class="text-4xl mb-4">ğŸ‘ˆ</p>
                <p>åœ¨å·¦å´é¸æ“‡å·¥å…·</p>
                <p>æˆ–é»é¸ç•«å¸ƒä¸Šçš„ç‰©ä»¶</p>
            </div>

            <div id="panel-brush" class="hidden space-y-5">
                <h3 class="text-sm font-black text-gray-400 uppercase tracking-wider border-b border-gray-700 pb-2 flex items-center">
                    <span id="brush-title">ğŸ–Šï¸ ç­†åˆ·è¨­å®š</span>
                </h3>
                <div id="brush-color-forcing" class="space-y-2">
                    <label class="text-xs text-gray-400 font-bold">é¡è‰²</label>
                    <div class="flex space-x-2">
                        <input type="color" id="draw-color" value="#000000" class="w-10 h-10 p-0 border-2 border-gray-600 rounded cursor-pointer bg-transparent" onchange="updateBrush()">
                        <button onclick="setColor('#000000')" class="w-10 h-10 bg-black border-2 border-gray-600 rounded"></button>
                        <button onclick="setColor('#ffffff')" class="w-10 h-10 bg-white border-2 border-gray-600 rounded"></button>
                        <button onclick="setColor('#FF0000')" class="w-10 h-10 bg-red-600 border-2 border-gray-600 rounded"></button>
                    </div>
                </div>
                <div class="space-y-2">
                    <label class="text-xs text-gray-400 font-bold flex justify-between">ç²—ç´° <span><span id="width-val" class="text-blue-400">5</span> px</span></label>
                    <input type="range" id="draw-width" min="1" max="100" value="5" class="w-full accent-blue-500 h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer" oninput="document.getElementById('width-val').innerText=this.value; updateBrush()">
                </div>
            </div>

            <div id="panel-object" class="hidden space-y-5">
                <h3 class="text-sm font-black text-gray-400 uppercase tracking-wider border-b border-gray-700 pb-2">ğŸ› ï¸ ç‰©ä»¶å±¬æ€§</h3>
                
                <div class="space-y-2">
                    <label class="text-xs text-gray-400 font-bold">å¡«å……é¡è‰² (Fill)</label>
                    <div class="flex gap-2">
                        <input type="color" id="obj-color" class="flex-1 h-9 cursor-pointer rounded border border-gray-600 bg-transparent p-0" onchange="updateObject()">
                    </div>
                </div>

                <div id="text-controls" class="hidden space-y-5 pt-2 border-t border-gray-700">
                     <div class="space-y-2">
                        <label class="text-xs text-gray-400 font-bold">å­—é«” (Font)</label>
                        <select id="font-family" class="w-full bg-gray-700 text-sm p-2 rounded border border-gray-600 focus:ring-2 focus:ring-blue-500 outline-none" onchange="updateObject()">
                            <option value="Noto Sans TC" style="font-weight: 900;">æ€æºé»‘é«” (ç²—)</option>
                            <option value="Mochiy Pop One">å¯æ„›åœ“é«” (Mochiy)</option>
                            <option value="Arial">Arial (é€šç”¨)</option>
                        </select>
                    </div>
                    <div class="space-y-2">
                        <label class="text-xs text-gray-400 font-bold">å¤–æ¡†é¡è‰² (Stroke)</label>
                        <input type="color" id="text-stroke" value="#ffffff" class="w-full h-9 cursor-pointer rounded border border-gray-600 bg-transparent p-0" onchange="updateObject()">
                    </div>
                    <div class="space-y-2">
                        <label class="text-xs text-gray-400 font-bold flex justify-between">å¤–æ¡†ç²—ç´° <span><span id="stroke-width-val" class="text-blue-400">0</span> px</span></label>
                        <input type="range" id="text-stroke-width" min="0" max="20" value="0" step="0.5" class="w-full accent-blue-500 h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer" oninput="document.getElementById('stroke-width-val').innerText=this.value; updateObject()">
                    </div>
                     <p class="text-xs text-blue-400 mt-2">ğŸ’¡ æç¤ºï¼šåœ¨ç•«å¸ƒä¸Šã€Œé»å…©ä¸‹ã€æ–‡å­—å³å¯ç›´æ¥è¼¸å…¥ç·¨è¼¯ã€‚</p>
                </div>

                <button onclick="deleteActiveObject()" class="w-full mt-8 bg-red-900/50 hover:bg-red-800 text-red-300 border border-red-800 py-2 rounded-lg text-sm transition flex items-center justify-center gap-2">
                    ğŸ—‘ï¸ åˆªé™¤æ­¤ç‰©ä»¶ (Del)
                </button>
            </div>

        </div>
    </div>

    <script>
        // --- 1. åˆå§‹åŒ–è¨­å®š ---
        // è¦†å¯« Fabric ç‰©ä»¶çš„é è¨­æ§åˆ¶é …æ¨£å¼ (è®“å®ƒçœ‹èµ·ä¾†æ›´ç¾ä»£)
        fabric.Object.prototype.set({
            transparentCorners: false,
            cornerColor: '#3b82f6',
            cornerStyle: 'circle',
            borderColor: '#3b82f6',
            cornerSize: 12,
            borderScaleFactor: 2,
            padding: 5
        });

        const canvas = new fabric.Canvas('c', {
            width: 600, height: 600, // åˆå§‹é è¨­å¤§å°
            backgroundColor: null, // é€æ˜èƒŒæ™¯
            isDrawingMode: false
        });

        let currentMode = 'select';
        let cropRect = null;
        let isEraserActive = false;

        // --- 2. æ ¸å¿ƒåŠŸèƒ½ï¼šæª”æ¡ˆèˆ‡ç•«å¸ƒ ---
        document.getElementById('imgLoader').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(f) {
                fabric.Image.fromURL(f.target.result, function(img) {
                    // è¨­å®šç•«å¸ƒå°ºå¯¸ç‚ºåœ–ç‰‡å°ºå¯¸ (ä½†ä¸è¶…éè¢å¹•å¤ªå¤š)
                    const maxDim = 800;
                    let scale = 1;
                    if(img.width > maxDim || img.height > maxDim) {
                        scale = Math.min(maxDim/img.width, maxDim/img.height);
                    }
                    canvas.setWidth(img.width * scale);
                    canvas.setHeight(img.height * scale);
                    canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas), {
                        scaleX: scale, scaleY: scale
                    });
                    canvas.clear(); // æ¸…é™¤èˆŠç‰©ä»¶
                });
            };
            reader.readAsDataURL(file);
        });

        function downloadImage() {
            canvas.discardActiveObject(); // å–æ¶ˆé¸å–æ¡†
            canvas.requestRenderAll();
            const link = document.createElement('a');
            link.download = `sticker-${Date.now()}.png`;
            // è¼¸å‡ºé«˜å“è³ª PNG
            link.href = canvas.toDataURL({ format: 'png', quality: 1, multiplier: 1 });
            link.click();
        }

        // --- 3. æ ¸å¿ƒåŠŸèƒ½ï¼šæ¨¡å¼åˆ‡æ›èˆ‡ UI ---
        function setMode(mode) {
            if(currentMode === 'crop' && mode !== 'crop') cancelCrop();
            currentMode = mode;
            isEraserActive = (mode === 'eraser');
            
            // UI æŒ‰éˆ•ç‹€æ…‹æ›´æ–°
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            const activeBtnId = mode === 'eraser' ? 'btn-eraser' : (mode === 'draw' ? 'btn-draw' : (mode === 'crop' ? 'btn-crop' : 'btn-select'));
            document.getElementById(activeBtnId).classList.add('active');

            // Fabric ç•«å¸ƒç‹€æ…‹è¨­å®š
            canvas.isDrawingMode = (mode === 'draw' || mode === 'eraser');
            canvas.selection = (mode === 'select'); // å…è¨±æ¡†é¸
            if(canvas.isDrawingMode) {
                canvas.discardActiveObject();
                updateBrush();
            } else {
                 canvas.defaultCursor = 'default';
            }
            canvas.requestRenderAll();
            updatePanelDisplay();
        }

        function updatePanelDisplay() {
            const panelNone = document.getElementById('panel-none');
            const panelBrush = document.getElementById('panel-brush');
            const panelObject = document.getElementById('panel-object');
            const activeObj = canvas.getActiveObject();

            panelNone.classList.add('hidden');
            panelBrush.classList.add('hidden');
            panelObject.classList.add('hidden');

            if (currentMode === 'draw' || currentMode === 'eraser') {
                panelBrush.classList.remove('hidden');
                document.getElementById('brush-title').innerText = isEraserActive ? 'ğŸ§¹ æ©¡çš®æ“¦è¨­å®š' : 'ğŸ–Šï¸ ç­†åˆ·è¨­å®š';
                document.getElementById('brush-color-forcing').classList.toggle('hidden', isEraserActive); // æ©¡çš®æ“¦ä¸éœ€è¦é¡è‰²
            } else if (activeObj && currentMode === 'select') {
                panelObject.classList.remove('hidden');
                updatePanelFromObject(activeObj);
            } else {
                panelNone.classList.remove('hidden');
            }
        }

        // --- 4. æ ¸å¿ƒåŠŸèƒ½ï¼šç¹ªåœ–èˆ‡æ©¡çš®æ“¦ ---
        function setColor(color) {
            document.getElementById('draw-color').value = color;
            updateBrush();
        }

        function updateBrush() {
            if (!canvas.freeDrawingBrush) return;
            const width = parseInt(document.getElementById('draw-width').value, 10);
            canvas.freeDrawingBrush.width = width;
            
            if (isEraserActive) {
                 // é—œéµï¼šä½¿ç”¨ destination-out ä¾†å¯¦ç¾çœŸæ­£çš„é€æ˜æ“¦é™¤
                canvas.freeDrawingBrush.color = 'rgba(0,0,0,1)'; // é¡è‰²ä¸é‡è¦ï¼Œé‡è¦çš„æ˜¯ alpha
                canvas.freeDrawingBrush.strokeLineCap = 'round'; // åœ“é ­æ©¡çš®æ“¦æ¯”è¼ƒè‡ªç„¶
                canvas.defaultCursor = 'crosshair';
            } else {
                canvas.freeDrawingBrush.color = document.getElementById('draw-color').value;
                canvas.freeDrawingBrush.strokeLineCap = 'round';
                canvas.defaultCursor = 'crosshair';
            }
        }
        
        // ç›£è½è·¯å¾‘å»ºç«‹äº‹ä»¶ï¼Œæ‡‰ç”¨æ©¡çš®æ“¦æ•ˆæœ
        canvas.on('path:created', function(opt) {
            if (isEraserActive) {
                // å°‡è©²ç­†è§¸çš„åˆæˆæ¨¡å¼æ”¹ç‚ºã€ŒæŒ–ç©ºã€
                opt.path.globalCompositeOperation = 'destination-out';
                // é‡è¦ï¼šè¨­ç‚ºä¸å¯é¸å–ï¼Œé¿å…ä½¿ç”¨è€…ä¸å°å¿ƒç§»å‹•äº†ã€Œæ“¦ç—•ã€
                opt.path.selectable = false; 
                opt.path.evented = false;
                canvas.requestRenderAll();
            }
        });

        // --- 5. æ ¸å¿ƒåŠŸèƒ½ï¼šæ–‡å­—èˆ‡ç‰©ä»¶ç·¨è¼¯ ---
        function addText() {
            setMode('select');
            // ä½¿ç”¨ IText (Interactive Text) æ”¯æ´é›™æ“Šç·¨è¼¯
            const text = new fabric.IText('é›™æ“Šç·¨è¼¯æ–‡å­—', {
                left: canvas.width / 2, top: canvas.height / 2, originX: 'center', originY: 'center',
                fontFamily: 'Noto Sans TC', fontWeight: 900, fill: '#000000', fontSize: 60,
                stroke: '#ffffff', strokeWidth: 8, // é è¨­çµ¦ä¸€å€‹ç™½é‚Šï¼Œè²¼åœ–å¸¸ç”¨
                paintFirst: 'stroke' // å…ˆç•«é‚Šå†ç•«å¡«å……ï¼Œæ•ˆæœè¼ƒå¥½
            });
            canvas.add(text);
            canvas.setActiveObject(text);
            updatePanelDisplay();
        }

        // ç›£è½ç‰©ä»¶é¸å–äº‹ä»¶ä¾†æ›´æ–°é¢æ¿
        canvas.on('selection:created', updatePanelDisplay);
        canvas.on('selection:updated', updatePanelDisplay);
        canvas.on('selection:cleared', updatePanelDisplay);

        function updatePanelFromObject(obj) {
            if (obj.fill && typeof obj.fill === 'string') document.getElementById('obj-color').value = obj.fill;
            
            const isText = obj.type === 'i-text';
            document.getElementById('text-controls').classList.toggle('hidden', !isText);
            
            if (isText) {
                document.getElementById('text-stroke').value = obj.stroke || '#ffffff';
                document.getElementById('text-stroke-width').value = obj.strokeWidth || 0;
                document.getElementById('stroke-width-val').innerText = obj.strokeWidth || 0;
                document.getElementById('font-family').value = obj.fontFamily || 'Noto Sans TC';
            }
        }

        function updateObject() {
            const obj = canvas.getActiveObject();
            if (!obj) return;
            obj.set('fill', document.getElementById('obj-color').value);
            if (obj.type === 'i-text') {
                obj.set({
                    'stroke': document.getElementById('text-stroke').value,
                    'strokeWidth': parseFloat(document.getElementById('text-stroke-width').value),
                    'fontFamily': document.getElementById('font-family').value
                });
            }
            canvas.requestRenderAll();
        }

        function deleteActiveObject() {
            const obj = canvas.getActiveObject();
            if (obj) {
                canvas.remove(obj);
                canvas.discardActiveObject();
                updatePanelDisplay();
            }
        }

        // --- 6. æ ¸å¿ƒåŠŸèƒ½ï¼šè£åˆ‡ (Crop) ---
        function startCrop() {
            setMode('crop');
            document.getElementById('crop-controls').classList.remove('hidden');
            // å»ºç«‹åŠé€æ˜é®ç½©
            cropRect = new fabric.Rect({
                fill: 'rgba(0,0,0,0.4)', stroke: '#3b82f6', strokeWidth: 2, strokeDashArray: [10, 5],
                left: 0, top: 0, width: canvas.width, height: canvas.height,
                selectable: true, hasRotatingPoint: false, lockRotation: true,
                cornerColor: 'white', cornerStrokeColor: '#3b82f6', transparentCorners: false
            });
            canvas.add(cropRect);
            canvas.setActiveObject(cropRect);
        }

        function cancelCrop() {
            if (cropRect) { canvas.remove(cropRect); cropRect = null; }
            document.getElementById('crop-controls').classList.add('hidden');
            if(currentMode === 'crop') setMode('select');
        }

        function applyCrop() {
            if (!cropRect) return;
            const { left, top, width, height } = cropRect.getBoundingRect(); // ç²å–çµ•å°åº§æ¨™èˆ‡å°ºå¯¸
            cropRect.visible = false; 
            
            // å°‡ç›®å‰ç•«å¸ƒæŒ‡å®šå€åŸŸåŒ¯å‡ºç‚ºåœ–ç‰‡
            const croppedDataURL = canvas.toDataURL({
                left, top, width, height, format: 'png', multiplier: 1
            });

            // é‡ç½®ç•«å¸ƒ
            canvas.clear();
            canvas.setWidth(width);
            canvas.setHeight(height);
            fabric.Image.fromURL(croppedDataURL, function(img) {
                canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas), { scaleX: 1, scaleY: 1 });
                cancelCrop();
            });
        }

        // --- 7. éµç›¤å¿«æ·éµ ---
        window.addEventListener('keydown', (e) => {
            if ((e.key === 'Delete' || e.key === 'Backspace')) {
                const activeObj = canvas.getActiveObject();
                // å¦‚æœæ­£åœ¨ç·¨è¼¯æ–‡å­—ï¼Œä¸è¦åˆªé™¤ç‰©ä»¶
                if(activeObj && !activeObj.isEditing) deleteActiveObject();
            }
            // ç°¡å–®çš„æ¨¡å¼åˆ‡æ›å¿«æ·éµ
            if (e.key === 'v' || e.key === 'V') setMode('select');
            if (e.key === 'b' || e.key === 'B') setMode('draw');
            if (e.key === 'e' || e.key === 'E') setMode('eraser');
        });

    </script>
</body>
</html>
