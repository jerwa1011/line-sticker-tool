<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sticker Studio Air - 編輯模式</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>

    <style>
        :root {
            --bg-color: #e5e5e5;
            --panel-bg: rgba(255, 255, 255, 0.85);
            --accent-color: #007AFF;
            --danger-color: #FF3B30;
        }

        body {
            margin: 0;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            background-image: radial-gradient(#ccc 1px, transparent 1px);
            background-size: 20px 20px;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* UI 面板共用樣式 */
        .ui-panel {
            position: absolute;
            background: var(--panel-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            padding: 8px;
            z-index: 100;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        /* 頂部工具列 */
        .toolbar-top {
            top: 20px;
            height: 40px;
        }

        /* 左側工具列 */
        .toolbar-left {
            left: 20px;
            flex-direction: column;
            top: 50%;
            transform: translateY(-50%);
        }

        /* 按鈕樣式 */
        button {
            background: transparent;
            border: none;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #555;
        }
        button:hover {
            background: rgba(0,0,0,0.05);
            color: var(--accent-color);
        }
        button.active {
            background: #e0eaff;
            color: var(--accent-color);
        }
        button svg {
            width: 20px;
            height: 20px;
        }

        /* 檔案上傳隱藏 input */
        #fileInput { display: none; }

        /* 畫布容器 */
        #viewport {
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            outline: none;
        }

        /* Canvas 外框陰影與背景 */
        .canvas-container-wrapper {
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            border: 1px solid rgba(0,0,0,0.05);
            /* LINE 預覽背景色 (淺藍) */
            background-color: #849ebf; 
            transition: background-color 0.3s;
        }

        /* 提示 */
        .status-bar {
            position: absolute;
            bottom: 20px;
            right: 20px;
            font-size: 12px;
            color: #666;
            background: var(--panel-bg);
            padding: 5px 12px;
            border-radius: 20px;
            pointer-events: none;
        }
    </style>
</head>
<body>

    <input type="file" id="fileInput" accept="image/*">

    <div class="ui-panel toolbar-top">
        <span style="font-weight:700; font-size:14px; margin: 0 10px;">Sticker Studio</span>
        <div style="width:1px; height:16px; background:#ccc;"></div>
        
        <button onclick="triggerUpload()" title="上傳圖片">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg>
            <span style="font-size:12px; margin-left:5px;">匯入</span>
        </button>
        
        <button onclick="addText()" title="加入文字">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 7V4h16v3M9 20h6M12 4v16"/></svg>
            <span style="font-size:12px; margin-left:5px;">文字</span>
        </button>

        <div style="width:1px; height:16px; background:#ccc;"></div>

        <button onclick="downloadPNG()" title="匯出 PNG" style="color: var(--accent-color);">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
            <span style="font-size:12px; margin-left:5px; font-weight:600;">匯出</span>
        </button>
    </div>

    <div class="ui-panel toolbar-left">
        <button onclick="toggleBackground()" title="切換預覽背景 (黑/白/LINE)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
        </button>
        
        <button onclick="deleteObject()" title="刪除選取物件 (Del)" style="color: var(--danger-color);">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
        </button>
    </div>

    <div id="viewport">
        <div class="canvas-container-wrapper">
            <canvas id="c" width="370" height="320"></canvas>
        </div>
    </div>

    <div class="status-bar">空白鍵 + 拖曳：移動視角 • 滾輪：縮放 • Delete：刪除圖層</div>

    <script>
        // 1. 初始化 Fabric Canvas
        const canvas = new fabric.Canvas('c', {
            preserveObjectStacking: true, // 選取時保持層級順序
            backgroundColor: null // 透明背景
        });

        // 設定控制項樣式 (macOS 風格)
        fabric.Object.prototype.set({
            transparentCorners: false,
            cornerColor: '#ffffff',
            cornerStrokeColor: '#007AFF',
            borderColor: '#007AFF',
            cornerSize: 10,
            padding: 5,
            cornerStyle: 'circle',
            borderDashArray: [4, 4]
        });

        // 2. 視圖控制邏輯 (Zoom & Pan) - 移植自 Phase 2
        let isSpaceDown = false;
        let isDragging = false;
        let lastPosX, lastPosY;
        const viewport = document.getElementById('viewport');
        const wrapper = document.querySelector('.canvas-container-wrapper');
        let currentScale = 1;

        // 滾輪縮放 (CSS Transform 方式，保持 Canvas 解析度)
        viewport.addEventListener('wheel', function(opt) {
            opt.preventDefault();
            const delta = opt.deltaY * -0.001;
            currentScale = Math.min(Math.max(0.5, currentScale + delta), 4);
            updateWrapperTransform();
        }, { passive: false });

        // 空白鍵平移邏輯
        let panX = 0, panY = 0;
        
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
                isSpaceDown = true;
                viewport.style.cursor = 'grab';
                canvas.selection = false; // 暫停 Canvas 選取
            }
            if (e.key === 'Delete' || e.key === 'Backspace') {
                deleteObject();
            }
        });

        document.addEventListener('keyup', (e) => {
            if (e.code === 'Space') {
                isSpaceDown = false;
                viewport.style.cursor = 'default';
                canvas.selection = true; // 恢復 Canvas 選取
            }
        });

        viewport.addEventListener('mousedown', (e) => {
            if (isSpaceDown) {
                isDragging = true;
                viewport.style.cursor = 'grabbing';
                lastPosX = e.clientX;
                lastPosY = e.clientY;
            }
        });

        viewport.addEventListener('mousemove', (e) => {
            if (isDragging) {
                const deltaX = e.clientX - lastPosX;
                const deltaY = e.clientY - lastPosY;
                panX += deltaX;
                panY += deltaY;
                lastPosX = e.clientX;
                lastPosY = e.clientY;
                updateWrapperTransform();
            }
        });

        viewport.addEventListener('mouseup', () => { isDragging = false; });

        function updateWrapperTransform() {
            wrapper.style.transform = `translate(${panX}px, ${panY}px) scale(${currentScale})`;
        }


        // 3. 功能實作

        // 上傳圖片
        function triggerUpload() { document.getElementById('fileInput').click(); }
        
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(f) {
                fabric.Image.fromURL(f.target.result, function(img) {
                    // 自動縮放適應畫布
                    if (img.width > 300) img.scaleToWidth(300);
                    canvas.add(img);
                    canvas.centerObject(img);
                    canvas.setActiveObject(img);
                });
            };
            reader.readAsDataURL(file);
            this.value = ''; // 重置 input
        });

        // 支援拖曳上傳 (Drag & Drop)
        window.addEventListener('drop', function(e) {
            e.preventDefault();
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image')) {
                const reader = new FileReader();
                reader.onload = function(f) {
                    fabric.Image.fromURL(f.target.result, function(img) {
                        if (img.width > 300) img.scaleToWidth(300);
                        canvas.add(img);
                        canvas.centerObject(img);
                    });
                };
                reader.readAsDataURL(file);
            }
        });
        window.addEventListener('dragover', e => e.preventDefault());

        // 加入文字
        function addText() {
            const text = new fabric.IText('輸入文字', {
                left: 100,
                top: 100,
                fontFamily: 'Zen Maru Gothic', // 預設使用圓體
                fill: '#333',
                fontSize: 40
            });
            canvas.add(text);
            canvas.setActiveObject(text);
        }

        // 刪除物件
        function deleteObject() {
            const activeObjects = canvas.getActiveObjects();
            if (activeObjects.length) {
                canvas.discardActiveObject();
                activeObjects.forEach(function(object) {
                    canvas.remove(object);
                });
            }
        }

        // 切換背景預覽
        const bgColors = ['#849ebf', '#ffffff', '#1a1a1a', 'transparent']; // LINE藍, 白, 黑, 透明
        let bgIndex = 0;
        function toggleBackground() {
            bgIndex = (bgIndex + 1) % bgColors.length;
            const color = bgColors[bgIndex];
            wrapper.style.backgroundColor = color;
            if(color === 'transparent') {
                wrapper.style.backgroundImage = 'linear-gradient(45deg, #ccc 25%, transparent 25%), linear-gradient(-45deg, #ccc 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #ccc 75%), linear-gradient(-45deg, transparent 75%, #ccc 75%)';
                wrapper.style.backgroundSize = '20px 20px';
                wrapper.style.backgroundPosition = '0 0, 0 10px, 10px -10px, -10px 0px';
            } else {
                wrapper.style.backgroundImage = 'none';
            }
        }

        // 匯出 PNG
        function downloadPNG() {
            // 匯出前把背景變透明 (因為我們只是改 wrapper 背景，canvas 本身是透明的)
            // 如果使用者不小心讓圖片超出邊界，我們應該裁切
            const dataURL = canvas.toDataURL({
                format: 'png',
                quality: 1,
                multiplier: 1 // 維持原解析度
            });
            
            const link = document.createElement('a');
            link.download = 'line-sticker.png';
            link.href = dataURL;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

    </script>
</body>
</html>
