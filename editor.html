<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINE Sticker Studio V4 - å°ˆæ¥­ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;900&family=Mochiy+Pop+One&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; user-select: none; }
        .canvas-bg { 
            /* æ£‹ç›¤æ ¼èƒŒæ™¯ */
            background-image: linear-gradient(45deg, #ddd 25%, transparent 25%), linear-gradient(-45deg, #ddd 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #ddd 75%), linear-gradient(-45deg, transparent 75%, #ddd 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            background-color: #ffffff; 
        }
        .tool-btn { @apply p-2 rounded-lg border border-gray-600 hover:bg-gray-700 transition flex flex-col items-center justify-center text-xs gap-1; }
        .tool-btn.active { @apply bg-blue-600 text-white border-blue-500 shadow-lg ring-2 ring-blue-400; }
        input[type="range"] { @apply accent-blue-500 cursor-pointer; }
        /* ç¦ç”¨ç‹€æ…‹çš„æŒ‰éˆ•æ¨£å¼ */
        button:disabled { @apply opacity-50 cursor-not-allowed hover:bg-transparent; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 h-screen flex flex-col overflow-hidden">

    <header class="h-16 bg-gray-800 border-b border-gray-700 flex items-center justify-between px-4 shadow-lg z-20 shrink-0">
        <div class="flex items-center gap-3">
            <span class="text-2xl">ğŸ¨</span>
            <div>
                <h1 class="font-bold text-lg tracking-wide text-white leading-tight">è²¼åœ–å·¥åŠ V4</h1>
                <p class="text-[10px] text-gray-400">å¾©åŸ/é‡åš & ç¸®æ”¾è¦–åœ–</p>
            </div>
        </div>

        <div class="flex items-center gap-2 bg-gray-700/50 p-1 rounded-lg border border-gray-600 mx-4">
            <button onclick="undo()" id="btn-undo" disabled class="p-2 rounded hover:bg-gray-600 transition text-white" title="å¾©åŸ (Ctrl+Z)">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/></svg>
            </button>
            <button onclick="redo()" id="btn-redo" disabled class="p-2 rounded hover:bg-gray-600 transition text-white" title="é‡åš (Ctrl+Y)">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 10h-10a8 8 0 00-8 8v2M21 10l-6 6m6-6l-6-6"/></svg>
            </button>
        </div>

        <div class="flex items-center gap-2">
            <label class="cursor-pointer bg-blue-600 hover:bg-blue-500 px-3 py-2 rounded font-bold text-white transition shadow border border-blue-400 flex items-center gap-1 text-sm">
                ğŸ–¼ï¸ è¼‰åœ–
                <input type="file" id="imgLoader" accept="image/*" class="hidden">
            </label>
            <button onclick="downloadImage()" class="bg-green-600 hover:bg-green-500 text-white px-3 py-2 rounded font-bold shadow transition flex items-center gap-1 border border-green-500 text-sm">
                ğŸ“¥ è¼¸å‡º
            </button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden relative">
        
        <div class="w-20 bg-gray-800 border-r border-gray-700 flex flex-col items-center py-4 space-y-3 z-10 overflow-y-auto shrink-0">
            
            <button onclick="setMode('select')" id="btn-select" class="tool-btn active w-16 h-16" title="é¸å–ç‰©ä»¶ (V)">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"></path></svg>
                <span>é¸å–</span>
            </button>

            <button onclick="addText()" class="tool-btn w-16 h-16 text-yellow-300 border-yellow-700 hover:bg-yellow-900/30" title="æ–°å¢æ–‡å­— (T)">
                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                <span class="font-bold">åŠ æ–‡å­—</span>
            </button>

            <div class="w-10 h-[1px] bg-gray-600 my-1"></div>

            <button onclick="setMode('draw')" id="btn-draw" class="tool-btn w-16 h-16" title="æ‰‹ç¹ªç­†åˆ· (B)">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                <span>ç•«ç­†</span>
            </button>

            <button onclick="setMode('eraser')" id="btn-eraser" class="tool-btn w-16 h-16 hover:text-red-300" title="æ©¡çš®æ“¦ (E)">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                <span>æ©¡çš®æ“¦</span>
            </button>

            <div class="w-10 h-[1px] bg-gray-600 my-1"></div>

            <button onclick="startCrop()" id="btn-crop" class="tool-btn w-16 h-16" title="è£åˆ‡åœ–ç‰‡ (C)">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                <span>è£åˆ‡</span>
            </button>
        </div>

        <div class="flex-1 bg-gray-900/80 relative overflow-hidden backdrop-blur-md" id="canvas-container-div">
            
            <div id="welcome-msg" class="absolute inset-0 flex items-center justify-center pointer-events-none z-0">
                <div class="text-center text-gray-500">
                    <p class="text-6xl mb-4 animate-bounce">ğŸ–¼ï¸</p>
                    <p class="text-lg font-bold">è«‹é»é¸ä¸Šæ–¹ã€Œè¼‰å…¥åœ–ç‰‡ã€</p>
                    <p class="text-sm">æ”¯æ´ Ctrl+V è²¼ä¸Š</p>
                </div>
            </div>

            <div class="absolute inset-0 flex items-center justify-center">
                <div class="canvas-bg shadow-2xl border border-gray-600 relative z-10">
                    <canvas id="c"></canvas>
                </div>
            </div>

            <div class="absolute bottom-4 right-4 bg-gray-800/80 backdrop-blur p-2 rounded-full shadow-xl border border-gray-600 flex items-center gap-1 z-30">
                <button onclick="zoomCanvas(0.9)" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-700 transition">ğŸ”-</button>
                <button onclick="resetZoom()" class="px-2 text-xs font-bold hover:bg-gray-700 rounded transition" title="é‡ç½®ç¸®æ”¾" id="zoom-val">100%</button>
                <button onclick="zoomCanvas(1.1)" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-700 transition">ğŸ”+</button>
            </div>
            <p class="absolute bottom-4 left-4 text-xs text-gray-500 z-30">ğŸ’¡ æç¤ºï¼šæŒ‰ä½ Alt éµ + æ‹–æ›³å¯å¹³ç§»ç•«å¸ƒ</p>

            <div id="crop-controls" class="absolute bottom-20 left-1/2 -translate-x-1/2 bg-gray-800 p-3 rounded-xl shadow-2xl border border-gray-600 flex gap-3 hidden z-30">
                <div class="text-white font-bold flex items-center px-2">âœ‚ï¸ èª¿æ•´è£åˆ‡ç¯„åœ</div>
                <button onclick="applyCrop()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-1 rounded">ç¢ºèª</button>
                <button onclick="cancelCrop()" class="bg-gray-600 hover:bg-gray-500 text-white px-4 py-1 rounded">å–æ¶ˆ</button>
            </div>
        </div>

        <div class="w-72 bg-gray-800 border-l border-gray-700 flex flex-col z-20 shadow-xl shrink-0">
            <div class="p-4 border-b border-gray-700 font-bold text-gray-300 flex items-center gap-2 shrink-0">
                <span>âš™ï¸ å±¬æ€§è¨­å®š</span>
            </div>
            <div class="p-5 flex-1 overflow-y-auto space-y-6">
                <div id="panel-none" class="text-center text-gray-500 py-10">
                    <p>è«‹é»é¸ç•«å¸ƒä¸Šçš„ç‰©ä»¶</p>
                    <p>æˆ–æ˜¯é¸æ“‡å·¦å´å·¥å…·</p>
                </div>
                <div id="panel-brush" class="hidden space-y-5">
                    <h3 class="text-sm font-bold text-blue-400 uppercase tracking-wider">ç­†åˆ·/æ©¡çš®æ“¦</h3>
                    <div id="brush-color-wrap" class="space-y-2">
                        <label class="text-xs text-gray-400">ç­†åˆ·é¡è‰²</label>
                        <div class="flex gap-2">
                            <input type="color" id="draw-color" value="#000000" class="w-10 h-10 rounded border border-gray-500 cursor-pointer bg-transparent" onchange="updateBrush()">
                            <button onclick="setBrushColor('#000000')" class="w-10 h-10 bg-black rounded border border-gray-600 hover:scale-110 transition"></button>
                            <button onclick="setBrushColor('#ffffff')" class="w-10 h-10 bg-white rounded border border-gray-600 hover:scale-110 transition"></button>
                            <button onclick="setBrushColor('#ff0000')" class="w-10 h-10 bg-red-600 rounded border border-gray-600 hover:scale-110 transition"></button>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <label class="text-xs text-gray-400 flex justify-between">ç²—ç´° <span id="brush-size-val">5</span></label>
                        <input type="range" id="draw-width" min="1" max="50" value="5" class="w-full" oninput="updateBrush()">
                    </div>
                </div>
                <div id="panel-object" class="hidden space-y-6">
                    <div class="space-y-2">
                        <h3 class="text-sm font-bold text-green-400 uppercase tracking-wider">ğŸ¨ å¡«è‰²</h3>
                        <label class="text-xs text-gray-400">ä¸»é«”é¡è‰²</label>
                        <input type="color" id="obj-color" class="w-full h-10 rounded cursor-pointer border border-gray-600 bg-transparent p-1" onchange="updateObject()">
                    </div>
                    <div id="text-controls" class="hidden space-y-6 pt-4 border-t border-gray-700">
                        <h3 class="text-sm font-bold text-yellow-400 uppercase tracking-wider">T æ–‡å­—è¨­å®š</h3>
                        <div class="space-y-2">
                            <label class="text-xs text-gray-400">é¸æ“‡å­—å‹</label>
                            <select id="font-family" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-sm" onchange="updateObject()">
                                <option value="Noto Sans TC">æ€æºé»‘é«” (Web)</option>
                                <option value="Mochiy Pop One">å¯æ„›åœ“é«” (Web)</option>
                                <option value="Microsoft JhengHei">å¾®è»Ÿæ­£é»‘é«” (Win)</option>
                                <option value="PMingLiU">æ–°ç´°æ˜é«” (Win)</option>
                                <option value="DFKai-SB">æ¨™æ¥·é«” (Win)</option>
                                <option value="PingFang TC">è˜‹æ–¹é»‘é«” (Mac)</option>
                                <option value="LiHei Pro">å„·é»‘ Pro (Mac)</option>
                                <option value="custom">ğŸ‘‰ æ‰‹å‹•è¼¸å…¥...</option>
                            </select>
                            <input type="text" id="custom-font" placeholder="è¼¸å…¥é›»è…¦å…§çš„å­—å‹åç¨±..." class="hidden w-full bg-gray-900 border border-gray-600 rounded p-2 text-sm text-white placeholder-gray-500 mt-1" onchange="applyCustomFont()">
                        </div>
                        <div class="space-y-3 bg-gray-700/50 p-3 rounded-lg border border-gray-600">
                            <label class="text-xs text-white font-bold flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-white"></span>ç™½æé‚Š (Stroke)</label>
                            <div class="flex gap-2">
                                <input type="color" id="text-stroke-color" value="#ffffff" class="w-10 h-10 rounded border border-gray-500 cursor-pointer bg-transparent" onchange="updateObject()">
                                <div class="flex-1">
                                    <label class="text-[10px] text-gray-400 flex justify-between">ç²—ç´° <span id="stroke-width-val">8</span></label>
                                    <input type="range" id="text-stroke-width" min="0" max="20" value="8" step="0.5" class="w-full" oninput="updateObject()">
                                </div>
                            </div>
                        </div>
                    </div>
                    <button onclick="deleteActiveObject()" class="w-full bg-red-900/50 hover:bg-red-800 text-red-200 py-2 rounded border border-red-800 transition">
                        åˆªé™¤ç‰©ä»¶ (Del)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- è¨­å®š Fabric ---
        fabric.Object.prototype.set({
            transparentCorners: false, cornerColor: '#3b82f6', cornerStyle: 'circle', borderColor: '#3b82f6', cornerSize: 10, padding: 5,
            // é‡è¦ï¼šè®“ç‰©ä»¶çš„æ§åˆ¶é …ä¸æœƒéš¨è‘—è¦–åœ–ç¸®æ”¾è€Œè®Šå½¢å¤ªå¤§
            borderScaleFactor: 1, cornerStrokeColor: '#3b82f6' 
        });

        const canvas = new fabric.Canvas('c', {
            width: 500, height: 500, backgroundColor: null,
            preserveObjectStacking: true // ä¿æŒåœ–å±¤é †åº
        });

        let currentMode = 'select';
        let cropRect = null;

        // --- V4 æ–°å¢ï¼šæ­·å²ç´€éŒ„ç‹€æ…‹è®Šæ•¸ ---
        let undoStack = [];
        let redoStack = [];
        let isRedoing = false; // é˜²æ­¢åœ¨é‡åšæ™‚è§¸ç™¼ä¿å­˜äº‹ä»¶
        let initialState = null; // å„²å­˜åˆå§‹ç©ºç™½æˆ–å‰›è¼‰å…¥åœ–ç‰‡æ™‚çš„ç‹€æ…‹

        // --- V4 æ–°å¢ï¼šç¸®æ”¾èˆ‡å¹³ç§»è®Šæ•¸ ---
        let canvasScale = 1;
        let isDragging = false;
        let lastPosX, lastPosY;

        // =========================================
        //  V4 æ ¸å¿ƒåŠŸèƒ½ï¼šæ­·å²ç´€éŒ„ (Undo/Redo)
        // =========================================
        
        // å„²å­˜ç•¶å‰ç‹€æ…‹åˆ°å †ç–Š
        function saveState() {
            if (isRedoing) return;
            redoStack = []; // æœ‰æ–°å‹•ä½œæ™‚ï¼Œæ¸…ç©ºé‡åšå †ç–Š
            
            // å°‡ç•«å¸ƒåºåˆ—åŒ–ç‚º JSON å­—ä¸²å­˜èµ·ä¾†
            // é‡è¦ï¼šä¸å„²å­˜èƒŒæ™¯åœ–ï¼Œå› ç‚ºèƒŒæ™¯åœ–é€šå¸¸å¾ˆå¤§ä¸”ä¸æœƒè®Šï¼Œæˆ‘å€‘åªå­˜æ“ä½œ
            const json = canvas.toJSON(['selectable', 'evented', 'id']); 
            undoStack.push(json);
            updateHistoryButtons();
            console.log("State Saved. Stack size:", undoStack.length);
        }

        // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
        function updateHistoryButtons() {
            document.getElementById('btn-undo').disabled = undoStack.length === 0;
            document.getElementById('btn-redo').disabled = redoStack.length === 0;
        }

        function undo() {
            if (undoStack.length > 0) {
                isRedoing = true;
                // å°‡ç•¶å‰ç‹€æ…‹ç§»åˆ°é‡åšå †ç–Š
                const currentState = canvas.toJSON(['selectable', 'evented', 'id']);
                redoStack.push(currentState);
                
                // å–å‡ºä¸Šä¸€å€‹ç‹€æ…‹
                const state = undoStack.pop();
                loadState(state);
            }
        }

        function redo() {
            if (redoStack.length > 0) {
                isRedoing = true;
                // å°‡ç•¶å‰ç‹€æ…‹ç§»åˆ°å¾©åŸå †ç–Š
                const currentState = canvas.toJSON(['selectable', 'evented', 'id']);
                undoStack.push(currentState);

                // å–å‡ºä¸‹ä¸€å€‹ç‹€æ…‹
                const state = redoStack.pop();
                loadState(state);
            }
        }

        // è¼‰å…¥ç‹€æ…‹åˆ°ç•«å¸ƒ
        function loadState(state) {
            canvas.loadFromJSON(state, function() {
                canvas.renderAll();
                isRedoing = false;
                updateHistoryButtons();
                updatePanel(); // æ›´æ–°å±¬æ€§é¢æ¿
            });
        }

        // ç›£è½æœƒæ”¹è®Šç•«å¸ƒçš„äº‹ä»¶ä¾†è§¸ç™¼å­˜æª”
        canvas.on('object:added', saveState);
        canvas.on('object:modified', saveState);
        canvas.on('object:removed', saveState);
        // ç•«ç­†è·¯å¾‘å»ºç«‹å®Œæˆä¹Ÿè¦å­˜
        canvas.on('path:created', function(opt) {
            if (currentMode === 'eraser') {
                opt.path.globalCompositeOperation = 'destination-out';
                opt.path.selectable = false; opt.path.evented = false;
            }
            // æ³¨æ„ï¼špath:created ä¹Ÿæœƒè§¸ç™¼ object:addedï¼Œæ‰€ä»¥é€™è£¡ä¸ç”¨é‡è¤‡ saveState
        });


        // =========================================
        //  V4 æ ¸å¿ƒåŠŸèƒ½ï¼šç¸®æ”¾èˆ‡å¹³ç§» (Zoom & Pan)
        // =========================================

        // ç¸®æ”¾ç•«å¸ƒè¦–åœ–
        function zoomCanvas(factor) {
            let newScale = canvasScale * factor;
            // é™åˆ¶ç¸®æ”¾ç¯„åœ (ä¾‹å¦‚ 0.5x åˆ° 5x)
            newScale = Math.min(Math.max(newScale, 0.5), 5);
            
            canvas.setZoom(newScale);
            canvasScale = newScale;
            document.getElementById('zoom-val').innerText = Math.round(newScale * 100) + '%';
            canvas.requestRenderAll();
        }

        // é‡ç½®ç¸®æ”¾
        function resetZoom() {
            canvas.setViewportTransform([1, 0, 0, 1, 0, 0]); // å›åˆ°åˆå§‹çŸ©é™£
            canvasScale = 1;
            document.getElementById('zoom-val').innerText = '100%';
            canvas.requestRenderAll();
        }

        // å¹³ç§»åŠŸèƒ½å¯¦ä½œ (Alt + æ‹–æ›³)
        canvas.on('mouse:down', function(opt) {
            const evt = opt.e;
            if (evt.altKey === true) {
                this.isDragging = true;
                this.selection = false; // æš«æ™‚é—œé–‰æ¡†é¸
                this.lastPosX = evt.clientX;
                this.lastPosY = evt.clientY;
                this.defaultCursor = 'grab';
            }
        });

        canvas.on('mouse:move', function(opt) {
            if (this.isDragging) {
                const evt = opt.e;
                const vpt = this.viewportTransform;
                vpt[4] += evt.clientX - this.lastPosX;
                vpt[5] += evt.clientY - this.lastPosY;
                this.requestRenderAll();
                this.lastPosX = evt.clientX;
                this.lastPosY = evt.clientY;
            }
        });

        canvas.on('mouse:up', function(opt) {
            if (this.isDragging) {
                this.setViewportTransform(this.viewportTransform);
                this.isDragging = false;
                this.selection = true; // æ¢å¾©æ¡†é¸
                this.defaultCursor = 'default';
            }
        });
        
        // æ”¯æ´æ»‘é¼ æ»¾è¼ªç¸®æ”¾ (å¯é¸ï¼Œé€™è£¡å…ˆè¨»è§£æ‰ï¼Œé¿å…èˆ‡é é¢æ»¾å‹•è¡çªï¼Œç›®å‰ç”¨æŒ‰éˆ•æ¯”è¼ƒå®‰å…¨)
        /*
        canvas.on('mouse:wheel', function(opt) {
            const delta = opt.e.deltaY;
            let zoom = canvas.getZoom();
            zoom *= 0.999 ** delta;
            if (zoom > 5) zoom = 5;
            if (zoom < 0.5) zoom = 0.5;
            canvas.zoomToPoint({ x: opt.e.offsetX, y: opt.e.offsetY }, zoom);
            opt.e.preventDefault();
            opt.e.stopPropagation();
            canvasScale = zoom;
            document.getElementById('zoom-val').innerText = Math.round(zoom * 100) + '%';
        });
        */


        // =========================================
        //  ä»¥ä¸‹ç‚º V3 å³æœ‰çš„åŠŸèƒ½ (éƒ¨åˆ†å¾®èª¿ä»¥é…åˆ V4)
        // =========================================

        // --- 1. åœ–ç‰‡è¼‰å…¥ ---
        document.getElementById('imgLoader').addEventListener('change', loadFile);
        window.addEventListener('paste', (e) => {
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            for (let item of items) {
                if (item.kind === 'file') {
                    const reader = new FileReader();
                    reader.onload = (event) => loadToCanvas(event.target.result);
                    reader.readAsDataURL(item.getAsFile());
                }
            }
        });

        function loadFile(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (f) => loadToCanvas(f.target.result);
            reader.readAsDataURL(file);
        }

        function loadToCanvas(dataURL) {
            const imgObj = new Image();
            imgObj.src = dataURL;
            imgObj.onload = function() {
                // è¼‰å…¥æ–°åœ–æ™‚ï¼Œé‡ç½®æ‰€æœ‰ç‹€æ…‹
                canvas.clear();
                undoStack = [];
                redoStack = [];
                updateHistoryButtons();
                resetZoom(); // é‡ç½®ç¸®æ”¾è¦–åœ–
                document.getElementById('welcome-msg').style.display = 'none';

                // V4 ä¿®æ”¹ï¼šé™åˆ¶ Canvas çš„é¡¯ç¤ºå¤§å°ï¼Œè€Œä¸æ˜¯ç¸®æ”¾åœ–ç‰‡æœ¬èº«
                // é€™æ¨£å¤§åœ–è¼‰å…¥æ™‚ï¼Œç•«å¸ƒæœƒè®Šå¤§ï¼Œä½†è¦–çª—æœƒå‡ºç¾æ²è»¸(è¢«æˆ‘å€‘éš±è—äº†)ï¼Œ
                // ä½¿ç”¨è€…å¯ä»¥é€éç¸®æ”¾å’Œå¹³ç§»ä¾†æª¢è¦–ã€‚
                const maxDisplayDimension = 1200; // è¨­å®šä¸€å€‹åˆç†çš„ç•«å¸ƒæœ€å¤§é‚Šç•Œ
                let width = imgObj.width;
                let height = imgObj.height;

                canvas.setWidth(width);
                canvas.setHeight(height);

                const fImg = new fabric.Image(imgObj);
                canvas.setBackgroundImage(fImg, () => {
                    canvas.renderAll();
                    // V4 é‡è¦ï¼šè¼‰å…¥åº•åœ–å¾Œï¼Œå„²å­˜åˆå§‹ç‹€æ…‹ï¼Œé€™æ¨£æ‰èƒ½ Undo å›åˆ°å‰›è¼‰å…¥çš„æ¨£å­
                    initialState = canvas.toJSON(['selectable', 'evented', 'id']);
                    // å¦‚æœåœ–ç‰‡å¤ªå¤§ï¼Œè‡ªå‹•ç¸®å°è¦–åœ–ä»¥ä¾¿è§€çœ‹å…¨è²Œ
                    if (width > 800 || height > 800) {
                         const fitScale = Math.min(800/width, 800/height);
                         zoomCanvas(fitScale / canvasScale); // èª¿æ•´åˆ°é©åˆçš„å¤§å°
                    }
                }, { scaleX: 1, scaleY: 1 });
            }
        }

        // --- 2. æ¨¡å¼åˆ‡æ› ---
        function setMode(mode) {
            if(currentMode === 'crop' && mode !== 'crop') cancelCrop();
            currentMode = mode;
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            const map = { 'select': 'btn-select', 'draw': 'btn-draw', 'eraser': 'btn-eraser', 'crop': 'btn-crop' };
            if(map[mode]) document.getElementById(map[mode]).classList.add('active');

            if (mode === 'draw' || mode === 'eraser') {
                canvas.isDrawingMode = true;
                canvas.discardActiveObject();
                updateBrush();
            } else {
                canvas.isDrawingMode = false;
            }
            canvas.requestRenderAll();
            updatePanel();
        }

        // --- 3. ç•«ç­†é‚è¼¯ ---
        function setBrushColor(c) {
            document.getElementById('draw-color').value = c;
            updateBrush();
        }

        function updateBrush() {
            if (!canvas.freeDrawingBrush) return;
            const size = parseInt(document.getElementById('draw-width').value);
            document.getElementById('brush-size-val').innerText = size;
            canvas.freeDrawingBrush.width = size;
            canvas.freeDrawingBrush.strokeLineCap = 'round';
            if (currentMode === 'eraser') {
                canvas.freeDrawingBrush.color = 'rgba(0,0,0,1)'; 
                canvas.defaultCursor = 'crosshair';
                document.getElementById('brush-color-wrap').classList.add('opacity-30', 'pointer-events-none');
            } else {
                canvas.freeDrawingBrush.color = document.getElementById('draw-color').value;
                canvas.defaultCursor = 'crosshair';
                document.getElementById('brush-color-wrap').classList.remove('opacity-30', 'pointer-events-none');
            }
        }

        // --- 4. æ–‡å­—èˆ‡ç‰©ä»¶é‚è¼¯ ---
        function addText() {
            setMode('select');
            const text = new fabric.IText('è«‹è¼¸å…¥æ–‡å­—', {
                left: canvas.width / 2, top: canvas.height / 2, originX: 'center', originY: 'center',
                fontFamily: 'Noto Sans TC', fontSize: 50, fill: '#000000', stroke: '#ffffff', strokeWidth: 8, paintFirst: 'stroke', fontWeight: '900'
            });
            canvas.add(text);
            canvas.setActiveObject(text);
            // saveState æœƒè¢« object:added è§¸ç™¼ï¼Œé€™è£¡ä¸ç”¨å¯«
        }

        document.getElementById('font-family').addEventListener('change', function(e) {
            const customInput = document.getElementById('custom-font');
            if(e.target.value === 'custom') {
                customInput.classList.remove('hidden'); customInput.focus();
            } else {
                customInput.classList.add('hidden'); updateObject();
            }
        });
        function applyCustomFont() { updateObject(); }

        function updateObject() {
            const obj = canvas.getActiveObject();
            if (!obj) return;
            obj.set('fill', document.getElementById('obj-color').value);
            if (obj.type === 'i-text') {
                let fontVal = document.getElementById('font-family').value;
                if(fontVal === 'custom') fontVal = document.getElementById('custom-font').value || 'sans-serif';
                obj.set({
                    fontFamily: fontVal,
                    stroke: document.getElementById('text-stroke-color').value,
                    strokeWidth: parseFloat(document.getElementById('text-stroke-width').value)
                });
            }
            canvas.requestRenderAll();
            // saveState æœƒè¢« object:modified è§¸ç™¼
        }

        canvas.on('selection:created', updatePanelFromSelection);
        canvas.on('selection:updated', updatePanelFromSelection);
        canvas.on('selection:cleared', updatePanel);

        function updatePanelFromSelection() {
            updatePanel();
            const obj = canvas.getActiveObject();
            if (!obj) return;
            if(typeof obj.fill === 'string') document.getElementById('obj-color').value = obj.fill;
            if (obj.type === 'i-text') {
                document.getElementById('text-stroke-color').value = obj.stroke || '#ffffff';
                document.getElementById('text-stroke-width').value = obj.strokeWidth || 0;
                document.getElementById('stroke-width-val').innerText = obj.strokeWidth || 0;
                const fonts = Array.from(document.getElementById('font-family').options).map(o => o.value);
                if(fonts.includes(obj.fontFamily)) {
                    document.getElementById('font-family').value = obj.fontFamily;
                    document.getElementById('custom-font').classList.add('hidden');
                } else {
                    document.getElementById('font-family').value = 'custom';
                    document.getElementById('custom-font').classList.remove('hidden');
                    document.getElementById('custom-font').value = obj.fontFamily;
                }
            }
        }

        function updatePanel() {
            const obj = canvas.getActiveObject();
            document.getElementById('panel-none').classList.toggle('hidden', !!obj || canvas.isDrawingMode);
            document.getElementById('panel-brush').classList.toggle('hidden', !canvas.isDrawingMode);
            document.getElementById('panel-object').classList.toggle('hidden', !obj);
            const isText = obj && obj.type === 'i-text';
            document.getElementById('text-controls').classList.toggle('hidden', !isText);
        }

        function deleteActiveObject() {
            const obj = canvas.getActiveObject();
            if (obj && !obj.isEditing) {
                canvas.remove(obj);
                canvas.discardActiveObject();
                updatePanel();
                // saveState æœƒè¢« object:removed è§¸ç™¼
            }
        }

        // --- 5. è£åˆ‡èˆ‡ä¸‹è¼‰ ---
        function startCrop() {
            setMode('crop');
            document.getElementById('crop-controls').classList.remove('hidden');
            // V4: è£åˆ‡æ™‚å…ˆé‡ç½®ç¸®æ”¾ï¼Œé¿å…è¨ˆç®—éŒ¯èª¤
            resetZoom();
            cropRect = new fabric.Rect({
                fill: 'rgba(0,0,0,0.3)', stroke: '#3b82f6', strokeWidth: 2, strokeDashArray: [10, 5],
                left: 0, top: 0, width: canvas.width, height: canvas.height,
                selectable: true, hasRotatingPoint: false, lockRotation: true,
                cornerColor: 'white', cornerStrokeColor: '#3b82f6', transparentCorners: false
            });
            canvas.add(cropRect);
            canvas.setActiveObject(cropRect);
        }

        function cancelCrop() {
            if (cropRect) canvas.remove(cropRect);
            document.getElementById('crop-controls').classList.add('hidden');
            setMode('select');
        }

        function applyCrop() {
            if (!cropRect) return;
            const { left, top, width, height } = cropRect.getBoundingRect();
            cropRect.visible = false;
            // V4: è£åˆ‡æ™‚å¿½ç•¥è¦–åœ–è®Šæ›
            const url = canvas.toDataURL({ left, top, width, height, format: 'png', enableRetinaScaling: false });
            loadToCanvas(url); 
            cancelCrop();
        }

        function downloadImage() {
            canvas.discardActiveObject();
            resetZoom(); // ä¸‹è¼‰å‰é‡ç½®ç¸®æ”¾ï¼Œç¢ºä¿è¼¸å‡ºåŸå§‹å°ºå¯¸
            canvas.requestRenderAll();
            // çµ¦ç€è¦½å™¨ä¸€é»æ™‚é–“æ¸²æŸ“
            setTimeout(() => {
                const link = document.createElement('a');
                link.download = `sticker-${Date.now()}.png`;
                // multiplier: 1 ç¢ºä¿ä¸æŒ‰ç…§è¦–ç¶²è†œè¢å¹•åŠ å€è¼¸å‡ºï¼Œç¶­æŒåŸå°ºå¯¸
                link.href = canvas.toDataURL({ format: 'png', quality: 1, multiplier: 1 });
                link.click();
            }, 100);
        }

        // éµç›¤ç›£è½ (æ–°å¢ Ctrl+Z / Ctrl+Y)
        window.addEventListener('keydown', (e) => {
            if ((e.key === 'Delete' || e.key === 'Backspace')) deleteActiveObject();
            // Undo/Redo å¿«æ·éµ
            if (e.ctrlKey || e.metaKey) {
                if (e.key === 'z') { e.preventDefault(); undo(); }
                if (e.key === 'y') { e.preventDefault(); redo(); }
            }
        });

    </script>
</body>
</html>
