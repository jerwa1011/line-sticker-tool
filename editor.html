<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sticker Studio Air - 最終版</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>

    <style>
        :root {
            --bg-color: #e5e5e5;
            --panel-bg: rgba(255, 255, 255, 0.9);
            --accent-color: #007AFF;
            --danger-color: #FF3B30;
        }

        body {
            margin: 0;
            overflow: hidden;
            font-family: "Noto Sans TC", sans-serif;
            background-color: var(--bg-color);
            background-image: radial-gradient(#ccc 1px, transparent 1px);
            background-size: 20px 20px;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .ui-panel {
            position: absolute;
            background: var(--panel-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            padding: 8px;
            z-index: 100;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .toolbar-top { top: 20px; height: 44px; }
        .toolbar-left { 
            left: 20px; 
            flex-direction: column; 
            top: 50%; 
            transform: translateY(-50%); 
        }

        button {
            background: transparent;
            border: none;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            flex-direction: column; /* 讓圖示跟文字垂直排列 */
            align-items: center;
            justify-content: center;
            color: #555;
            min-width: 44px;
        }
        button:hover { background: rgba(0,0,0,0.05); color: var(--accent-color); }
        button svg { width: 20px; height: 20px; margin-bottom: 2px;}
        button span { font-size: 10px; font-weight: 500;}

        #fileInput { display: none; }

        #viewport {
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            outline: none;
        }

        .canvas-container-wrapper {
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            border: 1px solid rgba(0,0,0,0.05);
            background-color: #849ebf; 
            transition: background-color 0.3s;
        }

        /* 優化後的狀態列：加粗關鍵字 */
        .status-bar {
            position: absolute;
            bottom: 20px;
            right: 20px;
            font-size: 13px;
            color: #444;
            background: var(--panel-bg);
            padding: 8px 16px;
            border-radius: 30px;
            pointer-events: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            letter-spacing: 0.5px;
        }
        .key-tag {
            font-weight: 800;
            color: #000;
            background: rgba(0,0,0,0.06);
            padding: 2px 6px;
            border-radius: 4px;
            margin: 0 2px;
            border-bottom: 2px solid rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>

    <input type="file" id="fileInput" accept="image/*">

    <div class="ui-panel toolbar-top">
        <span style="font-weight:800; font-size:15px; margin: 0 10px; color:#333;">Sticker Air</span>
        <div style="width:1px; height:20px; background:#ddd;"></div>
        
        <button onclick="triggerUpload()" title="上傳圖片">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg>
            <span>匯入</span>
        </button>
        
        <button onclick="addText()" title="加入文字">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 7V4h16v3M9 20h6M12 4v16"/></svg>
            <span>文字</span>
        </button>

        <div style="width:1px; height:20px; background:#ddd;"></div>

        <button onclick="removeBackground()" title="去除白色背景 (Magic Wand)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
            <span>去背</span>
        </button>

        <button onclick="addStroke()" title="加入白邊 (Stroke)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10" stroke-dasharray="4 4"/></svg>
            <span>白邊</span>
        </button>

        <div style="width:1px; height:20px; background:#ddd;"></div>

        <button onclick="downloadPNG()" title="匯出 PNG" style="color: var(--accent-color);">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
            <span>匯出</span>
        </button>
    </div>

    <div class="ui-panel toolbar-left">
        <button onclick="toggleBackground()" title="切換背景">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
        </button>
        
        <button onclick="deleteObject()" title="刪除 (Del)" style="color: var(--danger-color);">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
        </button>
    </div>

    <div id="viewport">
        <div class="canvas-container-wrapper">
            <canvas id="c" width="370" height="320"></canvas>
        </div>
    </div>

    <div class="status-bar">
        <span class="key-tag">空白鍵</span> + <span class="key-tag">左鍵拖曳</span> 移動視角 • 
        <span class="key-tag">滾輪</span> 縮放 • 
        <span class="key-tag">Delete</span> 刪除物件
    </div>

    <script>
        // 初始化
        const canvas = new fabric.Canvas('c', {
            preserveObjectStacking: true,
            backgroundColor: null
        });

        // 設定控制項
        fabric.Object.prototype.set({
            transparentCorners: false,
            cornerColor: '#ffffff',
            cornerStrokeColor: '#007AFF',
            borderColor: '#007AFF',
            cornerSize: 10,
            padding: 5,
            cornerStyle: 'circle'
        });

        // === 核心功能：去背與白邊 ===

        // 1. 去背功能 (簡單版：去除白色)
        function removeBackground() {
            const activeObj = canvas.getActiveObject();
            if (!activeObj || activeObj.type !== 'image') {
                alert('請先點選一張圖片！');
                return;
            }

            // 使用 Fabric 內建濾鏡
            const filter = new fabric.Image.filters.RemoveColor({
                threshold: 0.2, // 敏感度 (0-1)，可調整以過濾灰白色
                distance: 0.5
            });

            activeObj.filters.push(filter);
            activeObj.applyFilters();
            canvas.requestRenderAll();
        }

        // 2. 白邊功能 (模擬描邊)
        function addStroke() {
            const activeObj = canvas.getActiveObject();
            if (!activeObj) {
                alert('請先點選圖片或文字！');
                return;
            }

            // 透過陰影模擬描邊 (解決 Canvas 描邊鋸齒問題)
            // 如果是文字，原生支援 stroke
            if (activeObj.type === 'i-text') {
                activeObj.set({
                    stroke: '#fff',
                    strokeWidth: 8,
                    paintFirst: 'stroke' // 讓描邊在字體後面
                });
            } else {
                // 如果是圖片，使用亮色陰影模擬光暈
                activeObj.set({
                    shadow: new fabric.Shadow({
                        color: '#ffffff',
                        blur: 0,
                        offsetX: 2,
                        offsetY: 2
                    })
                });
                // 為了達到全方位描邊，通常需要複雜的 Filter，這裡先用簡易版
                // 提示：如果要更粗的邊，建議在生成時就加好，或使用付費的 API
            }
            canvas.requestRenderAll();
        }

        // === 基礎交互邏輯 (延續上一版) ===

        let isSpaceDown = false;
        let isDragging = false;
        let lastPosX, lastPosY;
        const viewport = document.getElementById('viewport');
        const wrapper = document.querySelector('.canvas-container-wrapper');
        let currentScale = 1;
        let panX = 0, panY = 0;

        // 滾輪縮放
        viewport.addEventListener('wheel', function(opt) {
            opt.preventDefault();
            const delta = opt.deltaY * -0.001;
            currentScale = Math.min(Math.max(0.5, currentScale + delta), 4);
            updateWrapperTransform();
        }, { passive: false });

        // 按鍵監聽
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
                isSpaceDown = true;
                viewport.style.cursor = 'grab';
                canvas.selection = false;
            }
            if (e.key === 'Delete' || e.key === 'Backspace') {
                // 避免在打字時刪除物件
                if(canvas.getActiveObject() && !canvas.getActiveObject().isEditing) {
                    deleteObject();
                }
            }
        });

        document.addEventListener('keyup', (e) => {
            if (e.code === 'Space') {
                isSpaceDown = false;
                viewport.style.cursor = 'default';
                canvas.selection = true;
            }
        });

        viewport.addEventListener('mousedown', (e) => {
            if (isSpaceDown) {
                isDragging = true;
                viewport.style.cursor = 'grabbing';
                lastPosX = e.clientX;
                lastPosY = e.clientY;
            }
        });

        viewport.addEventListener('mousemove', (e) => {
            if (isDragging) {
                const deltaX = e.clientX - lastPosX;
                const deltaY = e.clientY - lastPosY;
                panX += deltaX;
                panY += deltaY;
                lastPosX = e.clientX;
                lastPosY = e.clientY;
                updateWrapperTransform();
            }
        });

        viewport.addEventListener('mouseup', () => { isDragging = false; });

        function updateWrapperTransform() {
            wrapper.style.transform = `translate(${panX}px, ${panY}px) scale(${currentScale})`;
        }

        // === 檔案處理與工具 ===

        function triggerUpload() { document.getElementById('fileInput').click(); }
        
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(f) {
                fabric.Image.fromURL(f.target.result, function(img) {
                    if (img.width > 250) img.scaleToWidth(250);
                    canvas.add(img);
                    canvas.centerObject(img);
                    canvas.setActiveObject(img);
                });
            };
            reader.readAsDataURL(file);
            this.value = '';
        });

        window.addEventListener('drop', function(e) {
            e.preventDefault();
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image')) {
                const reader = new FileReader();
                reader.onload = function(f) {
                    fabric.Image.fromURL(f.target.result, function(img) {
                        if (img.width > 250) img.scaleToWidth(250);
                        canvas.add(img);
                        canvas.centerObject(img);
                        canvas.setActiveObject(img);
                    });
                };
                reader.readAsDataURL(file);
            }
        });
        window.addEventListener('dragover', e => e.preventDefault());

        function addText() {
            const text = new fabric.IText('輸入文字', {
                left: 100, top: 100,
                fontFamily: 'Zen Maru Gothic',
                fill: '#333', fontSize: 40,
                fontWeight: '700'
            });
            canvas.add(text);
            canvas.setActiveObject(text);
        }

        function deleteObject() {
            const activeObjects = canvas.getActiveObjects();
            if (activeObjects.length) {
                canvas.discardActiveObject();
                activeObjects.forEach((obj) => canvas.remove(obj));
            }
        }

        const bgColors = ['#849ebf', '#ffffff', '#1a1a1a', 'transparent'];
        let bgIndex = 0;
        function toggleBackground() {
            bgIndex = (bgIndex + 1) % bgColors.length;
            const color = bgColors[bgIndex];
            wrapper.style.backgroundColor = color;
            if(color === 'transparent') {
                wrapper.style.backgroundImage = 'linear-gradient(45deg, #ccc 25%, transparent 25%), linear-gradient(-45deg, #ccc 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #ccc 75%), linear-gradient(-45deg, transparent 75%, #ccc 75%)';
                wrapper.style.backgroundSize = '20px 20px';
                wrapper.style.backgroundPosition = '0 0, 0 10px, 10px -10px, -10px 0px';
            } else {
                wrapper.style.backgroundImage = 'none';
            }
        }

        function downloadPNG() {
            // 確保沒有選取框被印出來
            canvas.discardActiveObject();
            canvas.requestRenderAll();
            
            setTimeout(() => {
                const dataURL = canvas.toDataURL({
                    format: 'png', quality: 1, multiplier: 1
                });
                const link = document.createElement('a');
                link.download = `sticker-${Date.now()}.png`;
                link.href = dataURL;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }, 100);
        }
    </script>
</body>
</html>

