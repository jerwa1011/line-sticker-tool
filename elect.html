<!DOCTYPE html>
<html lang="zh-TW" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINE 貼圖整理打包工具</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <style>
        /* === CSS 變數 === */
        :root {
            --bg-body: #f3f4f6;
            --bg-bar: #ffffff;
            --text-main: #1f2937;
            --text-sub: #6b7280;
            --accent: #2563eb;
            --border: #e5e7eb;
            --item-bg: #ffffff;
            
            /* 特殊狀態顏色 */
            --bg-main: #fee2e2; /* 淺紅 */
            --border-main: #ef4444;
            --bg-tab: #dcfce7; /* 淺綠 */
            --border-tab: #22c55e;
            --glow-color: rgba(37, 99, 235, 0.6);
        }

        [data-theme="dark"] {
            --bg-body: #121212;
            --bg-bar: #1e1e1e;
            --text-main: #e5e5e5;
            --text-sub: #a0a0a0;
            --accent: #3b82f6;
            --border: #333333;
            --item-bg: #252526;
            
            /* 暗黑模式下的特殊狀態 */
            --bg-main: #451a1a; 
            --border-main: #f87171;
            --bg-tab: #14532d;
            --border-tab: #4ade80;
            --glow-color: rgba(96, 165, 250, 0.7);
        }

        * { box-sizing: border-box; }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0; height: 100vh;
            display: flex; flex-direction: column; overflow: hidden;
        }

        /* === Header === */
        .app-bar {
            height: 50px; background-color: var(--bg-bar); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; padding: 0 15px; gap: 15px; flex-shrink: 0; z-index: 10;
        }
        .brand { font-weight: 700; color: #06c755; /* LINE Green */ font-size: 1rem; white-space: nowrap; }
        
        .settings-row { display: flex; flex: 1; gap: 10px; align-items: center; }
        .compact-input {
            background: var(--bg-body); border: 1px solid var(--border);
            color: var(--text-main); padding: 4px 8px; border-radius: 4px;
            font-size: 0.85rem; width: 100%; max-width: 150px;
        }
        .theme-btn { background: none; border: none; color: var(--text-sub); cursor: pointer; padding: 5px; }

        /* === Workspace === */
        .workspace { flex: 1; display: flex; padding: 10px; gap: 10px; overflow: hidden; }
        
        .pane {
            flex: 1; background-color: var(--bg-bar); border-radius: 8px;
            border: 1px solid var(--border); display: flex; flex-direction: column;
            overflow: hidden; position: relative;
        }

        .pane-header {
            height: 40px; padding: 0 10px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            background: var(--bg-bar); flex-shrink: 0;
        }
        .pane-tools button {
            background: var(--bg-body); border: 1px solid var(--border);
            color: var(--text-main); border-radius: 4px; padding: 4px 8px;
            font-size: 0.75rem; cursor: pointer; display: flex; align-items: center; gap: 4px;
        }
        .pane-tools button:hover { border-color: var(--accent); color: var(--accent); }

        .grid-area { flex: 1; overflow-y: auto; padding: 10px; position: relative; background: var(--bg-body); }
        .image-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 10px; min-height: 100%; }
        
        .empty-state {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--text-sub); pointer-events: none; z-index: 0;
        }
        .image-grid:not(:empty) + .empty-state { display: none; }

        /* === 卡片樣式 (重點修改區) === */
        .img-card {
            background: var(--item-bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            overflow: hidden;
            display: flex; flex-direction: column;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
            position: relative;
        }

        /* 藍色光暈效果 (Hover) */
        .img-card:hover {
            border-color: var(--accent);
            box-shadow: 0 0 10px var(--glow-color); /* 藍色光暈 */
            transform: translateY(-2px);
            z-index: 5;
        }

        /* Main 狀態 */
        .img-card.is-main {
            background-color: var(--bg-main);
            border: 2px solid var(--border-main);
        }
        /* Tab 狀態 */
        .img-card.is-tab {
            background-color: var(--bg-tab);
            border: 2px solid var(--border-tab);
        }

        .img-preview { aspect-ratio: 1; background: #000; position: relative; cursor: grab; }
        .img-preview img { width: 100%; height: 100%; object-fit: contain; pointer-events: none; }
        .img-preview:active { cursor: grabbing; }

        .idx-badge {
            position: absolute; top: 2px; left: 2px;
            background: rgba(0,0,0,0.6); color: white;
            font-size: 0.6rem; padding: 1px 4px; border-radius: 3px; pointer-events: none;
        }

        .card-info {
            padding: 5px; border-top: 1px solid var(--border);
            display: flex; flex-direction: column; gap: 4px;
        }
        .fname { font-size: 0.65rem; color: var(--text-sub); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: center; }
        
        /* 功能按鈕區 */
        .card-actions { display: flex; gap: 4px; justify-content: center; }
        
        .tag-btn {
            flex: 1; border: 1px solid var(--border); background: var(--bg-body);
            color: var(--text-sub); font-size: 0.65rem; border-radius: 3px;
            cursor: pointer; padding: 2px 0; font-weight: 600;
        }
        .tag-btn:hover { background: var(--border); }
        
        /* 選中狀態的按鈕樣式 */
        .is-main .btn-main { background: var(--border-main); color: white; border-color: var(--border-main); }
        .is-tab .btn-tab { background: var(--border-tab); color: white; border-color: var(--border-tab); }

        .btn-trash {
            position: absolute; top: 2px; right: 2px;
            background: rgba(0,0,0,0.5); color: #fff; border: none;
            width: 20px; height: 20px; border-radius: 50%;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 0.7rem; opacity: 0; transition: opacity 0.2s;
        }
        .img-card:hover .btn-trash { opacity: 1; }
        .btn-trash:hover { background: #ef4444; }

        /* === Footer === */
        .footer-bar {
            height: 40px; background: var(--bg-bar); border-top: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center; padding: 0 15px; flex-shrink: 0;
            font-size: 0.85rem;
        }
        .dl-btn {
            background: var(--accent); color: white; border: none; padding: 5px 20px;
            border-radius: 4px; cursor: pointer; font-weight: 500;
        }
        .dl-btn:disabled { background: var(--border); cursor: not-allowed; }

        /* Overlay */
        .progress-overlay {
            position: fixed; bottom: 50px; right: 15px; background: var(--bg-bar);
            padding: 10px; border: 1px solid var(--border); border-radius: 6px;
            width: 200px; display: none; z-index: 50; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .p-fill { height: 4px; background: var(--accent); width: 0%; transition: width 0.1s; }

        input[type="file"] { display: none; }
    </style>
</head>
<body>

    <header class="app-bar">
        <div class="brand"><i class="fa-brands fa-line"></i> LINE Sticker Maker</div>
        <div class="settings-row">
            <input type="text" id="zipNameInput" class="compact-input" placeholder="ZIP 檔名">
            <input type="text" id="renamePrefix" class="compact-input" placeholder="前綴 (Prefix)">
            <select id="paddingSelect" class="compact-input" style="width: 70px;">
                <option value="1">1位</option>
                <option value="2" selected>2位</option>
                <option value="3">3位</option>
            </select>
        </div>
        <button class="theme-btn" id="themeBtn"><i class="fa-solid fa-moon"></i></button>
    </header>

    <div class="workspace">
        <div class="pane" id="paneLeft">
            <div class="pane-header">
                <span style="font-size:0.9rem; font-weight:600">圖庫 (左) <span id="infoLeft" style="color:var(--text-sub); font-size:0.75rem;">0</span></span>
                <div class="pane-tools">
                    <button id="bFileL"><i class="fa-solid fa-plus"></i> 圖</button>
                    <button id="bFolderL"><i class="fa-solid fa-folder-plus"></i> 資料夾</button>
                    <button onclick="clearPane('left')"><i class="fa-solid fa-trash"></i></button>
                </div>
                <input type="file" id="iFileL" multiple accept="image/*">
                <input type="file" id="iFolderL" webkitdirectory mozdirectory>
            </div>
            <div class="grid-area">
                <div class="image-grid" id="gridLeft"></div>
                <div class="empty-state" id="emptyLeft"><i class="fa-solid fa-images"></i><p>拖曳圖片至此</p></div>
            </div>
        </div>

        <div class="pane" id="paneRight">
            <div class="pane-header">
                <span style="font-size:0.9rem; font-weight:600; color:var(--accent)">選定 (右) <span id="infoRight" style="color:var(--text-sub); font-size:0.75rem;">0</span></span>
                <div class="pane-tools">
                    <button id="bFileR"><i class="fa-solid fa-plus"></i> 圖</button>
                    <button id="bFolderR"><i class="fa-solid fa-folder-plus"></i> 資料夾</button>
                    <button onclick="clearPane('right')"><i class="fa-solid fa-trash"></i></button>
                </div>
                <input type="file" id="iFileR" multiple accept="image/*">
                <input type="file" id="iFolderR" webkitdirectory mozdirectory>
            </div>
            <div class="grid-area">
                <div class="image-grid" id="gridRight"></div>
                <div class="empty-state" id="emptyRight"><i class="fa-solid fa-star"></i><p>拖曳圖片至此</p></div>
            </div>
        </div>
    </div>

    <footer class="footer-bar">
        <div id="footerInfo">總計: 0 張</div>
        <button class="dl-btn" id="dlBtn" disabled><i class="fa-solid fa-file-export"></i> 打包 LINE 貼圖</button>
    </footer>

    <div class="progress-overlay" id="progPopup">
        <div style="background:#eee; height:4px; border-radius:2px; overflow:hidden"><div class="p-fill" id="progFill"></div></div>
        <div style="text-align:right; font-size:0.7rem; margin-top:4px;" id="progText">處理中...</div>
    </div>

<script>
    // === 狀態管理 ===
    let fileStorage = {};
    let currentMainId = null; // 記錄誰是 Main
    let currentTabId = null;  // 記錄誰是 Tab

    // DOM 簡寫
    const $ = (id) => document.getElementById(id);
    const dom = {
        left: { grid: $('gridLeft'), empty: $('emptyLeft'), info: $('infoLeft'), iFile: $('iFileL'), iFolder: $('iFolderL'), bFile: $('bFileL'), bFolder: $('bFolderL') },
        right: { grid: $('gridRight'), empty: $('emptyRight'), info: $('infoRight'), iFile: $('iFileR'), iFolder: $('iFolderR'), bFile: $('bFileR'), bFolder: $('bFolderR') },
        sets: { zip: $('zipNameInput'), pre: $('renamePrefix'), pad: $('paddingSelect') },
        dl: $('dlBtn'), prog: { box: $('progPopup'), fill: $('progFill'), txt: $('progText') }
    };

    // 初始化
    const now = new Date();
    dom.sets.zip.placeholder = `LINE_Stickers_${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}.zip`;

    // === 主題 ===
    const themeBtn = $('themeBtn');
    function toggleTheme() {
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        document.documentElement.setAttribute('data-theme', isDark ? 'light' : 'dark');
    }
    themeBtn.addEventListener('click', toggleTheme);

    // === 事件綁定 ===
    function setupPane(side) {
        const d = dom[side];
        d.bFile.onclick = () => d.iFile.click();
        d.bFolder.onclick = () => d.iFolder.click();
        d.iFile.onchange = e => handleFiles(e.target.files, side);
        d.iFolder.onchange = e => handleFiles(e.target.files, side);

        const grid = d.grid.parentElement;
        grid.ondragover = e => { e.preventDefault(); };
        grid.ondrop = e => {
            e.preventDefault();
            if(e.dataTransfer.items) scanItems(e.dataTransfer.items, side);
        };
    }
    setupPane('left');
    setupPane('right');

    // Sortable
    const sortConf = { group: 'shared', animation: 150, handle: '.img-preview', onEnd: () => { updateUI('left'); updateUI('right'); } };
    new Sortable(dom.left.grid, sortConf);
    new Sortable(dom.right.grid, sortConf);

    // === 檔案處理 ===
    function handleFiles(files, side) {
        Array.from(files).forEach(f => addCard(f, side));
        updateUI(side);
        dom[side].iFile.value = ''; dom[side].iFolder.value = '';
    }

    async function scanItems(items, side) {
        const promises = [];
        for (let i=0; i<items.length; i++) {
            const entry = items[i].webkitGetAsEntry ? items[i].webkitGetAsEntry() : null;
            if (entry) promises.push(traverse(entry, side));
            else if (items[i].kind === 'file') {
                const f = items[i].getAsFile();
                if(f) addCard(f, side);
            }
        }
        await Promise.all(promises);
        updateUI(side);
    }

    function traverse(entry, side) {
        return new Promise(resolve => {
            if(entry.isFile) entry.file(f => { addCard(f, side); resolve(); });
            else if(entry.isDirectory) {
                const reader = entry.createReader();
                const read = () => reader.readEntries(async entries => {
                    if(entries.length===0) resolve();
                    else { await Promise.all(entries.map(e => traverse(e, side))); read(); }
                });
                read();
            } else resolve();
        });
    }

    // === 新增卡片 (含 Main/Tab 按鈕) ===
    function addCard(file, side) {
        if(!file.type.startsWith('image/')) return;
        const id = Date.now() + Math.random().toString(36).substr(2, 9);
        fileStorage[id] = file;

        const div = document.createElement('div');
        div.className = 'img-card';
        div.dataset.id = id;
        div.innerHTML = `
            <button class="btn-trash" onclick="removeCard(this)"><i class="fa-solid fa-xmark"></i></button>
            <div class="img-preview">
                <span class="idx-badge">0</span>
                <img src="${URL.createObjectURL(file)}" loading="lazy">
            </div>
            <div class="card-info">
                <div class="fname" title="${file.name}">${file.name}</div>
                <div class="card-actions">
                    <button class="tag-btn btn-main" onclick="toggleSpecial('${id}', 'main')">Main</button>
                    <button class="tag-btn btn-tab" onclick="toggleSpecial('${id}', 'tab')">Tab</button>
                </div>
            </div>
        `;
        dom[side].grid.appendChild(div);
    }

    // === 核心邏輯：設定 Main/Tab ===
    window.toggleSpecial = function(id, type) {
        const card = document.querySelector(`.img-card[data-id="${id}"]`);
        if (!card) return;

        // 如果點選 Main
        if (type === 'main') {
            if (currentMainId === id) {
                // 如果已經是 Main，則取消
                currentMainId = null;
                card.classList.remove('is-main');
            } else {
                // 如果是新的 Main
                // 1. 先清除舊的 Main (如果存在)
                if (currentMainId) {
                    const old = document.querySelector(`.img-card[data-id="${currentMainId}"]`);
                    if (old) old.classList.remove('is-main');
                }
                // 2. 如果這張卡原本是 Tab，要取消 Tab
                if (currentTabId === id) {
                    currentTabId = null;
                    card.classList.remove('is-tab');
                }
                // 3. 設定新的 Main
                currentMainId = id;
                card.classList.add('is-main');
            }
        }

        // 如果點選 Tab
        if (type === 'tab') {
            if (currentTabId === id) {
                // 取消
                currentTabId = null;
                card.classList.remove('is-tab');
            } else {
                // 設定新 Tab
                if (currentTabId) {
                    const old = document.querySelector(`.img-card[data-id="${currentTabId}"]`);
                    if (old) old.classList.remove('is-tab');
                }
                // 如果這張卡原本是 Main，要取消 Main
                if (currentMainId === id) {
                    currentMainId = null;
                    card.classList.remove('is-main');
                }
                currentTabId = id;
                card.classList.add('is-tab');
            }
        }
        updateUI(null); // 更新計數
    };

    window.removeCard = function(btn) {
        const card = btn.closest('.img-card');
        const id = card.dataset.id;
        
        // 清除特殊狀態
        if (currentMainId === id) currentMainId = null;
        if (currentTabId === id) currentTabId = null;
        
        delete fileStorage[id];
        card.remove();
        updateUI('left'); updateUI('right');
    };

    window.clearPane = function(side) {
        const cards = dom[side].grid.children;
        Array.from(cards).forEach(c => {
            const id = c.dataset.id;
            if(currentMainId === id) currentMainId = null;
            if(currentTabId === id) currentTabId = null;
            // 這裡不刪除 storage，簡單處理
        });
        dom[side].grid.innerHTML = '';
        updateUI(side);
    };

    function updateUI(side) {
        // 更新顯示與數量 (兩邊一起更新編號，但排除 Main/Tab)
        const leftCards = Array.from(dom.left.grid.children);
        const rightCards = Array.from(dom.right.grid.children);
        const all = [...leftCards, ...rightCards];

        // 重新編流水號 (跳過 Main 和 Tab)
        let counter = 1;
        all.forEach(el => {
            const id = el.dataset.id;
            const badge = el.querySelector('.idx-badge');
            
            if (id === currentMainId) {
                badge.textContent = "M";
                badge.style.background = "#ef4444";
            } else if (id === currentTabId) {
                badge.textContent = "T";
                badge.style.background = "#22c55e";
            } else {
                badge.textContent = counter++;
                badge.style.background = "rgba(0,0,0,0.6)";
            }
        });

        // 更新各欄位計數
        if(side) {
            dom[side].empty.style.display = dom[side].grid.children.length ? 'none' : 'flex';
            dom[side].info.textContent = dom[side].grid.children.length;
        } else {
            // update both empty states if side is null
            dom.left.empty.style.display = dom.left.grid.children.length ? 'none' : 'flex';
            dom.right.empty.style.display = dom.right.grid.children.length ? 'none' : 'flex';
        }

        $('footerInfo').textContent = `總計: ${all.length} 張`;
        dom.dl.disabled = all.length === 0;
    }

    // === 圖片縮放工具 ===
    function resizeImage(file, w, h) {
        return new Promise(resolve => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = w; canvas.height = h;
                const ctx = canvas.getContext('2d');
                // 使用高品質縮放
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';
                ctx.drawImage(img, 0, 0, w, h);
                canvas.toBlob(blob => resolve(blob), 'image/png');
            };
            img.src = URL.createObjectURL(file);
        });
    }

    // === 打包下載 ===
    dom.dl.onclick = async () => {
        const leftCards = Array.from(dom.left.grid.children);
        const rightCards = Array.from(dom.right.grid.children);
        const all = [...leftCards, ...rightCards];

        if(all.length === 0) return;

        dom.dl.disabled = true;
        dom.prog.box.style.display = 'block';

        const zip = new JSZip();
        const pre = dom.sets.pre.value.trim();
        const pad = parseInt(dom.sets.pad.value);
        
        let counter = 1;

        // 批次處理
        for (let i = 0; i < all.length; i++) {
            const id = all[i].dataset.id;
            const file = fileStorage[id];
            if(!file) continue;

            // 更新進度
            const pct = Math.round(((i) / all.length) * 100);
            dom.prog.fill.style.width = pct + '%';
            dom.prog.txt.textContent = `處理中 ${pct}%`;

            if (id === currentMainId) {
                // 處理 Main: 轉 240x240, 命名 main.png
                const resizedBlob = await resizeImage(file, 240, 240);
                zip.file("main.png", resizedBlob);
            } else if (id === currentTabId) {
                // 處理 Tab: 轉 96x74, 命名 tab.png
                const resizedBlob = await resizeImage(file, 96, 74);
                zip.file("tab.png", resizedBlob);
            } else {
                // 一般圖片：編流水號
                let name = file.name;
                const ext = name.substring(name.lastIndexOf('.'));
                
                // 強制加上流水號，除非使用者完全沒設前綴且想保留原名(但LINE通常要編號)
                // 這裡採用: 若有前綴用前綴，若無前綴用 "sticker_01" 格式，或直接 01.png
                let finalName = "";
                const numStr = counter.toString().padStart(pad, '0');
                
                if (pre) {
                    finalName = `${pre}_${numStr}${ext}`;
                } else {
                    // LINE 預設通常是 01.png, 02.png
                    finalName = `${numStr}${ext}`;
                }
                
                zip.file(finalName, file);
                counter++;
            }
        }

        dom.prog.txt.textContent = "正在壓縮...";
        zip.generateAsync({type:"blob"}).then(blob => {
            let zName = dom.sets.zip.value.trim() || dom.sets.zip.placeholder;
            if(!zName.toLowerCase().endsWith('.zip')) zName += '.zip';
            saveAs(blob, zName);
            
            setTimeout(() => {
                dom.prog.box.style.display = 'none';
                dom.dl.disabled = false;
                dom.prog.fill.style.width = '0%';
            }, 1000);
        });
    };
</script>
</body>
</html>
