<!DOCTYPE html>
<html lang="zh-TW" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINE 貼圖整理打包工具 (Fix版)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <style>
        /* === CSS 變數 === */
        :root {
            --bg-body: #f3f4f6;
            --bg-bar: #ffffff;
            --text-main: #1f2937;
            --text-sub: #6b7280;
            --accent: #2563eb;
            --border: #e5e7eb;
            --item-bg: #ffffff;
            
            /* 狀態色 */
            --bg-main: #fee2e2;
            --border-main: #ef4444;
            --bg-tab: #dcfce7;
            --border-tab: #22c55e;
            --glow-color: rgba(37, 99, 235, 0.6);
        }

        [data-theme="dark"] {
            --bg-body: #121212;
            --bg-bar: #1e1e1e;
            --text-main: #e5e5e5;
            --text-sub: #a0a0a0;
            --accent: #3b82f6;
            --border: #333333;
            --item-bg: #252526;
            
            --bg-main: #451a1a; 
            --border-main: #f87171;
            --bg-tab: #14532d;
            --border-tab: #4ade80;
            --glow-color: rgba(96, 165, 250, 0.7);
        }

        * { box-sizing: border-box; }
        
        body {
            font-family: 'Inter', sans-serif; background-color: var(--bg-body);
            color: var(--text-main); margin: 0; height: 100vh;
            display: flex; flex-direction: column; overflow: hidden;
        }

        /* === Header === */
        .app-bar {
            height: 50px; background-color: var(--bg-bar); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; padding: 0 15px; gap: 15px; flex-shrink: 0; z-index: 10;
        }
        .brand { font-weight: 700; color: #06c755; font-size: 1rem; white-space: nowrap; }
        .settings-row { display: flex; flex: 1; gap: 10px; align-items: center; overflow: hidden; }
        .compact-input {
            background: var(--bg-body); border: 1px solid var(--border);
            color: var(--text-main); padding: 4px 8px; border-radius: 4px;
            font-size: 0.85rem; width: 100%; max-width: 140px;
        }
        .theme-btn { background: none; border: none; color: var(--text-sub); cursor: pointer; padding: 5px; font-size: 1rem; }

        /* === Workspace === */
        .workspace { flex: 1; display: flex; padding: 10px; gap: 10px; overflow: hidden; }
        
        .pane {
            flex: 1; background-color: var(--bg-bar); border-radius: 8px;
            border: 1px solid var(--border); display: flex; flex-direction: column;
            overflow: hidden; position: relative;
        }

        /* 修復版面擠壓問題 */
        .pane-header {
            height: 44px; padding: 0 8px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            background: var(--bg-bar); flex-shrink: 0; flex-wrap: nowrap; /* 禁止換行 */
            gap: 10px;
        }
        .pane-title { 
            font-weight: 600; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            display: flex; align-items: center;
        }
        
        .pane-tools { display: flex; gap: 5px; flex-shrink: 0; }
        .tool-btn {
            background: var(--bg-body); border: 1px solid var(--border);
            color: var(--text-main); border-radius: 4px; padding: 5px 10px;
            font-size: 0.75rem; cursor: pointer; display: flex; align-items: center; gap: 5px;
            white-space: nowrap; transition: all 0.2s;
        }
        .tool-btn:hover { border-color: var(--accent); color: var(--accent); background: var(--item-bg); }
        .btn-trash-all { color: #ef4444; }
        .btn-trash-all:hover { background: #fee2e2; border-color: #ef4444; }

        /* 網格區 */
        .grid-area { flex: 1; overflow-y: auto; padding: 10px; position: relative; background: var(--bg-body); }
        .image-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(115px, 1fr)); gap: 12px; min-height: 100%; padding-bottom: 40px;}
        
        .empty-state {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--text-sub); pointer-events: none;
        }
        .image-grid:not(:empty) + .empty-state { display: none; }

        /* === 卡片樣式 === */
        .img-card {
            background: var(--item-bg); border: 1px solid var(--border); border-radius: 6px;
            overflow: hidden; display: flex; flex-direction: column;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1); position: relative;
            transition: transform 0.15s, box-shadow 0.15s;
        }

        /* 藍色光暈 */
        .img-card:hover {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px var(--glow-color); /* 使用 outline 效果更佳 */
            transform: translateY(-2px); z-index: 10;
        }

        /* 狀態顏色邏輯 */
        .img-card.is-main { background-color: var(--bg-main); border: 1px solid var(--border-main); }
        .img-card.is-tab { background-color: var(--bg-tab); border: 1px solid var(--border-tab); }
        
        /* 雙重狀態：漸層背景 */
        .img-card.is-main.is-tab {
            background: linear-gradient(135deg, var(--bg-main) 0%, var(--bg-tab) 100%);
            border: 1px solid var(--accent);
        }

        .img-preview { aspect-ratio: 1; background: #000; position: relative; cursor: grab; }
        .img-preview img { width: 100%; height: 100%; object-fit: contain; pointer-events: none; }
        .img-preview:active { cursor: grabbing; }

        .idx-badge {
            position: absolute; top: 3px; left: 3px;
            background: rgba(0,0,0,0.6); color: white;
            font-size: 0.65rem; padding: 1px 5px; border-radius: 3px; pointer-events: none; font-family: monospace;
        }

        .card-info { padding: 6px; border-top: 1px solid var(--border); display: flex; flex-direction: column; gap: 5px; }
        .fname { font-size: 0.7rem; color: var(--text-sub); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: center; }
        
        .card-actions { display: flex; gap: 4px; }
        .tag-btn {
            flex: 1; border: 1px solid var(--border); background: var(--bg-body);
            color: var(--text-sub); font-size: 0.65rem; border-radius: 3px;
            cursor: pointer; padding: 3px 0; font-weight: 600; transition: all 0.1s;
        }
        .tag-btn:hover { background: var(--border); color: var(--text-main); }

        /* 選中按鈕樣式 */
        .is-main .btn-main { background: var(--border-main); color: white; border-color: var(--border-main); }
        .is-tab .btn-tab { background: var(--border-tab); color: white; border-color: var(--border-tab); }
        
        /* 雙選時按鈕仍然保持各自顏色 */
        .is-main.is-tab .btn-main { background: #ef4444; }
        .is-main.is-tab .btn-tab { background: #22c55e; }

        /* 刪除按鈕 (修復：移到最上層) */
        .card-delete {
            position: absolute; top: 3px; right: 3px;
            width: 24px; height: 24px; border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            color: #ef4444; border: 1px solid #ef4444;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 20; /* 確保在最上層 */
            opacity: 0.8; transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .card-delete:hover { transform: scale(1.1); opacity: 1; background: #ef4444; color: white; }

        /* === Footer === */
        .footer-bar {
            height: 40px; background: var(--bg-bar); border-top: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center; padding: 0 15px; flex-shrink: 0;
            font-size: 0.85rem;
        }
        .dl-btn {
            background: var(--accent); color: white; border: none; padding: 6px 20px;
            border-radius: 4px; cursor: pointer; font-weight: 500;
        }
        .dl-btn:disabled { background: var(--border); cursor: not-allowed; }

        .progress-overlay {
            position: fixed; bottom: 50px; right: 15px; background: var(--bg-bar);
            padding: 10px; border: 1px solid var(--border); border-radius: 6px;
            width: 220px; display: none; z-index: 50; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .p-fill { height: 4px; background: var(--accent); width: 0%; transition: width 0.1s; }

        /* RWD: 當螢幕小的時候隱藏按鈕文字 */
        @media (max-width: 600px) {
            .tool-btn span { display: none; }
            .brand span { display: none; }
        }
        input[type="file"] { display: none; }
    </style>
</head>
<body>

    <header class="app-bar">
        <div class="brand"><i class="fa-brands fa-line"></i> <span>LINE Sticker Maker</span></div>
        <div class="settings-row">
            <input type="text" id="zipNameInput" class="compact-input" placeholder="ZIP檔名">
            <input type="text" id="renamePrefix" class="compact-input" placeholder="前綴 (選填)">
            <select id="paddingSelect" class="compact-input" style="width: 60px;">
                <option value="1">1位</option>
                <option value="2" selected>2位</option>
            </select>
        </div>
        <button class="theme-btn" id="themeBtn"><i class="fa-solid fa-moon"></i></button>
    </header>

    <div class="workspace">
        <div class="pane" id="paneLeft">
            <div class="pane-header">
                <div class="pane-title">圖庫 (左) <span id="infoLeft" style="color:var(--text-sub); font-size:0.8rem; margin-left:5px">0</span></div>
                <div class="pane-tools">
                    <button class="tool-btn" id="bFileL"><i class="fa-solid fa-plus"></i> <span>選圖</span></button>
                    <button class="tool-btn" id="bFolderL"><i class="fa-solid fa-folder-plus"></i> <span>資料夾</span></button>
                    <button class="tool-btn btn-trash-all" onclick="clearPane('left')"><i class="fa-solid fa-trash"></i></button>
                </div>
                <input type="file" id="iFileL" multiple accept="image/*">
                <input type="file" id="iFolderL" webkitdirectory mozdirectory>
            </div>
            <div class="grid-area">
                <div class="image-grid" id="gridLeft"></div>
                <div class="empty-state" id="emptyLeft"><i class="fa-regular fa-images" style="font-size:2rem; margin-bottom:10px"></i><p>拖曳檔案至此</p></div>
            </div>
        </div>

        <div class="pane" id="paneRight">
            <div class="pane-header">
                <div class="pane-title" style="color:var(--accent)">選定 (右) <span id="infoRight" style="color:var(--text-sub); font-size:0.8rem; margin-left:5px">0</span></div>
                <div class="pane-tools">
                    <button class="tool-btn" id="bFileR"><i class="fa-solid fa-plus"></i> <span>選圖</span></button>
                    <button class="tool-btn" id="bFolderR"><i class="fa-solid fa-folder-plus"></i> <span>資料夾</span></button>
                    <button class="tool-btn btn-trash-all" onclick="clearPane('right')"><i class="fa-solid fa-trash"></i></button>
                </div>
                <input type="file" id="iFileR" multiple accept="image/*">
                <input type="file" id="iFolderR" webkitdirectory mozdirectory>
            </div>
            <div class="grid-area">
                <div class="image-grid" id="gridRight"></div>
                <div class="empty-state" id="emptyRight"><i class="fa-regular fa-star" style="font-size:2rem; margin-bottom:10px"></i><p>拖曳檔案至此</p></div>
            </div>
        </div>
    </div>

    <footer class="footer-bar">
        <div id="footerInfo">總計: 0 張</div>
        <button class="dl-btn" id="dlBtn" disabled><i class="fa-solid fa-file-export"></i> 打包下載</button>
    </footer>

    <div class="progress-overlay" id="progPopup">
        <div style="background:#eee; height:4px; border-radius:2px; overflow:hidden"><div class="p-fill" id="progFill"></div></div>
        <div style="text-align:right; font-size:0.75rem; margin-top:5px; color:var(--text-main);" id="progText">準備中...</div>
    </div>

<script>
    // === 1. 狀態管理 ===
    let fileStorage = {};
    let currentMainId = null; 
    let currentTabId = null;

    const $ = (id) => document.getElementById(id);
    const dom = {
        left: { grid: $('gridLeft'), empty: $('emptyLeft'), info: $('infoLeft'), iFile: $('iFileL'), iFolder: $('iFolderL'), bFile: $('bFileL'), bFolder: $('bFolderL') },
        right: { grid: $('gridRight'), empty: $('emptyRight'), info: $('infoRight'), iFile: $('iFileR'), iFolder: $('iFolderR'), bFile: $('bFileR'), bFolder: $('bFolderR') },
        sets: { zip: $('zipNameInput'), pre: $('renamePrefix'), pad: $('paddingSelect') },
        dl: $('dlBtn'), prog: { box: $('progPopup'), fill: $('progFill'), txt: $('progText') }
    };

    // 初始化
    const now = new Date();
    dom.sets.zip.placeholder = `Stickers_${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}.zip`;

    // === 主題切換 ===
    const themeBtn = $('themeBtn');
    function toggleTheme() {
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        document.documentElement.setAttribute('data-theme', isDark ? 'light' : 'dark');
        themeBtn.innerHTML = isDark ? '<i class="fa-solid fa-moon"></i>' : '<i class="fa-solid fa-sun"></i>';
    }
    themeBtn.addEventListener('click', toggleTheme);

    // === 事件綁定 (Fix layout 擠壓: 改用 Flex nowrap) ===
    function setupPane(side) {
        const d = dom[side];
        d.bFile.onclick = () => d.iFile.click();
        d.bFolder.onclick = () => d.iFolder.click();
        d.iFile.onchange = e => handleFiles(e.target.files, side);
        d.iFolder.onchange = e => handleFiles(e.target.files, side);

        const grid = d.grid.parentElement; // grid-area
        grid.ondragover = e => { e.preventDefault(); };
        grid.ondrop = e => {
            e.preventDefault();
            if(e.dataTransfer.items) scanItems(e.dataTransfer.items, side);
        };
    }
    setupPane('left');
    setupPane('right');

    // Sortable
    const sortConf = { group: 'shared', animation: 150, handle: '.img-preview', onEnd: () => { updateUI('left'); updateUI('right'); } };
    new Sortable(dom.left.grid, sortConf);
    new Sortable(dom.right.grid, sortConf);

    // === 檔案處理 ===
    function handleFiles(files, side) {
        Array.from(files).forEach(f => addCard(f, side));
        updateUI(side);
        dom[side].iFile.value = ''; dom[side].iFolder.value = '';
    }

    async function scanItems(items, side) {
        const promises = [];
        for (let i=0; i<items.length; i++) {
            const entry = items[i].webkitGetAsEntry ? items[i].webkitGetAsEntry() : null;
            if (entry) promises.push(traverse(entry, side));
            else if (items[i].kind === 'file') {
                const f = items[i].getAsFile();
                if(f) addCard(f, side);
            }
        }
        await Promise.all(promises);
        updateUI(side);
    }

    function traverse(entry, side) {
        return new Promise(resolve => {
            if(entry.isFile) entry.file(f => { addCard(f, side); resolve(); });
            else if(entry.isDirectory) {
                const reader = entry.createReader();
                const read = () => reader.readEntries(async entries => {
                    if(entries.length===0) resolve();
                    else { await Promise.all(entries.map(e => traverse(e, side))); read(); }
                });
                read();
            } else resolve();
        });
    }

    // === 新增卡片 ===
    function addCard(file, side) {
        if(!file.type.startsWith('image/')) return;
        const id = Date.now() + Math.random().toString(36).substr(2, 9);
        fileStorage[id] = file;

        const div = document.createElement('div');
        div.className = 'img-card';
        div.dataset.id = id;
        
        // 刪除按鈕修復：獨立在最上層
        div.innerHTML = `
            <button class="card-delete" onclick="removeCard(this)" title="刪除"><i class="fa-solid fa-xmark"></i></button>
            <div class="img-preview">
                <span class="idx-badge">0</span>
                <img src="${URL.createObjectURL(file)}" loading="lazy">
            </div>
            <div class="card-info">
                <div class="fname" title="${file.name}">${file.name}</div>
                <div class="card-actions">
                    <button class="tag-btn btn-main" onclick="toggleSpecial('${id}', 'main')">Main</button>
                    <button class="tag-btn btn-tab" onclick="toggleSpecial('${id}', 'tab')">Tab</button>
                </div>
            </div>
        `;
        dom[side].grid.appendChild(div);
    }

    // === Main/Tab 邏輯 (允許共存) ===
    window.toggleSpecial = function(id, type) {
        const card = document.querySelector(`.img-card[data-id="${id}"]`);
        if (!card) return;

        if (type === 'main') {
            if (currentMainId === id) {
                // 取消 Main
                currentMainId = null;
                card.classList.remove('is-main');
            } else {
                // 設定新 Main
                if (currentMainId) {
                    const old = document.querySelector(`.img-card[data-id="${currentMainId}"]`);
                    if (old) old.classList.remove('is-main');
                }
                currentMainId = id;
                card.classList.add('is-main');
            }
        }

        if (type === 'tab') {
            if (currentTabId === id) {
                // 取消 Tab
                currentTabId = null;
                card.classList.remove('is-tab');
            } else {
                // 設定新 Tab
                if (currentTabId) {
                    const old = document.querySelector(`.img-card[data-id="${currentTabId}"]`);
                    if (old) old.classList.remove('is-tab');
                }
                currentTabId = id;
                card.classList.add('is-tab');
            }
        }
        updateUI(null);
    };

    window.removeCard = function(btn) {
        const card = btn.closest('.img-card');
        const id = card.dataset.id;
        
        if (currentMainId === id) currentMainId = null;
        if (currentTabId === id) currentTabId = null;
        
        delete fileStorage[id];
        card.remove();
        updateUI('left'); updateUI('right');
    };

    window.clearPane = function(side) {
        const cards = dom[side].grid.children;
        Array.from(cards).forEach(c => {
            const id = c.dataset.id;
            if(currentMainId === id) currentMainId = null;
            if(currentTabId === id) currentTabId = null;
        });
        dom[side].grid.innerHTML = '';
        updateUI(side);
    };

    function updateUI(side) {
        const leftCards = Array.from(dom.left.grid.children);
        const rightCards = Array.from(dom.right.grid.children);
        const all = [...leftCards, ...rightCards];

        // 更新編號與顯示
        all.forEach((el, idx) => {
            const id = el.dataset.id;
            const badge = el.querySelector('.idx-badge');
            
            // 標記邏輯：如果被選為 M 或 T，徽章顯示文字，但依然保留流水號的概念(因為檔案還是會產出)
            let labels = [];
            if(id === currentMainId) labels.push("M");
            if(id === currentTabId) labels.push("T");
            
            if(labels.length > 0) {
                badge.textContent = (idx+1) + " (" + labels.join("+") + ")";
                badge.style.background = id === currentMainId && id === currentTabId 
                    ? "linear-gradient(90deg, #ef4444, #22c55e)" 
                    : (id === currentMainId ? "#ef4444" : "#22c55e");
            } else {
                badge.textContent = idx + 1;
                badge.style.background = "rgba(0,0,0,0.6)";
            }
        });

        // Pane specific updates
        if(side) {
            dom[side].empty.style.display = dom[side].grid.children.length ? 'none' : 'flex';
            dom[side].info.textContent = dom[side].grid.children.length;
        } else {
            dom.left.empty.style.display = dom.left.grid.children.length ? 'none' : 'flex';
            dom.right.empty.style.display = dom.right.grid.children.length ? 'none' : 'flex';
            dom.left.info.textContent = dom.left.grid.children.length;
            dom.right.info.textContent = dom.right.grid.children.length;
        }

        $('footerInfo').textContent = `總計: ${all.length} 張`;
        dom.dl.disabled = all.length === 0;
    }

    // === 圖片縮放 (High Quality) ===
    function resizeImage(file, w, h) {
        return new Promise(resolve => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = w; canvas.height = h;
                const ctx = canvas.getContext('2d');
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';
                ctx.drawImage(img, 0, 0, w, h);
                canvas.toBlob(blob => resolve(blob), 'image/png');
            };
            img.src = URL.createObjectURL(file);
        });
    }

    // === 下載邏輯 (保留原圖 + 複製 Main/Tab) ===
    dom.dl.onclick = async () => {
        const leftCards = Array.from(dom.left.grid.children);
        const rightCards = Array.from(dom.right.grid.children);
        const all = [...leftCards, ...rightCards];

        if(all.length === 0) return;
        dom.dl.disabled = true;
        dom.prog.box.style.display = 'block';

        const zip = new JSZip();
        const pre = dom.sets.pre.value.trim();
        const pad = parseInt(dom.sets.pad.value);
        
        // 1. 先處理標準序列 (所有圖片都保留)
        for (let i = 0; i < all.length; i++) {
            const id = all[i].dataset.id;
            const file = fileStorage[id];
            if(!file) continue;

            const pct = Math.round((i / (all.length + 2)) * 100);
            dom.prog.fill.style.width = pct + '%';
            dom.prog.txt.textContent = `處理流水號 ${i+1}/${all.length}`;

            let name = file.name;
            const ext = name.substring(name.lastIndexOf('.'));
            let finalName = "";
            const numStr = (i+1).toString().padStart(pad, '0');
            
            if (pre) finalName = `${pre}_${numStr}${ext}`;
            else finalName = `${numStr}${ext}`; // 預設 01.png
            
            zip.file(finalName, file);
        }

        // 2. 額外產生 Main 檔
        if (currentMainId && fileStorage[currentMainId]) {
            dom.prog.txt.textContent = "產生 main.png...";
            const blob = await resizeImage(fileStorage[currentMainId], 240, 240);
            zip.file("main.png", blob);
        }

        // 3. 額外產生 Tab 檔
        if (currentTabId && fileStorage[currentTabId]) {
            dom.prog.txt.textContent = "產生 tab.png...";
            const blob = await resizeImage(fileStorage[currentTabId], 96, 74);
            zip.file("tab.png", blob);
        }

        dom.prog.txt.textContent = "壓縮打包中...";
        dom.prog.fill.style.width = '100%';
        
        zip.generateAsync({type:"blob"}).then(blob => {
            let zName = dom.sets.zip.value.trim() || dom.sets.zip.placeholder;
            if(!zName.toLowerCase().endsWith('.zip')) zName += '.zip';
            saveAs(blob, zName);
            setTimeout(() => {
                dom.prog.box.style.display = 'none';
                dom.dl.disabled = false;
                dom.prog.fill.style.width = '0%';
            }, 1000);
        });
    };
</script>
</body>
</html>
