<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LINE è²¼åœ–è£½ä½œå¤§å¸« (V29: ç©¶æ¥µå®Œæ•´ç‰ˆ)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
        /* =========================================
           1. è®Šæ•¸èˆ‡åŸºç¤è¨­å®š (Variables & Reset)
           ========================================= */
        :root {
            --primary: #06C755;
            --primary-hover: #05a546;
            --secondary: #3b82f6;
            --danger: #ef4444;
            --bg: #181818;
            --card-bg: #252525;
            --panel-bg: #2f2f2f;
            --input-bg: #383838;
            --text-main: #e0e0e0;
            --text-sub: #aaaaaa;
            --border: #444;
            --shadow: 0 4px 12px rgba(0,0,0,0.4);
        }

        body.light-mode {
            --bg: #f0f2f5;
            --card-bg: #ffffff;
            --panel-bg: #f7f8fa;
            --input-bg: #ffffff;
            --text-main: #333333;
            --text-sub: #666666;
            --border: #e0e0e0;
            --shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        * { box-sizing: border-box; outline: none; }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            transition: background 0.3s, color 0.3s;
            padding-bottom: 80px; /* é ç•™åº•éƒ¨ç©ºé–“ */
        }

        /* =========================================
           2. ä½ˆå±€å®¹å™¨ (Layout Containers)
           ========================================= */
        .container { 
            max-width: 1450px; 
            margin: 0 auto; 
            display: grid; 
            grid-template-columns: 400px 1fr; 
            gap: 25px; 
            align-items: start; 
        }

        @media (max-width: 1000px) { 
            .container { grid-template-columns: 1fr; } 
            .sticky-sidebar { position: static !important; height: auto !important; }
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1450px;
            margin: 0 auto 20px auto;
            padding: 0 10px;
        }

        h1 {
            margin: 0;
            font-size: 1.8rem;
            background: linear-gradient(90deg, #06C755, #2ecc71);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex; align-items: center; gap: 10px;
        }

        .version-tag {
            font-size: 0.8rem;
            border: 1px solid var(--border);
            padding: 2px 8px;
            border-radius: 12px;
            color: var(--text-sub);
            -webkit-text-fill-color: var(--text-sub);
        }

        .card { 
            background: var(--card-bg); 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: var(--shadow); 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
            border: 1px solid var(--border);
        }

        .sticky-sidebar { 
            position: sticky; 
            top: 20px; 
            height: calc(100vh - 40px); 
            overflow-y: auto; 
            scrollbar-width: thin;
        }

        /* =========================================
           3. UI å…ƒä»¶ (UI Components)
           ========================================= */
        /* æŒ‰éˆ•æ¨£å¼ */
        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            user-select: none;
        }
        .btn:active { transform: scale(0.98); }
        .btn-green { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(6,199,85,0.3); }
        .btn-green:hover { background: var(--primary-hover); }
        .btn-sec { background: var(--input-bg); border: 1px solid var(--border); color: var(--text-main); }
        .btn-sec:hover { background: var(--panel-bg); border-color: var(--text-sub); }
        .btn-blue { background: var(--secondary); color: white; }
        .btn-blue:hover { filter: brightness(1.1); }

        /* è¼¸å…¥æ¡†æ¨£å¼ */
        .row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .label { width: 75px; font-size: 0.9rem; color: var(--text-sub); flex-shrink: 0; font-weight: 500; }
        
        input[type="text"], input[type="number"], select {
            background: var(--input-bg);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            font-size: 0.9rem;
        }
        input:focus { border-color: var(--primary); }

        input[type="range"] {
            flex: 1;
            height: 5px;
            border-radius: 5px;
            background: var(--border);
            outline: none;
            accent-color: var(--primary);
            cursor: pointer;
        }

        input[type="color"] {
            width: 34px; height: 34px; border: none; padding: 0; background: none; cursor: pointer;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; gap: 8px;
        }

        /* =========================================
           4. åƒè€ƒåœ–å€åŸŸ (Reference Area)
           ========================================= */
        .ref-box {
            border: 1px solid var(--border);
            background: var(--panel-bg);
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s;
        }
        .ref-header {
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            background: rgba(0,0,0,0.1);
            user-select: none;
        }
        .ref-header:hover { background: rgba(0,0,0,0.2); }
        .ref-body { padding: 10px; display: none; }
        .ref-box.active .ref-body { display: block; }

        /* ç•«å¸ƒå®¹å™¨ */
        #refWrapper {
            width: 100%; height: 300px;
            position: relative;
            background-image: 
                linear-gradient(45deg, #222 25%, transparent 25%), 
                linear-gradient(-45deg, #222 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #222 75%), 
                linear-gradient(-45deg, transparent 75%, #222 75%);
            background-size: 20px 20px;
            background-color: #333;
            border-radius: 6px;
            border: 1px solid var(--border);
            display: flex; align-items: center; justify-content: center;
            overflow: hidden;
        }
        #refCanvas { max-width: 100%; max-height: 100%; object-fit: contain; cursor: crosshair; }
        #gridCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }

        /* ç§»å‹•å·¥å…·åˆ— */
        .move-toolbar {
            display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; 
            background: var(--input-bg); padding: 8px; border-radius: 6px; margin-bottom: 10px;
            border: 1px solid var(--border);
        }
        .micro-switch {
            display: flex; align-items: center; font-size: 0.85rem; cursor: pointer;
            background: rgba(6, 199, 85, 0.1); padding: 4px 8px; border-radius: 4px;
            border: 1px solid rgba(6, 199, 85, 0.3); color: var(--primary);
        }
        .micro-switch input { margin-right: 5px; }

        /* =========================================
           5. é è¦½ç¶²æ ¼ (Preview Grid)
           ========================================= */
        #previewGrid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            padding: 5px;
            min-height: 400px;
        }

        .sticker-card {
            background: var(--input-bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
            transition: transform 0.2s, box-shadow 0.2s;
            /* å…è¨±å¡ç‰‡è¢«æ‹–æ›³ */
            cursor: grab;
        }
        .sticker-card:hover { border-color: var(--primary); box-shadow: var(--shadow); z-index: 5; }
        
        /* SortableJS æ‹–æ›³æ¨£å¼ */
        .sortable-ghost { opacity: 0.3; background: var(--panel-bg); border: 2px dashed var(--primary); }
        .sortable-drag { cursor: grabbing; opacity: 1; transform: scale(1.05); z-index: 100; }

        .img-box {
            width: 100%; aspect-ratio: 1;
            display: flex; align-items: center; justify-content: center;
            background-image: conic-gradient(#333 25%, transparent 25%), conic-gradient(transparent 75%, #333 75%);
            background-size: 16px 16px; background-color: #444;
            position: relative;
            cursor: zoom-in; /* æç¤ºé»æ“Šæ”¾å¤§ */
        }
        /* é è¦½èƒŒæ™¯è®Šæ› */
        .img-box.bg-line { background: #849ebf; background-image: none; }
        .img-box.bg-light { background: #ffffff; background-image: none; }
        .img-box.bg-dark { background: #222222; background-image: none; }
        .img-box.bg-pink { background: #ffc0cb; background-image: none; }
        .img-box.bg-yellow { background: #fffacd; background-image: none; }

        .img-box img { max-width: 100%; max-height: 100%; object-fit: contain; pointer-events: none; }

        /* å¡ç‰‡æŒ‰éˆ• (é—œéµä¿®å¾©ï¼šno-drag) */
        .card-actions {
            position: absolute; top: 6px; right: 6px;
            display: flex; gap: 5px;
            z-index: 10;
        }
        /* SortableJS çš„ filter: '.no-drag' æœƒè®“é€™å€‹å€åŸŸç„¡æ³•è§¸ç™¼æ‹–æ›³ 
           åŒæ™‚æˆ‘å€‘éœ€è¦ pointer-events: auto è®“å®ƒèƒ½è¢«é»æ“Š
        */
        .no-drag { pointer-events: auto; }

        .action-btn {
            width: 28px; height: 28px;
            border-radius: 50%;
            border: 1px solid rgba(255,255,255,0.3);
            display: flex; align-items: center; justify-content: center;
            font-size: 14px; color: white;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            transition: 0.2s;
        }
        .action-btn:hover { transform: scale(1.15); box-shadow: 0 4px 8px rgba(0,0,0,0.4); }
        .btn-edit { background: var(--secondary); }
        .btn-dl { background: var(--primary); }

        .edited-badge {
            position: absolute; top: 6px; left: 6px;
            background: #facc15; color: black;
            font-size: 10px; padding: 2px 6px; border-radius: 10px;
            font-weight: 800; display: none; z-index: 9;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .sticker-card.edited .edited-badge { display: block; }

        .sticker-name {
            padding: 8px; text-align: center;
            font-size: 0.85rem; color: var(--text-sub);
            border-top: 1px solid var(--border);
            font-family: monospace;
        }

        /* =========================================
           6. å–®å¼µç·¨è¼¯å™¨ (Editor Modal)
           ========================================= */
        .modal {
            display: none; position: fixed; z-index: 2000;
            left: 0; top: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); backdrop-filter: blur(4px);
            animation: fadeIn 0.2s;
        }

        .editor-win {
            background: var(--card-bg);
            width: 95%; max-width: 1200px; height: 90vh;
            margin: 2.5vh auto;
            border-radius: 12px;
            border: 1px solid var(--border);
            display: grid;
            grid-template-rows: 60px 1fr 60px;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
        }

        .editor-head {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px; border-bottom: 1px solid var(--border);
            background: var(--panel-bg);
        }

        .editor-body {
            display: grid; grid-template-columns: 280px 1fr;
            overflow: hidden;
        }

        .editor-sidebar {
            padding: 15px;
            background: var(--card-bg);
            border-right: 1px solid var(--border);
            overflow-y: auto;
            display: flex; flex-direction: column; gap: 15px;
        }

        .editor-main {
            background: #121212;
            display: flex; align-items: center; justify-content: center;
            position: relative;
            overflow: hidden;
            /* æ£‹ç›¤æ ¼èƒŒæ™¯ */
            background-image: 
                linear-gradient(45deg, #1f1f1f 25%, transparent 25%), 
                linear-gradient(-45deg, #1f1f1f 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #1f1f1f 75%), 
                linear-gradient(-45deg, transparent 75%, #1f1f1f 75%);
            background-size: 24px 24px;
        }

        .editor-foot {
            padding: 0 20px; border-top: 1px solid var(--border);
            background: var(--panel-bg);
            display: flex; justify-content: space-between; align-items: center;
        }

        /* ç·¨è¼¯å·¥å…·æ¨£å¼ */
        .tool-box {
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px;
            background: var(--input-bg);
        }
        .tool-title { font-size: 0.8rem; font-weight: bold; color: var(--text-sub); margin-bottom: 8px; text-transform: uppercase; }
        
        .tool-btn {
            width: 100%; text-align: left; padding: 10px;
            background: transparent; border: 1px solid transparent;
            color: var(--text-main); cursor: pointer; border-radius: 6px;
            display: flex; align-items: center; gap: 8px; margin-bottom: 4px;
            transition: 0.2s;
        }
        .tool-btn:hover { background: rgba(255,255,255,0.05); }
        .tool-btn.active {
            background: rgba(6, 199, 85, 0.15);
            border-color: var(--primary);
            color: var(--primary);
            font-weight: bold;
        }

        #editCanvas { box-shadow: 0 0 30px rgba(0,0,0,0.5); }
        
        /* ç·¨è¼¯å™¨æ¸¸æ¨™ */
        .cursor-pen { cursor: crosshair; }
        .cursor-eraser { cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="none" stroke="red" stroke-width="2"/></svg>') 12 12, auto; }
        .cursor-restore { cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="none" stroke="%2306C755" stroke-width="2"/></svg>') 12 12, auto; }
        .cursor-text { cursor: text; }

        /* å¤§åœ–é è¦½ Modal (å±¤ç´šæœ€é«˜) */
        #viewModal { z-index: 3000; }
        .view-content {
            margin: auto; display: block; max-width: 90%; max-height: 90vh;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            border-radius: 8px; box-shadow: 0 0 30px rgba(0,0,0,0.8);
            transition: transform 0.2s; cursor: zoom-out;
        }
        .modal-close {
            position: absolute; top: 20px; right: 30px;
            color: white; font-size: 40px; font-weight: bold;
            cursor: pointer; z-index: 3001; text-shadow: 0 2px 10px black;
        }

        @keyframes fadeIn { from {opacity: 0} to {opacity: 1} }
    </style>
</head>
<body>

<div class="header">
    <h1>
        <span>ğŸ¨ LINE è²¼åœ–è£½ä½œå¤§å¸«</span>
        <span class="version-tag">V29 ç©¶æ¥µå®Œæ•´ç‰ˆ</span>
    </h1>
    <div style="display:flex; gap:10px;">
        <button class="btn btn-sec" onclick="toggleTheme()">ğŸŒ— åˆ‡æ›æ¨¡å¼</button>
    </div>
</div>

<div class="container">
    
    <div class="card sticky-sidebar">
        <div class="section-box">
            <div class="section-title">ğŸ“· 1. åœ–ç‰‡ä¾†æº</div>
            <label class="btn btn-blue" style="width:100%; height:80px; display:flex; flex-direction:column; justify-content:center; border: 2px dashed rgba(255,255,255,0.3);">
                <span style="font-size:1.8rem;">ğŸ“‚</span>
                <span>é»æ“Šä¸Šå‚³æˆ–æ‹–æ”¾åœ–ç‰‡</span>
                <input type="file" id="imgInput" style="display:none" accept="image/*">
            </label>
            <div style="margin-top:10px; font-size:0.85rem; color:var(--text-sub); line-height:1.5;">
                ğŸ’¡ <b>å¿«é€Ÿéµæç¤ºï¼š</b><br>
                â€¢ <b>â†‘ â†“ â† â†’</b> : ç§»å‹•åœ–ç‰‡ä½ç½®<br>
                â€¢ <b>Shift</b> + æ–¹å‘éµ : åŠ é€Ÿç§»å‹•<br>
                â€¢ <b>Ctrl</b> + ä¸Šä¸‹éµ : ç¸®æ”¾åœ–ç‰‡
            </div>
        </div>

        <div class="section-box">
            <div class="section-title">âœ‚ï¸ 2. è£åˆ‡åˆ†å‰²</div>
            <div class="row">
                <span class="label">å‚ç›´ (åˆ—)</span>
                <input type="number" id="rows" value="4" min="1">
                <div style="flex:1;"></div>
                <span class="label" style="width:auto;">æ°´å¹³ (è¡Œ)</span>
                <input type="number" id="cols" value="5" min="1">
            </div>
            <div class="row">
                <span class="label">è‡ªå‹•ç½®ä¸­</span>
                <label style="display:flex; align-items:center; cursor:pointer;">
                    <input type="checkbox" id="autoCenter" checked style="width:18px; height:18px; margin-right:8px;">
                    <span style="font-size:0.85rem; color:var(--text-sub);">æ™ºæ…§è£åˆ‡èˆ‡æœ€å¤§åŒ–</span>
                </label>
            </div>
        </div>

        <div class="section-box">
            <div class="section-title">ğŸ¨ 3. æ‰¹æ¬¡å»èƒŒèˆ‡ç‰¹æ•ˆ</div>
            
            <div class="row">
                <span class="label">å»èƒŒé¡è‰²</span>
                <input type="color" id="targetColor" value="#FFFFFF">
                <button class="btn btn-sec" style="padding:4px 10px; font-size:0.8rem;" onclick="setColor('#FFFFFF')">ç™½</button>
                <button class="btn btn-sec" style="padding:4px 10px; font-size:0.8rem;" onclick="setColor('#00FF00')">ç¶ </button>
            </div>

            <div class="row">
                <span class="label">å¯¬å®¹åº¦</span>
                <input type="range" id="tolerance" min="0" max="100" value="40">
                <span id="v_tolerance" style="width:35px; text-align:right; font-size:0.8rem;">40%</span>
            </div>
            <div class="row">
                <span class="label">æŸ”åŒ–é‚Šç·£</span>
                <input type="range" id="smoothness" min="0" max="10" step="0.5" value="0">
                <span id="v_smoothness" style="width:35px; text-align:right; font-size:0.8rem;">0</span>
            </div>
            <div class="row">
                <span class="label">é‚Šç·£å…§ç¸®</span>
                <input type="range" id="shrink" min="0" max="20" step="0.5" value="0">
                <span id="v_shrink" style="width:35px; text-align:right; font-size:0.8rem;">0</span>
            </div>
            <div class="row">
                <span class="label">è‰²å½©æ·¨åŒ–</span>
                <input type="range" id="defringe" min="0" max="20" step="1" value="0">
                <span id="v_defringe" style="width:35px; text-align:right; font-size:0.8rem;">0</span>
            </div>

            <hr style="border-color:var(--border); opacity:0.3; margin:15px 0;">

            <div class="row">
                <span class="label">æé‚Šå¯¬åº¦</span>
                <input type="range" id="contour" min="0" max="20" value="5">
                <input type="color" id="contourColor" value="#FFFFFF">
            </div>
            <div class="row">
                <span class="label">é™°å½±å¼·åº¦</span>
                <input type="range" id="shadowOpacity" min="0" max="100" value="30">
                <input type="color" id="shadowColor" value="#000000">
            </div>
        </div>

        <button id="runBtn" class="btn btn-green" style="height:55px; font-size:1.1rem; box-shadow: var(--shadow-md);">ğŸš€ ç”Ÿæˆå…¨å¥—è²¼åœ–</button>
    </div>

    <div class="card">
        <div class="ref-box" id="refBox">
            <div class="ref-header" onclick="toggleRefBox()">
                <b>ğŸ“Œ åŸå§‹åœ–åƒè€ƒ & ä½ç½®å¾®èª¿</b> <span>â–¼</span>
            </div>
            <div class="ref-body">
                <div class="move-toolbar">
                    <label class="micro-switch" title="å‹¾é¸å¾Œç§»å‹•å¹…åº¦è®Šå° (1px)">
                        <input type="checkbox" id="microMode"> å¾®èª¿æ¨¡å¼
                    </label>
                    <div style="width:1px; height:20px; background:var(--border); margin:0 5px;"></div>
                    <button class="btn btn-sec" onclick="moveImg(0, 0.05)" title="æ”¾å¤§">â•</button>
                    <button class="btn btn-sec" onclick="moveImg(0, -0.05)" title="ç¸®å°">â–</button>
                    <div style="width:1px; height:20px; background:var(--border); margin:0 5px;"></div>
                    <button class="btn btn-sec" onclick="moveImg('y', 0.05)">â¬†ï¸</button>
                    <button class="btn btn-sec" onclick="moveImg('y', -0.05)">â¬‡ï¸</button>
                    <button class="btn btn-sec" onclick="moveImg('x', 0.05)">â¬…ï¸</button>
                    <button class="btn btn-sec" onclick="moveImg('x', -0.05)">â¡ï¸</button>
                    <div style="width:1px; height:20px; background:var(--border); margin:0 5px;"></div>
                    <button class="btn btn-sec" onclick="resetMove()">é‡ç½®</button>
                </div>
                
                <div id="refWrapper">
                    <canvas id="refCanvas"></canvas>
                    <canvas id="gridCanvas"></canvas>
                    <div style="position:absolute; bottom:10px; right:10px; background:rgba(0,0,0,0.7); color:white; padding:4px 8px; font-size:0.75rem; border-radius:4px; pointer-events:none;">
                        ğŸ’¡ é»æ“Šåœ–ç‰‡å¸å–èƒŒæ™¯è‰²
                    </div>
                </div>
            </div>
        </div>

        <div style="background:var(--panel-bg); padding:15px; border-radius:10px; border:1px solid var(--border); display:flex; flex-wrap:wrap; justify-content:space-between; align-items:center; gap:15px;">
            <div class="row" style="margin:0;">
                <span class="label" style="width:auto; margin-right:5px;">èµ·å§‹æª”å:</span>
                <input type="text" id="startNum" value="001" style="width:70px;">
            </div>
            
            <div style="display:flex; gap:8px;">
                <button class="btn btn-sec" onclick="setBg('dark')" title="æ·±è‰²">â¬›</button>
                <button class="btn btn-sec" onclick="setBg('line')" style="background:#849ebf; color:white;" title="LINE">LINE</button>
                <button class="btn btn-sec" onclick="setBg('pink')" style="background:#ffc0cb; color:black;" title="ç²‰ç´…">ğŸŒ¸</button>
                <button class="btn btn-sec" onclick="setBg('light')" title="æ·ºè‰²">â¬œ</button>
            </div>

            <div style="display:flex; gap:15px; align-items:center;">
                <label style="font-size:0.9rem; display:flex; align-items:center; cursor:pointer;">
                    <input type="checkbox" id="compressPng" style="margin-right:6px;"> PNGå£“ç¸®
                </label>
                <button class="btn btn-green" onclick="downloadAll()">ğŸ“¦ ä¸‹è¼‰ ZIP</button>
            </div>
        </div>

        <div id="previewGrid">
            <div style="grid-column:1/-1; text-align:center; padding:100px; color:var(--text-sub); border: 2px dashed var(--border); border-radius:12px;">
                <div style="font-size:3rem; margin-bottom:15px;">ğŸ–¼ï¸</div>
                è«‹å…ˆä¸Šå‚³åœ–ç‰‡ä¸¦é»æ“Šå·¦å´ã€Œé–‹å§‹è£½ä½œã€
            </div>
        </div>
    </div>
</div>

<div id="editorModal" class="modal">
    <div class="editor-win">
        <div class="editor-head">
            <h3 style="margin:0; display:flex; align-items:center; gap:10px;">
                âœï¸ å–®å¼µç²¾ä¿® <span id="editorTitle" style="color:var(--primary); font-size:0.9em; border:1px solid var(--primary); padding:2px 8px; border-radius:12px;"></span>
            </h3>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-sec" onclick="editorUndo()" title="å¾©åŸ (Ctrl+Z)">â†©ï¸</button>
                <button class="btn btn-sec" onclick="editorRedo()" title="é‡åš (Ctrl+Y)">â†ªï¸</button>
                <div style="width:1px; height:30px; background:var(--border);"></div>
                <button class="btn btn-green" onclick="saveEditor()">âœ… å®Œæˆç·¨è¼¯</button>
                <button class="btn btn-sec" onclick="closeEditor()" style="color:var(--danger); border-color:var(--danger);">é—œé–‰</button>
            </div>
        </div>
        
        <div class="editor-body">
            <div class="editor-sidebar">
                
                <div class="tool-box">
                    <div class="tool-title">ä¿®åœ–å·¥å…·</div>
                    <button class="tool-btn active" id="tool-move" onclick="setTool('move')">
                        <span>âœ‹</span> ç§»å‹• / æª¢è¦–
                    </button>
                    <button class="tool-btn" id="tool-eraser" onclick="setTool('eraser')">
                        <span>ğŸ§½</span> æ©¡çš®æ“¦ (å»èƒŒ)
                    </button>
                    <button class="tool-btn" id="tool-restore" onclick="setTool('restore')">
                        <span>ğŸ–Œï¸</span> é‚„åŸç­†åˆ· (è£œå›)
                    </button>
                    
                    <div style="margin-top:10px; display:flex; flex-direction:column; gap:5px;">
                        <div style="display:flex; justify-content:space-between; font-size:0.8rem; color:var(--text-sub);">
                            <span>ç­†åˆ·å¤§å°</span>
                            <span id="brushSizeVal">20</span>
                        </div>
                        <input type="range" id="brushSize" min="1" max="100" value="20" style="width:100%;">
                    </div>
                </div>

                <div class="tool-box">
                    <div class="tool-title">å¡—é´‰èˆ‡æ–‡å­—</div>
                    <button class="tool-btn" id="tool-pen" onclick="setTool('pen')">
                        <span>âœï¸</span> ç•«ç­†å¡—é´‰
                    </button>
                    <div id="penOptions" style="display:none; padding:5px 0;">
                        <input type="color" id="penColor" value="#ff0000" style="width:100%;">
                    </div>

                    <button class="tool-btn" id="tool-text" onclick="setTool('text')">
                        <span>ğŸ…°ï¸</span> è“‹å°æ–‡å­—
                    </button>
                    <div id="textOptions" style="display:none; flex-direction:column; gap:8px; margin-top:10px; background:rgba(0,0,0,0.2); padding:10px; border-radius:6px;">
                        <input type="text" id="textInput" placeholder="è¼¸å…¥æ–‡å­—..." style="width:100%; text-align:left;">
                        <div style="display:flex; gap:5px;">
                            <input type="color" id="textColor" value="#000000" style="flex:1;">
                            <input type="number" id="textSize" value="40" style="width:60px;" title="å­—é«”å¤§å°">
                        </div>
                        <button class="btn btn-blue" style="width:100%;" onclick="stampText()">ğŸ‘‡ è“‹å°åˆ°ç•«é¢</button>
                    </div>
                </div>

                <div class="tool-box">
                    <div class="tool-title">åƒæ•¸è¦†è“‹ (Override)</div>
                    <div style="font-size:0.75rem; color:var(--text-sub); margin-bottom:5px;">é‡å°æ­¤å¼µè²¼åœ–ç¨ç«‹èª¿æ•´ï¼š</div>
                    <div class="row" style="margin-bottom:8px;">
                        <span class="label" style="width:50px;">å¯¬å®¹åº¦</span>
                        <input type="range" id="e_tolerance" min="0" max="100">
                    </div>
                    <div class="row" style="margin-bottom:8px;">
                        <span class="label" style="width:50px;">å…§ç¸®</span>
                        <input type="range" id="e_shrink" min="0" max="20" step="0.5">
                    </div>
                    
                    <button class="btn btn-sec" style="width:100%; font-size:0.85rem; margin-top:10px;" onclick="copySettingsToAll()">
                        ğŸ”„ æ‡‰ç”¨åƒæ•¸è‡³å…¨éƒ¨
                    </button>
                </div>

            </div>
            
            <div class="editor-main">
                <canvas id="editCanvas"></canvas>
            </div>
        </div>
        
        <div class="editor-foot">
            <span style="font-size:0.85rem; color:var(--text-sub);">
                æ“ä½œæç¤ºï¼šæ»¾è¼ªç¸®æ”¾ | ç©ºç™½éµ+æ‹–æ›³ç§»å‹•è¦–è§’ | é‚„åŸç­†åˆ·å¯æ•‘å›è¢«å»èƒŒçš„éƒ¨åˆ†
            </span>
            <button class="btn btn-sec" style="color:var(--danger);" onclick="clearDrawings()">âŒ æ¸…é™¤å¡—é´‰/é®ç½©</button>
        </div>
    </div>
</div>

<div id="viewModal" class="modal" onclick="closeViewModal()">
    <span class="modal-close">&times;</span>
    <img class="view-content" id="viewImg">
</div>

<script>
// =========================================
// å…¨åŸŸè®Šæ•¸å®šç¾©
// =========================================
const els = {}; 
const ids = [
    'imgInput', 'rows', 'cols', 'autoCenter', 'targetColor', 'tolerance', 'smoothness', 'shrink', 'defringe',
    'contour', 'contourColor', 'shadowOpacity', 'shadowColor', 'runBtn', 'refCanvas', 'gridCanvas', 'previewGrid',
    'startNum', 'compressPng', 'editCanvas', 'viewModal', 'viewImg', 'brushSize', 'penColor',
    'textInput', 'textColor', 'textSize', 'refContainer', 'refBox', 'microMode'
];
ids.forEach(id => {
    const el = document.getElementById(id);
    if(el) els[id] = el;
});

// ç‹€æ…‹è®Šæ•¸
let rawImage = null; // åŸå§‹å¤§åœ– Image ç‰©ä»¶
let stickersData = []; // å­˜æ”¾æ‰€æœ‰è²¼åœ–è³‡æ–™: {id, originalTile, maskCanvas, doodleCanvas, settings}
let currentEditId = null; // ç•¶å‰æ­£åœ¨ç·¨è¼¯çš„ Index
let transform = { x: 0, y: 0, scale: 1.0 }; // åŸå§‹åœ–è®Šå½¢ç‹€æ…‹

// ç·¨è¼¯å™¨å…§éƒ¨ç‹€æ…‹
let editorState = {
    tool: 'move', // move, eraser, restore, pen, text
    isDrawing: false,
    history: [], // Undo stack
    historyIndex: -1,
    zoom: 1,
    pan: {x: 0, y: 0},
    // æš«å­˜å±¤ (ç”¨æ–¼ç·¨è¼¯æ™‚å³æ™‚ç¹ªè£½)
    tempEraser: null, // æ©¡çš®æ“¦å±¤
    tempRestore: null, // é‚„åŸå±¤
    tempDoodle: null  // å¡—é´‰å±¤
};

// =========================================
// åˆå§‹åŒ–èˆ‡äº‹ä»¶ç¶å®š
// =========================================
window.onload = () => {
    loadSettings();
    
    // åˆå§‹åŒ–æ‹–æ›³æ’åº (SortableJS)
    new Sortable(els.previewGrid, {
        animation: 150,
        ghostClass: 'sortable-ghost',
        dragClass: 'sortable-drag',
        filter: '.no-drag', // é—œéµï¼šå¿½ç•¥å¸¶æœ‰ .no-drag çš„å…ƒç´  (æŒ‰éˆ•)
        preventOnFilter: false, // å…è¨±æŒ‰éˆ•è¢«é»æ“Š
        onEnd: (evt) => {
            // æ›´æ–°æ•¸æ“šé™£åˆ—é †åº
            const item = stickersData.splice(evt.oldIndex, 1)[0];
            stickersData.splice(evt.newIndex, 0, item);
            refreshPreviewNames(); // é‡æ–°ç·¨è™Ÿ
        }
    });

    // ç¶å®š Slider æ•¸å€¼é¡¯ç¤º
    document.querySelectorAll('input[type=range]').forEach(input => {
        input.addEventListener('input', (e) => {
            const span = document.getElementById('v_' + e.target.id);
            if(span) span.innerText = e.target.value;
        });
    });
    
    // ç­†åˆ·å¤§å°é¡¯ç¤º
    els.brushSize.addEventListener('input', (e) => {
        document.getElementById('brushSizeVal').innerText = e.target.value;
    });
};

// =========================================
// åœ–ç‰‡è¼‰å…¥èˆ‡åƒè€ƒåœ–æ“ä½œ
// =========================================
els.imgInput.addEventListener('change', async (e) => {
    if(!e.target.files[0]) return;
    const blob = URL.createObjectURL(e.target.files[0]);
    rawImage = await loadImage(blob);
    transform = { x:0, y:0, scale:1 }; 
    drawRef();
    document.getElementById('refBox').classList.add('active'); // è‡ªå‹•å±•é–‹
});

function drawRef() {
    if(!rawImage) return;
    const cvs = els.refCanvas;
    // é™åˆ¶ Canvas å°ºå¯¸ä»¥é˜²è¨˜æ†¶é«”éå¤§ï¼Œä½†ä¿æŒæ¯”ä¾‹
    cvs.width = rawImage.width; 
    cvs.height = rawImage.height;
    
    const ctx = cvs.getContext('2d');
    ctx.clearRect(0, 0, cvs.width, cvs.height);
    ctx.drawImage(rawImage, transform.x, transform.y, rawImage.width * transform.scale, rawImage.height * transform.scale);
    
    // ç¹ªè£½æ ¼ç·š (Grid)
    const gCvs = els.gridCanvas;
    gCvs.width = cvs.width; gCvs.height = cvs.height;
    const gCtx = gCvs.getContext('2d');
    gCtx.clearRect(0, 0, gCvs.width, gCvs.height);
    
    if(document.getElementById('showGrid').checked) {
        const r = parseInt(els.rows.value);
        const c = parseInt(els.cols.value);
        const w = cvs.width / c; const h = cvs.height / r;
        gCtx.strokeStyle = 'rgba(255, 50, 50, 0.8)'; gCtx.lineWidth = 2; gCtx.setLineDash([5, 5]);
        gCtx.beginPath();
        for(let i=1; i<c; i++) { gCtx.moveTo(i*w, 0); gCtx.lineTo(i*w, cvs.height); }
        for(let i=1; i<r; i++) { gCtx.moveTo(0, i*h); gCtx.lineTo(cvs.width, i*h); }
        gCtx.stroke();
    }
}

// è®Šå½¢æ§åˆ¶ (ç§»å‹•/ç¸®æ”¾)
window.moveImg = (axis, val) => {
    if(!rawImage) return;
    const isMicro = els.microMode.checked;
    const mult = isMicro ? 0.1 : 1.0;
    
    if(axis === 0) {
        transform.scale = Math.max(0.1, transform.scale + (val * mult));
    } else if(axis === 'x') {
        transform.x -= (rawImage.width * transform.scale * val * mult);
    } else if(axis === 'y') {
        transform.y -= (rawImage.height * transform.scale * val * mult);
    }
    drawRef();
};
window.resetMove = () => { transform = {x:0, y:0, scale:1}; drawRef(); };

// å¸è‰²åŠŸèƒ½ (é€é Grid Canvas ç›£è½é»æ“Š)
els.gridCanvas.style.pointerEvents = 'auto'; 
els.gridCanvas.addEventListener('click', (e) => {
    if(!rawImage) return;
    const rect = e.target.getBoundingClientRect();
    const scaleX = els.refCanvas.width / rect.width;
    const scaleY = els.refCanvas.height / rect.height;
    const ctx = els.refCanvas.getContext('2d');
    const p = ctx.getImageData((e.clientX - rect.left)*scaleX, (e.clientY - rect.top)*scaleY, 1, 1).data;
    els.targetColor.value = "#" + ((1 << 24) + (p[0] << 16) + (p[1] << 8) + p[2]).toString(16).slice(1);
});

// =========================================
// æ ¸å¿ƒè™•ç†æµç¨‹ (Batch Processing)
// =========================================
els.runBtn.addEventListener('click', async () => {
    if(!rawImage) return alert('è«‹å…ˆä¸Šå‚³åœ–ç‰‡');
    
    els.runBtn.disabled = true; 
    els.runBtn.innerText = "ğŸš€ è™•ç†ä¸­...";
    els.previewGrid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:50px;">æ­£åœ¨ç”Ÿæˆè²¼åœ–...</div>';

    // ä½¿ç”¨ setTimeout è®“ UI æœ‰æ©Ÿæœƒæ›´æ–°
    setTimeout(async () => {
        // 1. ç”¢ç”Ÿè™›æ“¬å¤§åœ– (å·²æ‡‰ç”¨è®Šå½¢)
        const vCvs = document.createElement('canvas');
        vCvs.width = rawImage.width; vCvs.height = rawImage.height;
        vCvs.getContext('2d').drawImage(rawImage, transform.x, transform.y, rawImage.width * transform.scale, rawImage.height * transform.scale);
        
        const rows = parseInt(els.rows.value);
        const cols = parseInt(els.cols.value);
        const tileW = Math.floor(vCvs.width / cols);
        const tileH = Math.floor(vCvs.height / rows);
        
        stickersData = []; // æ¸…ç©ºèˆŠè³‡æ–™

        for(let r=0; r<rows; r++) {
            for(let c=0; c<cols; c++) {
                // åˆ‡å‰²åŸå§‹åœ–å¡Š
                const tCvs = document.createElement('canvas');
                tCvs.width = tileW; tCvs.height = tileH;
                tCvs.getContext('2d').drawImage(vCvs, c*tileW, r*tileH, tileW, tileH, 0, 0, tileW, tileH);
                
                // åˆå§‹åŒ–åœ–å±¤
                // 1. æ©¡çš®æ“¦å±¤ (Eraser) - åˆå§‹å…¨ç™½ (ä¸æ“¦é™¤)ï¼Œé»‘ä»£è¡¨æ“¦é™¤? 
                // æˆ‘å€‘å®šç¾©ï¼šæ©¡çš®æ“¦å±¤æ˜¯ç”¨ destination-out ç¹ªè£½çš„ï¼Œæ‰€ä»¥ç•«ä¸Šå»çš„éƒ¨åˆ†è®Šé€æ˜ã€‚
                // åˆå§‹ç‚ºç©º (é€æ˜) -> æ²’æ“¦ä»»ä½•æ±è¥¿ã€‚
                const eCvs = document.createElement('canvas'); eCvs.width = tileW; eCvs.height = tileH;
                
                // 2. é‚„åŸå±¤ (Restore) - åˆå§‹ç‚ºç©ºã€‚ç•«ä¸Šå»çš„åœ°æ–¹æœƒå¼·åˆ¶é¡¯ç¤ºåŸåœ–ã€‚
                const rCvs = document.createElement('canvas'); rCvs.width = tileW; rCvs.height = tileH;

                // 3. å¡—é´‰å±¤ (Doodle)
                const dCvs = document.createElement('canvas'); dCvs.width = tileW; dCvs.height = tileH;

                stickersData.push({
                    id: r*cols + c,
                    originalTile: tCvs, 
                    eraserCanvas: eCvs,
                    restoreCanvas: rCvs,
                    doodleCanvas: dCvs,
                    settings: null // è‹¥ç‚º null å‰‡ä½¿ç”¨å…¨åŸŸè¨­å®š
                });
            }
        }
        
        await renderAllStickers();
        els.runBtn.disabled = false;
        els.runBtn.innerText = "ğŸš€ é–‹å§‹è£½ä½œå…¨å¥—è²¼åœ–";
    }, 50);
});

// æ¸²æŸ“æ‰€æœ‰è²¼åœ–
async function renderAllStickers() {
    els.previewGrid.innerHTML = '';
    const globalSettings = getGlobalSettings();

    for (let i = 0; i < stickersData.length; i++) {
        const item = stickersData[i];
        const settings = item.settings || globalSettings; 
        
        // A. è™•ç†å»èƒŒèˆ‡é®ç½©
        const processedCvs = await processStickerLayers(item, settings);
        
        // B. æ‡‰ç”¨å¾Œè£½ (è‡ªå‹•ç½®ä¸­ã€æé‚Šã€é™°å½±)
        const resultUrl = await postProcess(processedCvs, settings);
        
        // C. å»ºç«‹ UI å¡ç‰‡
        const div = document.createElement('div');
        div.className = `sticker-card ${item.settings ? 'edited' : ''}`;
        div.setAttribute('data-id', i);
        
        div.innerHTML = `
            <div class="img-box" id="preview-bg-${i}" onclick="viewImage('${resultUrl}')">
                <img src="${resultUrl}">
            </div>
            <div class="edited-badge">å·²ä¿®</div>
            <div class="card-actions no-drag">
                <div class="action-btn btn-edit" title="ç·¨è¼¯" onclick="openEditor(${i}); event.stopPropagation();">âœï¸</div>
                <div class="action-btn btn-dl" title="ä¸‹è¼‰" onclick="downloadOne('${resultUrl}', ${i}); event.stopPropagation();">â¬‡</div>
            </div>
            <div class="sticker-name">${getFilename(i)}</div>
        `;
        els.previewGrid.appendChild(div);
    }
    updateBg(); 
}

// [æ ¸å¿ƒ] åœ–å±¤åˆæˆé‚è¼¯
async function processStickerLayers(item, s) {
    const w = item.originalTile.width;
    const h = item.originalTile.height;
    
    // 1. ç”¢ç”Ÿè‡ªå‹•å»èƒŒé®ç½© (Auto Mask)
    // é€™è£¡å›å‚³çš„æ˜¯ Alpha Mask (é»‘ç™½åœ–, ç™½=ä¿ç•™, é»‘=å»èƒŒ)
    const autoMask = generateColorMask(item.originalTile, s);
    
    // 2. åˆæˆæœ€çµ‚é®ç½© (Final Mask)
    // é‚è¼¯: (AutoMask - Eraser) + Restore
    const finalMask = document.createElement('canvas');
    finalMask.width = w; finalMask.height = h;
    const fmCtx = finalMask.getContext('2d');
    
    // a. ç•«ä¸Šè‡ªå‹•é®ç½©
    fmCtx.drawImage(autoMask, 0, 0);
    
    // b. æ¸›å»æ©¡çš®æ“¦ (eraserCanvas è£¡é¢æœ‰å…§å®¹çš„åœ°æ–¹ä»£è¡¨è¦æ“¦æ‰)
    // ä½¿ç”¨ destination-out: ä¾†æº(Eraser)ä¸é€æ˜çš„åœ°æ–¹ï¼Œç›®æ¨™(FinalMask)è®Šé€æ˜
    fmCtx.globalCompositeOperation = 'destination-out';
    fmCtx.drawImage(item.eraserCanvas, 0, 0);
    
    // c. åŠ ä¸Šé‚„åŸå±¤ (restoreCanvas è£¡é¢æœ‰å…§å®¹çš„åœ°æ–¹ä»£è¡¨è¦å¼·åˆ¶ä¿ç•™)
    // ä½¿ç”¨ source-over: ç›´æ¥è“‹ä¸Šå» (é‚„åŸå±¤æ‡‰è©²æ˜¯å¯¦å¿ƒç™½)
    fmCtx.globalCompositeOperation = 'source-over';
    fmCtx.drawImage(item.restoreCanvas, 0, 0);
    
    // 3. æ‡‰ç”¨é®ç½©åˆ°åŸåœ–
    const result = document.createElement('canvas');
    result.width = w; result.height = h;
    const ctx = result.getContext('2d');
    
    ctx.drawImage(item.originalTile, 0, 0);
    ctx.globalCompositeOperation = 'destination-in';
    ctx.drawImage(finalMask, 0, 0);
    
    // 4. ç–ŠåŠ å¡—é´‰ (Doodle)
    ctx.globalCompositeOperation = 'source-over';
    ctx.drawImage(item.doodleCanvas, 0, 0);
    
    return result;
}

// ç”¢ç”Ÿé¡è‰²å»èƒŒé®ç½© (Alpha Channel)
function generateColorMask(img, s) {
    const w = img.width; const h = img.height;
    const cvs = document.createElement('canvas'); cvs.width = w; cvs.height = h;
    const ctx = cvs.getContext('2d');
    
    ctx.drawImage(img, 0, 0);
    const idata = ctx.getImageData(0, 0, w, h);
    const d = idata.data;
    const target = hexToRgb(s.targetColor);
    const tol = (s.tolerance / 100) * 442; 
    
    for (let i = 0; i < d.length; i += 4) {
        const dist = Math.sqrt((d[i]-target.r)**2 + (d[i+1]-target.g)**2 + (d[i+2]-target.b)**2);
        // ç¬¦åˆé¡è‰² -> é€æ˜(0)ï¼Œä¸ç¬¦åˆ -> ä¸é€æ˜(255)
        // ç‚ºäº†åš Maskï¼Œæˆ‘å€‘è®“ RGB å…¨ç™½ï¼Œåªæ”¹ Alpha
        const alpha = (dist < tol) ? 0 : 255;
        d[i] = 255; d[i+1] = 255; d[i+2] = 255; d[i+3] = alpha;
    }
    ctx.putImageData(idata, 0, 0);
    
    // æ‡‰ç”¨å…§ç¸® (Erosion)
    if(s.shrink > 0) applyErosion(ctx, w, h, s.shrink);
    
    return cvs;
}

// å½¢æ…‹å­¸ä¾µè• (Shrink)
function applyErosion(ctx, w, h, r) {
    if(r <= 0) return;
    const src = ctx.getImageData(0,0,w,h);
    const dst = ctx.createImageData(w,h);
    const rad = Math.ceil(r);
    
    for(let y=0; y<h; y++) {
        for(let x=0; x<w; x++) {
            let minA = 255;
            // æœå°‹å‘¨åœæœ€å° Alpha
            for(let ky=-rad; ky<=rad; ky++) {
                for(let kx=-rad; kx<=rad; kx++) {
                    const nx=x+kx, ny=y+ky;
                    if(nx>=0 && nx<w && ny>=0 && ny<h) {
                        minA = Math.min(minA, src.data[(ny*w+nx)*4+3]);
                    }
                }
            }
            const idx = (y*w+x)*4;
            dst.data[idx] = 255; dst.data[idx+1] = 255; dst.data[idx+2] = 255; // ä¿æŒç™½
            dst.data[idx+3] = minA;
        }
    }
    ctx.putImageData(dst, 0, 0);
}

// å¾Œè£½è™•ç† (è‡ªå‹•ç½®ä¸­ã€æé‚Šã€é™°å½±)
async function postProcess(srcCvs, s) {
    const w = srcCvs.width; const h = srcCvs.height;
    const ctx = srcCvs.getContext('2d');
    const contentBox = getBoundingBox(ctx, w, h);
    
    const finalW = 370; const finalH = 320; 
    const outCvs = document.createElement('canvas'); outCvs.width = finalW; outCvs.height = finalH;
    const outCtx = outCvs.getContext('2d');
    
    if(contentBox && s.autoCenter) {
        const margin = parseInt(s.contour)*2 + 15; // é ç•™é‚Šè·
        const fitW = finalW - margin*2; const fitH = finalH - margin*2;
        const scale = Math.min(fitW/contentBox.w, fitH/contentBox.h);
        
        const drawW = contentBox.w * scale;
        const drawH = contentBox.h * scale;
        const drawX = (finalW - drawW)/2;
        const drawY = (finalH - drawH)/2;
        
        // æš«å­˜ç¸®æ”¾å¾Œçš„åœ–
        const effCvs = document.createElement('canvas'); effCvs.width = finalW; effCvs.height = finalH;
        const eCtx = effCvs.getContext('2d');
        eCtx.drawImage(srcCvs, contentBox.x, contentBox.y, contentBox.w, contentBox.h, drawX, drawY, drawW, drawH);
        
        // 1. é™°å½±
        if(s.shadowOpacity > 0) {
            outCtx.save();
            outCtx.shadowColor = s.shadowColor; outCtx.shadowBlur = 5; outCtx.shadowOffsetX = 3; outCtx.shadowOffsetY = 3;
            outCtx.globalAlpha = s.shadowOpacity;
            outCtx.drawImage(effCvs, 0, 0);
            outCtx.restore();
        }
        
        // 2. æé‚Š (ç°¡æ˜“æ¨¡æ“¬: ç¹ªè£½å¤šæ¬¡ä¸åŒåç§»)
        if(s.contour > 0) {
            outCtx.save();
            // æ³¨æ„: é€™æ˜¯ä¸€ç¨®ç°¡æ˜“æé‚Šï¼Œæ•ˆèƒ½è¼ƒä½ä½†é€šç”¨æ€§é«˜
            // æ›´å¥½çš„æ–¹å¼æ˜¯è™•ç† Alpha Channelï¼Œä½†ä»£ç¢¼æœƒå¾ˆé•·
            const cSize = parseInt(s.contour);
            outCtx.shadowColor = s.contourColor;
            outCtx.shadowBlur = 2; // è®“é‚Šç·£åœ“æ»‘ä¸€é»
            outCtx.shadowOffsetX = 0; outCtx.shadowOffsetY = 0;
            
            // 8æ–¹å‘æ“´å¼µ + 45åº¦è§’
            const steps = 12;
            for(let i=0; i<steps; i++) {
                const angle = (i / steps) * 2 * Math.PI;
                outCtx.drawImage(effCvs, Math.cos(angle)*cSize, Math.sin(angle)*cSize);
            }
            outCtx.restore();
            
            // ç•«ä¸Šæœ¬é«” (è“‹åœ¨æé‚Šä¸Š)
            outCtx.drawImage(effCvs, 0, 0);
        } else {
            outCtx.drawImage(effCvs, 0, 0);
        }
    } else {
        // ä¸ç½®ä¸­ï¼Œç›´æ¥ç¸®æ”¾è²¼ä¸Š
        outCtx.drawImage(srcCvs, 0, 0, finalW, finalH);
    }
    return outCvs.toDataURL();
}

function getBoundingBox(ctx, w, h) {
    const data = ctx.getImageData(0,0,w,h).data;
    let minX=w, minY=h, maxX=0, maxY=0, found=false;
    for(let y=0; y<h; y++) {
        for(let x=0; x<w; x++) {
            if(data[(y*w+x)*4+3] > 10) { // Alpha > 10
                if(x<minX) minX=x; if(x>maxX) maxX=x;
                if(y<minY) minY=y; if(y>maxY) maxY=y;
                found=true;
            }
        }
    }
    return found ? {x:minX, y:minY, w:maxX-minX+1, h:maxY-minY+1} : null;
}

// =========================================
// 4. å–®å¼µç·¨è¼¯å™¨ (V29 Core)
// =========================================
function openEditor(idx) {
    currentEditId = idx;
    const item = stickersData[idx];
    const settings = item.settings || getGlobalSettings();
    
    document.getElementById('editorTitle').innerText = `${getFilename(idx)}`;
    // åŒæ­¥ Slider
    document.getElementById('e_tolerance').value = settings.tolerance;
    document.getElementById('e_shrink').value = settings.shrink;
    document.getElementById('editorModal').style.display = 'block';
    
    // åˆå§‹åŒ–ç·¨è¼¯ Canvas
    const cvs = els.editCanvas;
    cvs.width = item.originalTile.width; cvs.height = item.originalTile.height;
    
    // åˆå§‹åŒ–æš«å­˜å±¤ (æ·±æ‹·è²ç›®å‰çš„ç‹€æ…‹)
    editorState.tempEraser = cloneCanvas(item.eraserCanvas);
    editorState.tempRestore = cloneCanvas(item.restoreCanvas);
    editorState.tempDoodle = cloneCanvas(item.doodleCanvas);
    
    editorState.history = []; // æ¸…ç©ºæ­·å²
    saveHistory(); 
    
    setTool('move');
    renderEditorCanvas();
}

function closeEditor() { document.getElementById('editorModal').style.display = 'none'; }

function cloneCanvas(oldCanvas) {
    const newCanvas = document.createElement('canvas');
    newCanvas.width = oldCanvas.width;
    newCanvas.height = oldCanvas.height;
    newCanvas.getContext('2d').drawImage(oldCanvas, 0, 0);
    return newCanvas;
}

// ç·¨è¼¯å™¨æ¸²æŸ“å¾ªç’° (å³æ™‚é è¦½)
function renderEditorCanvas() {
    const item = stickersData[currentEditId];
    const cvs = els.editCanvas;
    const ctx = cvs.getContext('2d');
    
    ctx.clearRect(0,0,cvs.width,cvs.height);
    
    // 1. å–å¾—ç•¶å‰åƒæ•¸çš„ AutoMask
    const settings = {
        ...getGlobalSettings(),
        tolerance: parseInt(document.getElementById('e_tolerance').value),
        shrink: parseFloat(document.getElementById('e_shrink').value)
    };
    const autoMask = generateColorMask(item.originalTile, settings);
    
    // 2. çµ„åˆé®ç½©
    const finalMask = document.createElement('canvas');
    finalMask.width = cvs.width; finalMask.height = cvs.height;
    const fmCtx = finalMask.getContext('2d');
    
    fmCtx.drawImage(autoMask, 0, 0);
    
    // æ¸›å»æ©¡çš®æ“¦ (tempEraser ä¸­æœ‰é¡è‰²çš„åœ°æ–¹è®Šé€æ˜)
    fmCtx.globalCompositeOperation = 'destination-out';
    fmCtx.drawImage(editorState.tempEraser, 0, 0);
    
    // åŠ ä¸Šé‚„åŸ (tempRestore ä¸­æœ‰é¡è‰²çš„åœ°æ–¹è®Šä¸é€æ˜)
    fmCtx.globalCompositeOperation = 'source-over';
    fmCtx.drawImage(editorState.tempRestore, 0, 0);
    
    // 3. ç¹ªè£½
    ctx.globalCompositeOperation = 'source-over';
    ctx.drawImage(item.originalTile, 0, 0);
    
    ctx.globalCompositeOperation = 'destination-in';
    ctx.drawImage(finalMask, 0, 0);
    
    ctx.globalCompositeOperation = 'source-over';
    ctx.drawImage(editorState.tempDoodle, 0, 0);
}

// å·¥å…·åˆ‡æ›
function setTool(tool) {
    editorState.tool = tool;
    document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(`tool-${tool}`).classList.add('active');
    
    document.getElementById('penOptions').style.display = (tool==='pen') ? 'block' : 'none';
    document.getElementById('textOptions').style.display = (tool==='text') ? 'flex' : 'none';
    
    const cvs = els.editCanvas;
    cvs.className = '';
    if(tool === 'eraser') cvs.classList.add('cursor-eraser');
    else if(tool === 'restore') cvs.classList.add('cursor-restore');
    else if(tool === 'pen') cvs.classList.add('cursor-pen');
    else if(tool === 'text') cvs.classList.add('cursor-text');
}

// ç•«å¸ƒäº’å‹•
let isDrag = false;
let lastPos = {x:0, y:0};

els.editCanvas.addEventListener('mousedown', startEdit);
els.editCanvas.addEventListener('mousemove', moveEdit);
els.editCanvas.addEventListener('mouseup', endEdit);
els.editCanvas.addEventListener('mouseout', endEdit);

function getPos(e) {
    const rect = els.editCanvas.getBoundingClientRect();
    const scaleX = els.editCanvas.width / rect.width;
    const scaleY = els.editCanvas.height / rect.height;
    return { x: (e.clientX - rect.left)*scaleX, y: (e.clientY - rect.top)*scaleY };
}

function startEdit(e) {
    if(editorState.tool === 'move' || editorState.tool === 'text') return;
    isDrag = true;
    lastPos = getPos(e);
    moveEdit(e); // é»æ“Šå³ç•«
}

function moveEdit(e) {
    if(!isDrag) return;
    const pos = getPos(e);
    const size = parseInt(document.getElementById('brushSize').value);
    
    let ctx = null;
    
    if(editorState.tool === 'eraser') {
        // æ©¡çš®æ“¦ï¼šç•«åœ¨ tempEraser ä¸Š (ç™½è‰²)
        ctx = editorState.tempEraser.getContext('2d');
        ctx.globalCompositeOperation = 'source-over';
        ctx.fillStyle = '#FFFFFF';
        ctx.beginPath(); ctx.arc(pos.x, pos.y, size/2, 0, Math.PI*2); ctx.fill();
        
        // åŒæ™‚è¦æŠŠ Restore å±¤å°æ‡‰ä½ç½®æ“¦æ‰ (ä¸ç„¶æœƒå‡ºç¾çŸ›ç›¾)
        const rCtx = editorState.tempRestore.getContext('2d');
        rCtx.globalCompositeOperation = 'destination-out';
        rCtx.beginPath(); rCtx.arc(pos.x, pos.y, size/2, 0, Math.PI*2); rCtx.fill();
        
    } else if(editorState.tool === 'restore') {
        // é‚„åŸï¼šç•«åœ¨ tempRestore ä¸Š (ç™½è‰²)
        ctx = editorState.tempRestore.getContext('2d');
        ctx.globalCompositeOperation = 'source-over';
        ctx.fillStyle = '#FFFFFF';
        ctx.beginPath(); ctx.arc(pos.x, pos.y, size/2, 0, Math.PI*2); ctx.fill();
        
        // åŒæ™‚è¦æŠŠ Eraser å±¤å°æ‡‰ä½ç½®æ“¦æ‰
        const eCtx = editorState.tempEraser.getContext('2d');
        eCtx.globalCompositeOperation = 'destination-out';
        eCtx.beginPath(); eCtx.arc(pos.x, pos.y, size/2, 0, Math.PI*2); eCtx.fill();
        
    } else if(editorState.tool === 'pen') {
        ctx = editorState.tempDoodle.getContext('2d');
        ctx.strokeStyle = document.getElementById('penColor').value;
        ctx.lineWidth = size;
        ctx.lineCap = 'round';
        ctx.beginPath(); ctx.moveTo(lastPos.x, lastPos.y); ctx.lineTo(pos.x, pos.y); ctx.stroke();
    }
    
    lastPos = pos;
    renderEditorCanvas();
}

function endEdit() {
    if(isDrag) { isDrag = false; saveHistory(); }
}

// è“‹å°æ–‡å­—
function stampText() {
    const text = document.getElementById('textInput').value;
    if(!text) return;
    const ctx = editorState.tempDoodle.getContext('2d');
    const size = document.getElementById('textSize').value;
    
    ctx.font = `bold ${size}px Arial`;
    ctx.fillStyle = document.getElementById('textColor').value;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    
    const cx = editorState.tempDoodle.width / 2;
    const cy = editorState.tempDoodle.height / 2;
    
    // ç™½é‚Š
    ctx.strokeStyle = 'white'; ctx.lineWidth = 4;
    ctx.strokeText(text, cx, cy);
    ctx.fillText(text, cx, cy);
    
    renderEditorCanvas();
    saveHistory();
}

function clearDrawings() {
    if(!confirm('æ¸…é™¤æ‰€æœ‰æ‰‹ç¹ªå…§å®¹ï¼Ÿ')) return;
    const w = els.editCanvas.width; const h = els.editCanvas.height;
    editorState.tempEraser.getContext('2d').clearRect(0,0,w,h);
    editorState.tempRestore.getContext('2d').clearRect(0,0,w,h);
    editorState.tempDoodle.getContext('2d').clearRect(0,0,w,h);
    renderEditorCanvas();
    saveHistory();
}

// Undo / Redo
function saveHistory() {
    if(editorState.historyIndex < editorState.history.length - 1) {
        editorState.history = editorState.history.slice(0, editorState.historyIndex + 1);
    }
    editorState.history.push({
        eraser: cloneCanvas(editorState.tempEraser),
        restore: cloneCanvas(editorState.tempRestore),
        doodle: cloneCanvas(editorState.tempDoodle)
    });
    if(editorState.history.length > 20) editorState.history.shift();
    editorState.historyIndex = editorState.history.length - 1;
}

function editorUndo() {
    if(editorState.historyIndex > 0) {
        editorState.historyIndex--;
        loadHistory(editorState.history[editorState.historyIndex]);
    }
}

function editorRedo() {
    if(editorState.historyIndex < editorState.history.length - 1) {
        editorState.historyIndex++;
        loadHistory(editorState.history[editorState.historyIndex]);
    }
}

function loadHistory(state) {
    editorState.tempEraser = cloneCanvas(state.eraser);
    editorState.tempRestore = cloneCanvas(state.restore);
    editorState.tempDoodle = cloneCanvas(state.doodle);
    renderEditorCanvas();
}

// ä¿å­˜ç·¨è¼¯
async function saveEditor() {
    const item = stickersData[currentEditId];
    
    // å°‡ç·¨è¼¯å™¨çš„ Canvas å¯«å› item
    item.eraserCanvas = cloneCanvas(editorState.tempEraser);
    item.restoreCanvas = cloneCanvas(editorState.tempRestore);
    item.doodleCanvas = cloneCanvas(editorState.tempDoodle);
    
    // å„²å­˜åƒæ•¸
    if(!item.settings) item.settings = {};
    item.settings.tolerance = parseInt(document.getElementById('e_tolerance').value);
    item.settings.shrink = parseFloat(document.getElementById('e_shrink').value);
    
    await renderAllStickers();
    closeEditor();
}

// æ‰¹æ¬¡è¤‡è£½
function copySettingsToAll() {
    if(!confirm('é€™å°‡è¦†è“‹æ‰€æœ‰è²¼åœ–çš„ã€Œå¯¬å®¹åº¦ã€èˆ‡ã€Œå…§ç¸®ã€è¨­å®šï¼Œç¢ºå®šå—ï¼Ÿ')) return;
    const t = parseInt(document.getElementById('e_tolerance').value);
    const s = parseFloat(document.getElementById('e_shrink').value);
    
    stickersData.forEach(item => {
        if(!item.settings) item.settings = {};
        item.settings.tolerance = t;
        item.settings.shrink = s;
    });
    alert('å·²æ‡‰ç”¨ï¼è«‹é»æ“Šã€Œå®Œæˆç·¨è¼¯ã€ä»¥æ›´æ–°é è¦½ã€‚');
}

// =========================================
// åœ–ç‰‡æª¢è¦– & ä¸‹è¼‰ & å…¶ä»–
// =========================================
window.viewImage = (url) => {
    els.viewImg.src = url;
    els.viewImg.classList.remove('zoomed');
    els.viewModal.style.display = 'block';
};
window.closeViewModal = () => { els.viewModal.style.display = 'none'; };
els.viewImg.onclick = (e) => { e.stopPropagation(); els.viewImg.classList.toggle('zoomed'); };

window.downloadOne = (url, idx) => {
    saveAs(dataURLtoBlob(url), getFilename(idx));
};

window.downloadAll = () => {
    const zip = new JSZip();
    const quality = els.compressPng.checked ? 0.8 : 1.0;
    
    document.querySelectorAll('.img-box img').forEach((img, i) => {
        const data = img.src.split(',')[1];
        zip.file(getFilename(i), data, {base64: true});
    });
    
    if (selectedMainIdx !== -1 && rawStickers[selectedMainIdx]) { /* Main Logic if needed */ }
    
    zip.generateAsync({type:"blob"}).then(c => saveAs(c, "LineStickers_V29.zip"));
};

function dataURLtoBlob(u) {
    var arr=u.split(','),m=arr[0].match(/:(.*?);/)[1],b=atob(arr[1]),n=b.length,a=new Uint8Array(n);
    while(n--)a[n]=b.charCodeAt(n);
    return new Blob([a],{type:m});
}

function getGlobalSettings() {
    return {
        targetColor: els.targetColor.value,
        tolerance: parseInt(els.tolerance.value),
        smoothness: parseFloat(els.smoothness.value),
        shrink: parseFloat(els.shrink.value),
        defringe: parseInt(els.defringe.value),
        contour: parseInt(els.contour.value),
        contourColor: els.contourColor.value,
        shadowOpacity: parseInt(els.shadowOpacity.value) / 100,
        shadowColor: els.shadowColor.value,
        autoCenter: els.autoCenter.checked
    };
}

function hexToRgb(hex) {
    return {
        r: parseInt(hex.slice(1,3), 16),
        g: parseInt(hex.slice(3,5), 16),
        b: parseInt(hex.slice(5,7), 16)
    };
}

function updateBg() {
    document.querySelectorAll('.img-box').forEach(div => {
        div.className = 'img-box ' + (window.currentBgClass || '');
    });
}
window.setBg = (mode) => {
    window.currentBgClass = 'bg-'+mode;
    if(mode === 'dark') window.currentBgClass = ''; // default
    updateBg();
};

function toggleRefBox() { document.getElementById('refBox').classList.toggle('active'); }
function toggleTheme() { document.body.classList.toggle('light-mode'); }
function loadImage(src) { return new Promise(r => { const i=new Image(); i.onload=()=>r(i); i.src=src; }); }
function getFilename(i) { 
    const start = els.startNum.value;
    const num = parseInt(start) + i; 
    return num.toString().padStart(start.length, '0') + '.png';
}
function refreshPreviewNames() {
    document.querySelectorAll('.sticker-card').forEach((div, i) => {
        div.querySelector('.sticker-name').innerText = getFilename(i);
        // æ›´æ–°æŒ‰éˆ• onclick index (é€™è£¡ç‚ºäº†ç°¡åŒ–ï¼Œå»ºè­°é‡æ–°æ¸²æŸ“ renderAllStickers)
        // ç‚ºäº†æ•ˆèƒ½ï¼Œæˆ‘å€‘åªæ›´æ–° visual textï¼ŒæŒ‰éˆ•çš„ index é‚è¼¯å…¶å¯¦ä¾è³´ render é †åº
        // ä½†å› ç‚º Sortable å·²ç¶“æ›´å‹•äº† stickersData é™£åˆ—ï¼Œæ‰€ä»¥æˆ‘å€‘å¿…é ˆé‡ç¹ªæŒ‰éˆ•
    });
    // å› ç‚º DOM é †åºè®Šäº†ä½† stickersData ä¹Ÿè®Šäº†ï¼Œæœ€ä¿éšªæ˜¯é‡ç¹ª
    renderAllStickers(); 
}

// å„²å­˜è¨­å®š (Project Persistence)
function saveSettings() {
    const s = {
        rows: els.rows.value,
        cols: els.cols.value,
        tolerance: els.tolerance.value
    };
    localStorage.setItem('stickerTool_V29', JSON.stringify(s));
}
function loadSettings() {
    const s = JSON.parse(localStorage.getItem('stickerTool_V29'));
    if(s) {
        els.rows.value = s.rows || 4; els.cols.value = s.cols || 5;
        els.tolerance.value = s.tolerance;
    }
}
window.addEventListener('beforeunload', saveSettings);
document.getElementById('showGrid').addEventListener('change', drawRef);

</script>
</body>
</html>
