<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LINE 貼圖製作大師 (V25-35: GitHub 分離版)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/upng-js/2.1.0/UPNG.min.js"></script>
    
    <link rel="stylesheet" href="style.css">
</head>
<body class="">

<div class="header">
    <h1>LINE 貼圖製作大師 <span style="font-size:0.6em; color:var(--text-sub);">V25-35 GitHub版</span></h1>
    <button class="theme-btn" onclick="toggleTheme()" id="themeBtn">☀️ 切換明亮</button>
</div>

<div class="container">
    <div class="card sticky-sidebar">
        <div class="stepper">
            <div class="step-dot active" id="dot-1">1</div>
            <div class="step-dot" id="dot-2">2</div>
            <div class="step-dot" id="dot-3">3</div>
        </div>

        <div class="step-content">
            <div id="step-pane-1" class="step-pane active">
                <div class="section-box">
                    <div class="section-title">📷 上傳圖片</div>
                    <div class="upload-box" id="dropZone" 
                         onclick="document.getElementById('imgInput').click()" 
                         ondragover="event.preventDefault(); this.classList.add('drag-over');"
                         ondragleave="this.classList.remove('drag-over');"
                         ondrop="handleFileDrop(event)">
                        <div style="font-size:2rem; margin-bottom:10px;">📤</div>
                        <span id="fileName">點擊選取或拖放圖片</span>
                        <input type="file" id="imgInput" accept="image/*" style="display:none" onchange="handleFileSelect(event)">
                    </div>
                </div>
                <div style="color:var(--text-sub); font-size:0.9rem; padding:10px; line-height:1.5;">
                    💡 提示：可使用鍵盤 <span style="border:1px solid #666; padding:0 3px; border-radius:3px;">↑↓←→</span> 移動圖片。<br>
                    按住 <span style="border:1px solid #666; padding:0 3px; border-radius:3px;">Shift</span> 加速，按住 <span style="border:1px solid #666; padding:0 3px; border-radius:3px;">Ctrl</span> 縮放。
                </div>
            </div>

            <div id="step-pane-2" class="step-pane">
                <div class="section-box">
                    <div class="section-title">✂️ 裁切分割</div>
                    <div class="row" style="justify-content: flex-start; gap: 20px;">
                        <div style="display:flex; align-items:center;">
                            <span class="label-text" style="width:auto; margin-right:5px;">垂直(列)</span>
                            <input type="number" id="rows" value="4" min="1" class="input-mini">
                        </div>
                        <div style="display:flex; align-items:center;">
                            <span class="label-text" style="width:auto; margin-right:5px;">水平(行)</span>
                            <input type="number" id="cols" value="5" min="1" class="input-mini">
                        </div>
                    </div>
                    <div style="font-size:0.8rem; color:var(--text-sub); margin-top:5px;">
                        💡 勾選右側「微調模式」可進行 1px 極致微調
                    </div>
                </div>

                <div class="section-box" style="background: var(--group-bg);">
                    <div class="row">
                        <div class="label-group">
                            <span class="label-text">自動置中</span>
                            <span class="info-btn" onclick="showHelp('autoCenter')">?</span>
                        </div>
                        <div style="flex:1; display:flex; align-items:center;">
                            <input type="checkbox" id="autoCenter" checked>
                            <span style="margin-left:6px; color:var(--text-sub); font-size:0.85rem;">裁切並自動放大置中</span>
                        </div>
                    </div>
                </div>
            </div>

            <div id="step-pane-3" class="step-pane">
                <div class="section-box">
                    <div class="section-title">🎨 去背與後製</div>
                    <div class="row">
                        <div class="label-group"><span class="label-text">手動補強</span><span class="info-btn" onclick="showHelp('color')">?</span></div>
                        <input type="color" id="targetColor" value="#FFFFFF" style="flex:1;">
                        <button class="btn btn-secondary" style="flex:1; padding:2px; font-size:0.8rem;" onclick="setColor('#FFFFFF')">白</button>
                        <button class="btn btn-secondary" style="flex:1; padding:2px; font-size:0.8rem;" onclick="setColor('#00FF00')">綠</button>
                    </div>
                    <div class="row">
                        <div class="label-group"><span class="label-text">寬容度</span><span class="info-btn" onclick="showHelp('tolerance')">?</span></div>
                        <input type="range" id="tolerance" min="0" max="100" value="40">
                        <span class="input-mini" id="val-tolerance" style="text-align:right;">40%</span>
                    </div>
                    <hr style="border:0; border-top:1px dashed var(--border); margin:15px 0;">
                    <div class="row">
                        <div class="label-group"><span class="label-text">柔化</span><span class="info-btn" onclick="showHelp('smoothness')">?</span></div>
                        <input type="range" id="smoothness" min="0" max="10" step="0.5" value="0">
                        <span class="input-mini" id="val-smoothness" style="text-align:right;">0</span>
                    </div>
                    <div class="row">
                        <div class="label-group"><span class="label-text">邊緣內縮</span><span class="info-btn" onclick="showHelp('shrink')">?</span></div>
                        <input type="range" id="shrink" min="0" max="10" step="0.5" value="0">
                        <span class="input-mini" id="val-shrink" style="text-align:right;">0</span>
                    </div>
                    <div class="row">
                        <div class="label-group"><span class="label-text">邊緣淨化</span><span class="info-btn" onclick="showHelp('defringe')">?</span></div>
                        <input type="range" id="defringe" min="0" max="20" step="1" value="0">
                        <span class="input-mini" id="val-defringe" style="text-align:right;">0</span>
                    </div>
                    <div class="row">
                        <div class="label-group"><span class="label-text">描邊</span><span class="info-btn" onclick="showHelp('contour')">?</span></div>
                        <input type="range" id="contour" min="0" max="20" step="1" value="5">
                        <input type="color" id="contourColor" value="#FFFFFF" style="width:40px; flex:0 0 auto; margin-left:5px;" title="描邊顏色">
                        <span class="input-mini" id="val-contour" style="text-align:right;">5</span>
                    </div>
                    <div class="row">
                        <div class="label-group"><span class="label-text">陰影模糊</span><span class="info-btn" onclick="showHelp('shadow')">?</span></div>
                        <input type="range" id="shadowBlur" min="0" max="30" step="1" value="0">
                        <span class="input-mini" id="val-shadowBlur" style="text-align:right;">0</span>
                    </div>
                    <div class="row">
                        <div class="label-group"><span class="label-text">陰影距離</span></div>
                        <input type="range" id="shadowDist" min="0" max="20" step="1" value="2">
                        <span class="input-mini" id="val-shadowDist" style="text-align:right;">2</span>
                    </div>
                    <div class="row">
                        <div class="label-group"><span class="label-text">陰影濃度</span></div>
                        <input type="range" id="shadowOpacity" min="0" max="100" step="5" value="60">
                        <input type="color" id="shadowColor" value="#000000" style="width:40px; flex:0 0 auto; margin-left:5px;" title="陰影顏色">
                        <span class="input-mini" id="val-shadowOpacity" style="text-align:right;">60%</span>
                    </div>
                    <div class="row">
                        <div class="label-group"><span class="label-text">留白</span><span class="info-btn" onclick="showHelp('padding')">?</span></div>
                        <input type="range" id="padding" min="0" max="20" step="1" value="0">
                        <span class="input-mini" id="val-padding" style="text-align:right;">0%</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="nav-buttons">
            <button id="prevBtn" class="btn btn-secondary" onclick="changeStep(-1)" disabled>⬅ 上一步</button>
            <button id="nextBtn" class="btn btn-green" onclick="changeStep(1)">下一步 ➡</button>
            <button id="runBtn" class="btn btn-green" style="display:none;" disabled>🚀 開始製作</button>
        </div>
    </div>

    <div class="card">
        <div class="orig-ref-container" id="refContainer" tabindex="0">
            <div class="orig-header" onclick="toggleRefAccordion()">
                <div class="orig-label"><span class="orig-toggle-icon" id="refIcon">▼</span> 📌 原始圖參考</div>
                <div class="orig-controls-top" onclick="event.stopPropagation()">
                    <label style="display:flex; align-items:center; font-weight:normal; font-size:0.85rem; cursor:pointer;">
                        <input type="checkbox" id="showGrid" checked style="width:16px; height:16px; margin-right:5px;"> 顯示格線
                    </label>
                    <button class="btn btn-secondary" style="width:auto; padding:2px 8px; font-size:0.8rem;" onclick="toggleOrigSize()">預覽視窗縮放</button>
                </div>
            </div>
            <div class="orig-body">
                <div class="move-toolbar">
                    <label class="micro-switch" title="勾選後：移動1px / 縮放0.1%"><input type="checkbox" id="microMode"> 微調模式</label>
                    <div class="move-divider"></div>
                    <div class="move-group"><button class="move-btn" onclick="moveImg(0, 1)" title="放大">➕</button><button class="move-btn" onclick="moveImg(0, -1)" title="縮小">➖</button></div>
                    <div class="move-divider"></div>
                    <div class="move-group"><button class="move-btn" onclick="moveImg('y', 1)" title="上移">⬆️</button><button class="move-btn" onclick="moveImg('y', -1)" title="下移">⬇️</button><button class="move-btn" onclick="moveImg('x', 1)" title="左移">⬅️</button><button class="move-btn" onclick="moveImg('x', -1)" title="右移">➡️</button></div>
                    <div class="move-divider"></div>
                    <button class="move-btn" style="width:auto; font-size:0.9rem; padding:0 8px;" onclick="resetMove()">重置</button>
                </div>
                <div id="origPreviewBox">
                    <div id="origWrapper"><canvas id="refCanvas"></canvas><canvas id="gridCanvas"></canvas></div>
                    <div id="eyedropperHint">💡 點擊圖片可吸取顏色</div>
                    <div id="placeholderText" class="placeholder-text">請先在左側上傳圖片...</div>
                </div>
            </div>
        </div>

        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>🖼️ 匯出與預覽</h2>
            <div class="bg-toggles">
                <div class="bg-toggle-btn active" style="background:#222;" onclick="setPreviewBg(this, 'dark')" title="暗黑底"></div>
                <div class="bg-toggle-btn" style="background:#849ebf;" onclick="setPreviewBg(this, 'line')" title="LINE 聊天室"></div>
                <div class="bg-toggle-btn" style="background:#ffffff;" onclick="setPreviewBg(this, 'light')" title="白底"></div>
                <div class="bg-toggle-btn" style="background:#ffe6f2;" onclick="setPreviewBg(this, 'pink')" title="淺粉底"></div>
                <div class="bg-toggle-btn" style="background:#fffde7;" onclick="setPreviewBg(this, 'yellow')" title="淺黃底"></div>
            </div>
        </div>
        
        <div class="export-bar">
            <div class="export-group-box" style="min-width: 100px; flex: 0 0 auto;">
                <div class="export-label-row"><span class="export-label-text">起始檔名</span></div>
                <input type="text" id="startNum" value="001" class="input-short" placeholder="001">
            </div>
            <div class="export-group-box" style="flex:1;">
                <div class="export-label-row"><span class="export-label-text">尺寸模式</span></div>
                <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                    <select id="sizePreset" style="flex:1; min-width:80px;">
                        <option value="custom">✍️ 自訂</option>
                        <option value="sticker">😃 貼圖</option>
                        <option value="emoji">😘 表情</option>
                    </select>
                    <div style="display:flex; gap:5px; align-items:center;">
                        <input type="number" id="outW" value="370" class="input-mini"><span>x</span><input type="number" id="outH" value="320" class="input-mini">
                    </div>
                </div>
            </div>
            <div class="export-group-box" style="flex: 0 0 auto; display: flex; align-items: center;">
                <label style="font-size: 0.85rem; cursor: pointer; display: flex; align-items: center;">
                    <input type="checkbox" id="compressPNG" checked style="margin-right: 5px;">
                    📉 智能壓縮<br>(防止退件)
                </label>
            </div>
            <div style="display:flex; align-items:center;">
                <button id="dlBtn" class="btn btn-green" style="height:100%; padding:0 20px;">下載全部 ZIP</button>
            </div>
        </div>

        <div id="previewContainer">
            <div style="grid-column:1/-1; text-align:center; color:#666; padding:50px;">請點擊左側「開始製作」</div>
        </div>
    </div>
</div>

<div class="footer" id="footerText"></div>
<div id="imageModal" class="modal" onclick="closeModal()"><span class="modal-close">&times;</span><img class="modal-content" id="modalImg"></div>
<div id="helpModal" class="modal" onclick="closeHelp()">
    <div class="help-modal-content" onclick="event.stopPropagation()">
        <div class="help-title">💡 功能說明</div>
        <div id="helpText" class="help-text"></div>
        <button class="btn btn-green" style="margin-top:20px; width:100%;" onclick="closeHelp()">知道了</button>
    </div>
</div>

<div id="editModal" class="modal">
    <div class="edit-modal-content">
        <h3 style="margin-top:0; display:flex; justify-content:space-between;">
            <span>✏️ 單張修圖 (Sticker #<span id="editIdx"></span>)</span>
            <span style="font-size:0.8rem; font-weight:normal; color:var(--text-sub);">Ctrl+Z 復原 / Ctrl+Y 重做</span>
        </h3>
        
        <div class="paint-toolbar">
            <button class="tool-btn" id="undoBtn" onclick="undoAction()" title="復原 (Ctrl+Z)">↩</button>
            <button class="tool-btn" id="redoBtn" onclick="redoAction()" title="重做 (Ctrl+Y)">↪</button>
            <div class="tool-divider"></div>
            
            <button class="tool-btn" id="eraserBtn" onclick="setTool('eraser')" title="擦除不要的部分">🧽 橡皮擦</button>
            <button class="tool-btn" id="restoreBtn" onclick="setTool('restore')" title="畫回被誤刪的部分">🖌️ 還原筆刷</button>
            <button class="tool-btn" id="brushBtn" onclick="setTool('brush')" title="自由塗鴉">✏️ 塗鴉</button>
            <button class="tool-btn" id="textBtn" onclick="setTool('text')" title="新增文字">T 文字</button>
            
            <div class="tool-divider"></div>
            <div class="tool-options" id="toolOptions">
                <span id="toolLabel" style="font-size:0.8rem;">大小:</span>
                <input type="range" id="brushSize" min="1" max="50" value="10" class="size-slider">
                <input type="range" id="textRotate" min="-180" max="180" value="0" class="size-slider" style="display:none;" title="旋轉角度">
                <input type="range" id="textSize" min="10" max="100" value="30" class="size-slider" style="display:none;" title="文字大小">
                <input type="color" id="brushColor" value="#ff0000" style="width:24px; height:24px; padding:0; border:none; display:none;">
            </div>
        </div>

        <div class="text-input-group" id="textControls">
            <input type="text" id="addTextInput" placeholder="輸入文字..." style="flex:1;">
            <input type="color" id="textColor" value="#000000" title="文字顏色">
            <input type="color" id="textStroke" value="#ffffff" title="描邊顏色 (預設白)">
            <button class="btn btn-secondary" style="width:auto; padding:5px 10px; background:var(--primary); color:white; font-weight:bold;" onclick="addPendingText()">新增文字</button>
        </div>
        <div id="textConfirmControls" style="display:none; width:100%; margin-top:5px; background:var(--header-hover); padding:8px; border-radius:6px; justify-content:center; gap:10px;">
            <span style="font-size:0.9rem; color:var(--text-main);">調整好位置與大小了嗎？</span>
            <button class="btn btn-green" style="width:auto; padding:5px 15px;" onclick="confirmText()">✅ 確認套用</button>
            <button class="btn btn-secondary" style="width:auto; padding:5px 10px;" onclick="cancelText()">❌ 取消</button>
        </div>

        <div class="edit-preview-box" id="editPreviewBox"><canvas id="editCanvas"></canvas></div>
        
        <div class="row"><div class="label-group"><span class="label-text">寬容度</span></div><input type="range" id="e_tolerance" min="0" max="100"><span class="input-mini" id="v_e_tolerance"></span></div>
        <div class="row"><div class="label-group"><span class="label-text">柔化</span></div><input type="range" id="e_smoothness" min="0" max="10" step="0.5"><span class="input-mini" id="v_e_smoothness"></span></div>
        <div class="row"><div class="label-group"><span class="label-text">邊緣內縮</span></div><input type="range" id="e_shrink" min="0" max="10" step="0.5"><span class="input-mini" id="v_e_shrink"></span></div>
        <div class="row"><div class="label-group"><span class="label-text">邊緣淨化</span></div><input type="range" id="e_defringe" min="0" max="20" step="1"><span class="input-mini" id="v_e_defringe"></span></div>

        <div style="display:flex; flex-wrap:wrap; gap:10px; margin-top:20px;">
            <button class="btn btn-secondary" style="flex:1;" onclick="closeEditModal()">取消</button>
            <button class="btn btn-secondary" style="flex:1; background:#5e60ce; color:white; border-color:#5e60ce;" onclick="applyToAll()">⚡ 參數套用全部</button>
            <button class="btn btn-green" style="flex:1;" onclick="saveEdit()" id="saveEditBtn">✅ 保存修改</button>
        </div>
    </div>
</div>

<script src="script.js"></script>

</body>
</html>
