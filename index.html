<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Line è²¼åœ–åˆ‡å‰² & å»èƒŒå·¥å…·ï¼ˆä¿®å¾©ç‰ˆï¼‰</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    /* CSS å„ªåŒ–èˆ‡éŸ¿æ‡‰å¼è¨­è¨ˆ */
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
    body { background: #f0f2f5; padding: 20px; color: #333; line-height: 1.6; }
    
    .container {
      display: flex;
      gap: 20px;
      max-width: 1200px;
      margin: 0 auto;
      align-items: flex-start;
    }

    /* æ‰‹æ©Ÿç‰ˆéŸ¿æ‡‰å¼ï¼šè®Šç‚ºå–®æ¬„å‚ç›´æ’åˆ— */
    @media (max-width: 768px) {
      .container { flex-direction: column; }
      .panel { width: 100%; }
    }

    .panel {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      flex: 1;
      width: 50%; /* æ¡Œé¢ç‰ˆé è¨­ */
    }

    h2 { margin-bottom: 20px; color: #1a1a1a; font-size: 1.4rem; display: flex; align-items: center; gap: 8px; }
    h3 { font-size: 16px; margin: 15px 0 10px; color: #555; }
    
    label { display: block; margin: 15px 0 5px; font-weight: 600; font-size: 0.95rem; color: #444; }
    
    input[type="file"], input[type="number"], select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 15px;
      background-color: #fff;
    }

    /* æ»‘æ¡¿æ¨£å¼å„ªåŒ– */
    .range-wrapper { display: flex; align-items: center; gap: 10px; }
    input[type="range"] { flex: 1; cursor: pointer; }
    #borderValue { font-weight: bold; min-width: 30px; text-align: right; }

    button {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 15px;
      transition: all 0.2s;
      margin-top: 20px;
    }

    #processBtn { background: #00B900; color: white; } /* LINE Green */
    #processBtn:hover { background: #009900; }
    #processBtn:disabled { background: #ccc; cursor: not-allowed; }

    #downloadFullBtn { background: #3498db; color: white; margin-top: 10px; }
    #downloadFullBtn:hover { background: #2980b9; }

    #downloadBtn { background: #2c3e50; color: white; margin-top: 10px; }
    #downloadBtn:hover { background: #1a252f; }

    .status {
      margin-top: 15px;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 8px;
      font-size: 0.9rem;
      color: #666;
      border-left: 4px solid #ddd;
    }
    .status.error { border-left-color: #e74c3c; background: #fdedec; color: #c0392b; }
    .status.success { border-left-color: #00B900; background: #e8f8e8; color: #27ae60; }

    #previewArea {
      display: grid;
      gap: 15px;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      margin-top: 20px;
    }

    .sticker-preview {
      border: 1px solid #eee;
      border-radius: 8px;
      overflow: hidden;
      aspect-ratio: 1;
      background-image: linear-gradient(45deg, #efefef 25%, transparent 25%), linear-gradient(-45deg, #efefef 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #efefef 75%), linear-gradient(-45deg, transparent 75%, #efefef 75%);
      background-size: 20px 20px;
      background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .sticker-preview img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="panel">
      <h2>ğŸ“Œ è¨­å®šèˆ‡ä¸Šå‚³</h2>
      <input type="file" id="imageInput" accept="image/*" />
      
      <div style="display: flex; gap: 15px;">
        <div style="flex:1;">
          <label>åˆ—æ•¸ (å‚ç›´)</label>
          <input type="number" id="rows" min="1" value="2" />
        </div>
        <div style="flex:1;">
          <label>è¡Œæ•¸ (æ°´å¹³)</label>
          <input type="number" id="cols" min="1" value="2" />
        </div>
      </div>
      
      <label>å»èƒŒè™•ç†</label>
      <select id="removeBg">
        <option value="none">ä¸è™•ç† (åƒ…åˆ‡å‰²)</option>
        <option value="rembg" selected>AI è‡ªå‹•å»èƒŒ (u2netp)</option>
      </select>
      
      <label>ç™½é‚Šå¯¬åº¦ (px)</label>
      <div class="range-wrapper">
        <input type="range" id="borderSize" min="0" max="10" value="0" step="1" />
        <span id="borderValue">0</span>
      </div>
      
      <button id="processBtn">âœ‚ï¸ é–‹å§‹è£½ä½œè²¼åœ–</button>
      
      <div class="status" id="status">æº–å‚™å°±ç·’ï¼Œè«‹ä¸Šå‚³åœ–ç‰‡ã€‚</div>
      <div id="modelHelp" style="display:none; margin-top:10px; font-size:0.9em;">
        <a href="https://github.com/danielgatis/rembg/releases/download/v0.0.0/u2netp.onnx" target="_blank" style="color:#e74c3c;">
          âš ï¸ æ¨¡å‹è¼‰å…¥å¤±æ•—ï¼Ÿé»æ­¤ä¸‹è¼‰ u2netp.onnx
        </a><br>
        ä¸‹è¼‰å¾Œè«‹å‹™å¿…æ”¾åœ¨èˆ‡æ­¤ç¶²é ç›¸åŒçš„è³‡æ–™å¤¾ä¸­ã€‚
      </div>
    </div>

    <div class="panel">
      <h2>ğŸ–¼ï¸ é è¦½èˆ‡ä¸‹è¼‰</h2>
      <div id="previewArea"></div>
      <div class="btn-row">
        <button id="downloadFullBtn" style="display: none;">ğŸ“¥ ä¸‹è¼‰å®Œæ•´å»èƒŒåœ–</button>
        <button id="downloadBtn" style="display: none;">ğŸ“¦ ä¸‹è¼‰è²¼åœ–åŒ… (ZIP)</button>
      </div>
    </div>
  </div>

  <script type="module">
    // 1. ä¿®æ­£åŒ¯å…¥æ–¹å¼ï¼šå°‡æ¨¡çµ„å–åç‚º ortModule
    import * as ortModule from 'https://cdn.jsdelivr.net/npm/onnxruntime-web@1.14.0/dist/ort.min.js';

    // 2. é—œéµä¿®æ­£ï¼šæª¢æŸ¥æ˜¯å¦å­˜åœ¨ default å±¬æ€§ï¼Œè§£æ±º 'wasm' undefined éŒ¯èª¤
    const ort = ortModule.default || ortModule;

    // 3. è¨­å®š WASM è·¯å¾‘ (æŒ‡å‘ CDNï¼Œé¿å…åœ¨ GitHub Pages æ‰¾ä¸åˆ°æª”æ¡ˆ)
    ort.env.wasm.wasmPaths = "https://cdn.jsdelivr.net/npm/onnxruntime-web@1.14.0/dist/";

    const model_url = 'https://github.com/danielgatis/rembg/releases/download/v0.0.0/u2netp.onnx';
    let session = null;

    // UI ç¶å®š
    const statusEl = document.getElementById('status');
    const modelHelpEl = document.getElementById('modelHelp');
    
    document.getElementById('borderSize').addEventListener('input', e => {
      document.getElementById('borderValue').textContent = e.target.value;
    });

    // åˆå§‹åŒ– AI æ¨¡å‹
    async function initRembg() {
      if (session) return session;
      
      statusEl.textContent = 'ğŸ”„ æ­£åœ¨è¼‰å…¥ AI æ¨¡å‹ (é¦–æ¬¡éœ€æ™‚è¼ƒé•·)...';
      statusEl.className = 'status';
      modelHelpEl.style.display = 'none';

      try {
        session = await ort.InferenceSession.create(model_url, {
          executionProviders: ['webgl', 'wasm'], // å„ªå…ˆä½¿ç”¨ GPU
        });
        statusEl.textContent = 'âœ… æ¨¡å‹è¼‰å…¥æˆåŠŸï¼';
        statusEl.className = 'status success';
        return session;
      } catch (e) {
        console.error('Model load error:', e);
        statusEl.textContent = 'âŒ æ¨¡å‹è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¢ºèª u2netp.onnx æ˜¯å¦å­˜åœ¨ã€‚';
        statusEl.className = 'status error';
        modelHelpEl.style.display = 'block'; // é¡¯ç¤ºä¸‹è¼‰æç¤º
        throw e;
      }
    }

    // åœ–ç‰‡é è™•ç†ï¼šç¸®æ”¾ (æ•ˆèƒ½å„ªåŒ–é—œéµ)
    function resizeImage(img, maxDim = 1024) {
      const w = img.width;
      const h = img.height;
      if (w <= maxDim && h <= maxDim) return img; // ä¸éœ€è¦ç¸®æ”¾

      const scale = Math.min(maxDim / w, maxDim / h);
      const canvas = document.createElement('canvas');
      canvas.width = w * scale;
      canvas.height = h * scale;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      
      // å›å‚³ä¸€å€‹æ–°çš„ Image ç‰©ä»¶
      const newImg = new Image();
      newImg.src = canvas.toDataURL();
      return new Promise(resolve => {
        newImg.onload = () => resolve(newImg);
      });
    }

    // å»èƒŒæ ¸å¿ƒé‚è¼¯
    async function removeBackground(imgElement) {
      const session = await initRembg();
      
      // ç¢ºä¿è¼¸å…¥å°ºå¯¸æ­£ç¢º
      const width = imgElement.width;
      const height = imgElement.height;
      
      const canvas = document.createElement('canvas');
      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(imgElement, 0, 0);

      const imageData = ctx.getImageData(0, 0, width, height);
      const data = imageData.data;
      
      // æ­£è¦åŒ–è™•ç† (Standard ImageNet normalization)
      const floatArr = new Float32Array(width * height * 3);
      for (let i = 0; i < data.length; i += 4) {
        // R
        floatArr[i / 4] = (data[i] / 255 - 0.485) / 0.229;
        // G
        floatArr[i / 4 + width * height] = (data[i + 1] / 255 - 0.456) / 0.224;
        // B
        floatArr[i / 4 + 2 * width * height] = (data[i + 2] / 255 - 0.406) / 0.225;
      }

      const tensor = new ort.Tensor('float32', floatArr, [1, 3, height, width]);
      const results = await session.run({ input: tensor });
      const output = results['output'].data;

      // æ‡‰ç”¨é®ç½©
      const newCanvas = document.createElement('canvas');
      newCanvas.width = width;
      newCanvas.height = height;
      const newCtx = newCanvas.getContext('2d');
      const newImageData = newCtx.createImageData(width, height);
      
      for (let i = 0; i < width * height; i++) {
        const maskVal = output[i];
        // ç°¡å–®çš„é–¾å€¼è™•ç†ï¼Œè®“é‚Šç·£ç¨å¾®ä¹¾æ·¨é»
        const alpha = Math.max(0, Math.min(255, maskVal * 255));
        
        newImageData.data[i * 4] = data[i * 4];         // R
        newImageData.data[i * 4 + 1] = data[i * 4 + 1]; // G
        newImageData.data[i * 4 + 2] = data[i * 4 + 2]; // B
        newImageData.data[i * 4 + 3] = alpha;           // A
      }
      newCtx.putImageData(newImageData, 0, 0);
      return newCanvas.toDataURL('image/png');
    }

    // å·¥å…·å‡½æ•¸
    function loadImage(src) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.onload = () => resolve(img);
        img.onerror = () => reject(new Error('åœ–ç‰‡è®€å–å¤±æ•—'));
        img.src = src;
      });
    }

    // ä¸»æµç¨‹
    let fullBgRemovedImage = null;
    let processedStickers = [];

    document.getElementById('processBtn').addEventListener('click', async () => {
      const file = document.getElementById('imageInput').files[0];
      if (!file) {
        alert('è«‹å…ˆé¸æ“‡ä¸€å¼µåœ–ç‰‡ï¼');
        return;
      }

      // é‡ç½®ç‹€æ…‹
      fullBgRemovedImage = null;
      processedStickers = [];
      document.getElementById('downloadFullBtn').style.display = 'none';
      document.getElementById('downloadBtn').style.display = 'none';
      document.getElementById('previewArea').innerHTML = '';
      
      const btn = document.getElementById('processBtn');
      btn.disabled = true;
      statusEl.className = 'status';

      try {
        let img = await loadImage(URL.createObjectURL(file));

        // æ­¥é©Ÿ 1: å¦‚æœåœ–ç‰‡å¤ªå¤§ï¼Œå…ˆç¸®å° (é¿å…ç•¶æ©Ÿ)
        statusEl.textContent = 'ğŸ” æ­£åœ¨æœ€ä½³åŒ–åœ–ç‰‡å°ºå¯¸...';
        // é€™è£¡è¨­å®šç¸®æ”¾åˆ° 1024ï¼Œå°å»èƒŒå“è³ªå½±éŸ¿å¾ˆå°ä½†é€Ÿåº¦å¿«å¾ˆå¤š
        img = await resizeImage(img, 1024);

        // æ­¥é©Ÿ 2: å»èƒŒ (å¦‚æœéœ€è¦)
        const removeBgMode = document.getElementById('removeBg').value;
        if (removeBgMode === 'rembg') {
          statusEl.textContent = 'ğŸ¤– æ­£åœ¨é€²è¡Œ AI æ™ºæ…§å»èƒŒ...';
          const nobgDataUrl = await removeBackground(img);
          fullBgRemovedImage = nobgDataUrl;
          img = await loadImage(nobgDataUrl);
        }

        // æ­¥é©Ÿ 3: åˆ‡å‰²
        statusEl.textContent = 'âœ‚ï¸ æ­£åœ¨åˆ‡å‰²ä¸¦åŠ ä¸Šé‚Šæ¡†...';
        const rows = parseInt(document.getElementById('rows').value) || 2;
        const cols = parseInt(document.getElementById('cols').value) || 2;
        const borderSize = parseInt(document.getElementById('borderSize').value) || 0;

        const stickers = await cutImage(img, rows, cols, borderSize);
        renderPreviews(stickers);
        processedStickers = stickers;

        // å®Œæˆ
        if (fullBgRemovedImage) document.getElementById('downloadFullBtn').style.display = 'block';
        document.getElementById('downloadBtn').style.display = 'block';
        statusEl.textContent = `âœ… æˆåŠŸï¼å·²ç”¢ç”Ÿ ${stickers.length} å¼µè²¼åœ–ã€‚`;
        statusEl.className = 'status success';

      } catch (err) {
        console.error(err);
        statusEl.textContent = `âŒ éŒ¯èª¤ï¼š${err.message}`;
        statusEl.className = 'status error';
      } finally {
        btn.disabled = false;
      }
    });

    async function cutImage(img, rows, cols, borderSize) {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      
      const w = img.width;
      const h = img.height;
      const tileW = Math.floor(w / cols);
      const tileH = Math.floor(h / rows);
      
      const stickers = [];
      let index = 1;

      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          // åˆ‡å‰²
          canvas.width = tileW;
          canvas.height = tileH;
          ctx.clearRect(0, 0, tileW, tileH);
          ctx.drawImage(img, c * tileW, r * tileH, tileW, tileH, 0, 0, tileW, tileH);
          
          // ç¸®æ”¾åˆ° 180x180 (Line è²¼åœ–è¦æ ¼)
          const finalCanvas = document.createElement('canvas');
          finalCanvas.width = 180;
          finalCanvas.height = 180;
          const finalCtx = finalCanvas.getContext('2d');
          
          // è¨ˆç®—ä¿æŒæ¯”ä¾‹çš„ç¸®æ”¾
          const tempImg = await loadImage(canvas.toDataURL());
          const scale = Math.min(180 / tempImg.width, 180 / tempImg.height);
          const newW = tempImg.width * scale;
          const newH = tempImg.height * scale;
          const x = (180 - newW) / 2;
          const y = (180 - newH) / 2;

          finalCtx.drawImage(tempImg, x, y, newW, newH);

          // é‚Šæ¡†ç¹ªè£½é‚è¼¯
          if (borderSize > 0) {
            // Line è²¼åœ–é€šå¸¸ç”¨ç™½é‚Šï¼Œé€™è£¡æˆ‘é è¨­æ”¹ç‚ºç™½è‰²
            // å¦‚æœä½ å …æŒè¦é»‘é‚Šï¼Œè«‹æŠŠ 'white' æ”¹å› 'black'
            finalCtx.strokeStyle = 'white'; 
            
            // æŠ€å·§ï¼šç·šå¯¬è¨­ç‚º 2 å€ï¼Œç•«åœ¨é‚Šç·£
            finalCtx.lineWidth = borderSize * 2; 
            finalCtx.strokeRect(0, 0, 180, 180);
          }

          stickers.push({
            dataUrl: finalCanvas.toDataURL('image/png'),
            filename: String(index).padStart(3, '0') + '.png'
          });
          index++;
        }
      }
      return stickers;
    }

    function renderPreviews(stickers) {
      const area = document.getElementById('previewArea');
      
      // é¡¯ç¤ºå®Œæ•´å»èƒŒåœ–é è¦½
      if (fullBgRemovedImage) {
        const div = document.createElement('div');
        div.style.gridColumn = '1 / -1';
        div.innerHTML = `<h3>ğŸ” å®Œæ•´å»èƒŒçµæœ</h3><img src="${fullBgRemovedImage}" style="max-height:200px; border:1px solid #ccc; background:url('data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' width=\'10\' height=\'10\'><rect width=\'10\' height=\'10\' fill=\'white\'/><rect x=\'0\' y=\'0\' width=\'5\' height=\'5\' fill=\'%23eee\'/><rect x=\'5\' y=\'5\' width=\'5\' height=\'5\' fill=\'%23eee\'/></svg>');">`;
        area.appendChild(div);
      }

      stickers.forEach(s => {
        const div = document.createElement('div');
        div.className = 'sticker-preview';
        div.innerHTML = `<img src="${s.dataUrl}">`;
        area.appendChild(div);
      });
    }

    // ä¸‹è¼‰åŠŸèƒ½
    document.getElementById('downloadFullBtn').addEventListener('click', () => {
      saveAs(fullBgRemovedImage, 'removed_bg_full.png');
    });

    document.getElementById('downloadBtn').addEventListener('click', () => {
      const zip = new JSZip();
      const timestamp = new Date().toISOString().slice(0,10).replace(/-/g,'');
      processedStickers.forEach(s => {
        zip.file(s.filename, s.dataUrl.split(',')[1], { base64: true });
      });
      zip.generateAsync({ type: 'blob' }).then(content => {
        saveAs(content, `line_stickers_${timestamp}.zip`);
      });
    });
  </script>
</body>
</html>
