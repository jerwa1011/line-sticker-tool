<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINE è²¼åœ–è£½ä½œå¤§å¸« (V4: é˜²è®Šå½¢+é›™æ¨¡å‹ç‰ˆ)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.18.0/dist/ort.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        :root { --primary: #06C755; --bg: #f0f2f5; }
        body { font-family: "Segoe UI", sans-serif; background: var(--bg); padding: 20px; color: #333; }
        .container { max-width: 1100px; margin: 0 auto; display: grid; grid-template-columns: 380px 1fr; gap: 20px; }
        @media (max-width: 850px) { .container { grid-template-columns: 1fr; } }
        
        .card { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        h1 { grid-column: 1/-1; text-align: center; margin-bottom: 20px; color: #444; }
        
        .upload-box { 
            border: 2px dashed #ccc; border-radius: 12px; padding: 40px 20px; text-align: center; 
            cursor: pointer; background: #fafafa; transition: 0.3s; position: relative;
        }
        .upload-box:hover { border-color: var(--primary); background: #f0fff4; }
        
        .btn { 
            width: 100%; padding: 14px; border: none; border-radius: 8px; font-weight: bold; 
            cursor: pointer; font-size: 16px; margin-top: 15px; transition: 0.2s;
        }
        .btn-green { background: var(--primary); color: white; box-shadow: 0 4px 6px rgba(6,199,85,0.2); }
        .btn-green:hover { background: #05b34c; transform: translateY(-1px); }
        .btn-green:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-outline { background: white; border: 2px solid #eee; color: #555; }
        .btn-outline:hover { border-color: #ddd; background: #f9f9f9; }

        .status-bar { 
            margin-top: 15px; padding: 12px; border-radius: 8px; font-size: 0.9em; 
            background: #e3f2fd; color: #0d47a1; display: flex; align-items: center; gap: 8px;
        }
        .status-error { background: #ffebee; color: #c62828; }
        .status-success { background: #e8f5e9; color: #2e7d32; }

        /* æ¨¡å‹é¸æ“‡å™¨ */
        .model-selector {
            background: #fff8e1; border: 1px solid #ffecb3; padding: 15px; border-radius: 8px; margin-bottom: 20px;
        }
        select { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ddd; margin-top: 5px; font-size: 1rem; }

        #manualLoad { display: none; margin-top: 15px; padding: 15px; border: 1px solid #fab1a0; background: #fff5f5; border-radius: 8px; }
        
        #previewGrid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-top: 15px; }
        .sticker { aspect-ratio: 1; border: 1px solid #eee; border-radius: 8px; display: flex; align-items: center; justify-content: center; overflow: hidden; background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"><rect width="10" height="10" fill="white"/><rect x="10" width="10" height="10" fill="%23eee"/><rect y="10" width="10" height="10" fill="%23eee"/><rect x="10" y="10" width="10" height="10" fill="white"/></svg>'); }
        .sticker img { max-width: 100%; max-height: 100%; }

        .control-group { margin-top: 20px; }
        .slider-label { display: flex; justify-content: space-between; font-size: 0.85em; color: #666; margin-bottom: 5px; }
        input[type="range"] { width: 100%; accent-color: var(--primary); cursor: pointer; }
        .row { display: flex; gap: 10px; } .col { flex: 1; }
        label { font-weight: 600; font-size: 0.9em; color: #444; }
    </style>
</head>
<body>

<div class="container">
    <h1>LINE è²¼åœ–è£½ä½œå¤§å¸« <span style="font-size:0.6em; color:#888;">V4 é˜²è®Šå½¢ç‰ˆ</span></h1>

    <div class="card">
        <div class="model-selector">
            <label>ğŸ§  é¸æ“‡ AI æ¨¡å‹</label>
            <select id="modelSelect">
                <option value="u2netp">ğŸš€ è¼•é‡ç‰ˆ (u2netp, 4.4MB) - é€Ÿåº¦å¿«</option>
                <option value="u2net">ğŸ’ª å°ˆæ¥­å®Œæ•´ç‰ˆ (u2net, 176MB) - ç•«è³ªæœ€å¼·</option>
            </select>
            <div style="font-size:0.8em; color:#856404; margin-top:5px;">
                * å®Œæ•´ç‰ˆç´„éœ€ä¸‹è¼‰ 1-3 åˆ†é˜ï¼Œè«‹ä½¿ç”¨ WiFiã€‚<br>
                * è‹¥è¼•é‡ç‰ˆå»èƒŒä¸ä¹¾æ·¨ï¼Œè«‹åˆ‡æ›è‡³å®Œæ•´ç‰ˆã€‚
            </div>
        </div>

        <div id="status" class="status-bar">ğŸ”„ æº–å‚™ä¸­...</div>

        <div id="manualLoad">
            <strong style="color:#d63031">âš ï¸ ç„¡æ³•è‡ªå‹•è¼‰å…¥æ¨¡å‹</strong>
            <p style="font-size:0.85em; margin:5px 0;">è«‹æ‰‹å‹•é¸å–å°æ‡‰çš„ .onnx æª”æ¡ˆ</p>
            <button class="btn btn-outline" onclick="document.getElementById('modelInput').click()">ğŸ“‚ é¸å– ONNX æª”æ¡ˆ</button>
            <input type="file" id="modelInput" accept=".onnx" style="display:none">
        </div>

        <div style="margin-top:20px;">
            <label><b>1. ä¸Šå‚³åœ–ç‰‡</b></label>
            <div class="upload-box" id="dropZone" onclick="document.getElementById('imgInput').click()">
                <span style="font-size:2em">ğŸ“·</span><br>
                <span id="fileName">é»æ“Šæˆ–æ‹–æ”¾åœ–ç‰‡</span>
                <input type="file" id="imgInput" accept="image/*" style="display:none">
            </div>
        </div>

        <div class="control-group">
            <label><b>2. AI éˆæ•åº¦èª¿æ•´</b></label>
            <div class="slider-label"><span>ä¿ç•™ç´°ç¯€</span><span id="threshVal" style="color:var(--primary); font-weight:bold;">0.2</span><span>å»é™¤èƒŒæ™¯</span></div>
            <input type="range" id="threshold" min="0.05" max="0.95" step="0.05" value="0.2">
        </div>

        <div class="row" style="margin-top:15px;">
            <div class="col"><label>å‚ç›´åˆ—æ•¸</label><input type="number" id="rows" value="2" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;"></div>
            <div class="col"><label>æ°´å¹³è¡Œæ•¸</label><input type="number" id="cols" value="2" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;"></div>
        </div>

        <div style="margin-top:15px;">
            <label>ç™½é‚Šå¯¬åº¦: <span id="borderVal">0</span></label>
            <input type="range" id="borderSize" min="0" max="15" value="0">
        </div>

        <button id="runBtn" class="btn btn-green" disabled>ç­‰å¾…æ¨¡å‹è¼‰å…¥...</button>
    </div>

    <div class="card">
        <h2>ğŸ–¼ï¸ çµæœé è¦½</h2>
        <div id="previewGrid">
            <div style="grid-column:1/-1; text-align:center; color:#999; padding:30px;">
                é è¦½åœ–å°‡é¡¯ç¤ºæ–¼æ­¤
            </div>
        </div>
        <button id="dlBtn" class="btn btn-outline" style="display:none;">ğŸ“¦ ä¸‹è¼‰è²¼åœ–åŒ… (ZIP)</button>
    </div>
</div>

<script>
    ort.env.wasm.wasmPaths = "https://cdn.jsdelivr.net/npm/onnxruntime-web@1.18.0/dist/";
    
    let session = null;
    let currentModelName = 'u2netp'; // ç•¶å‰æ¨¡å‹
    let processedStickers = [];
    
    // æ¨¡å‹ç¶²å€
    const MODELS = {
        'u2netp': 'https://huggingface.co/schyy/u2netp.onnx/resolve/main/u2netp.onnx', // 4MB
        'u2net': 'https://huggingface.co/schyy/u2net-onnx/resolve/main/u2net.onnx'     // 176MB
    };

    const els = {
        status: document.getElementById('status'),
        manual: document.getElementById('manualLoad'),
        modelIn: document.getElementById('modelInput'),
        modelSel: document.getElementById('modelSelect'),
        imgIn: document.getElementById('imgInput'),
        runBtn: document.getElementById('runBtn'),
        preview: document.getElementById('previewGrid'),
        dlBtn: document.getElementById('dlBtn'),
        thresh: document.getElementById('threshold'),
        threshVal: document.getElementById('threshVal')
    };

    // 1. åˆå§‹åŒ–æ¨¡å‹
    async function loadSelectedModel() {
        const modelKey = els.modelSel.value;
        currentModelName = modelKey;
        const url = MODELS[modelKey];
        
        // å¦‚æœæ˜¯æœ¬åœ°æ¸¬è©¦ï¼Œå„ªå…ˆæ‰¾æœ¬åœ°æª”æ¡ˆ
        const localUrl = `./${modelKey}.onnx`;

        els.runBtn.disabled = true;
        els.runBtn.textContent = "è¼‰å…¥æ¨¡å‹ä¸­...";
        els.status.className = "status-bar";
        els.status.textContent = `ğŸ”„ æ­£åœ¨ä¸‹è¼‰ ${modelKey} æ¨¡å‹...è«‹ç¨å€™`;
        els.manual.style.display = 'none';

        try {
            // å˜—è©¦è¼‰å…¥
            try {
                // å…ˆè©¦æœ¬åœ°
                session = await ort.InferenceSession.create(localUrl, { executionProviders: ['wasm', 'webgl'] });
            } catch {
                // æœ¬åœ°å¤±æ•—å‰‡è©¦ç¶²è·¯
                session = await ort.InferenceSession.create(url, { executionProviders: ['wasm', 'webgl'] });
            }
            onModelReady();
        } catch (e) {
            console.error(e);
            els.status.className = "status-bar status-error";
            els.status.textContent = `âŒ ç„¡æ³•è¼‰å…¥ ${modelKey}ã€‚è«‹æ‰‹å‹•é¸å– .onnx æª”æ¡ˆ`;
            els.manual.style.display = "block";
        }
    }

    els.modelSel.addEventListener('change', loadSelectedModel);
    
    // æ‰‹å‹•è¼‰å…¥
    els.modelIn.addEventListener('change', async (e) => {
        if(!e.target.files[0]) return;
        els.status.textContent = "ğŸ”„ è®€å–æª”æ¡ˆä¸­...";
        try {
            const url = URL.createObjectURL(e.target.files[0]);
            session = await ort.InferenceSession.create(url, { executionProviders: ['wasm', 'webgl'] });
            els.manual.style.display = "none";
            onModelReady();
        } catch(err) { alert("æ¨¡å‹æª”æ¡ˆç„¡æ•ˆï¼"); }
    });

    function onModelReady() {
        els.status.className = "status-bar status-success";
        els.status.textContent = `âœ… ${currentModelName} æ¨¡å‹å°±ç·’ï¼`;
        if(els.imgIn.files[0]) els.runBtn.disabled = false;
        els.runBtn.textContent = "é–‹å§‹è£½ä½œ";
    }

    // 2. åœ–ç‰‡è™•ç†
    els.imgIn.addEventListener('change', (e) => {
        if(e.target.files[0]) {
            document.getElementById('fileName').textContent = e.target.files[0].name;
            if(session) els.runBtn.disabled = false;
        }
    });

    els.thresh.addEventListener('input', (e) => els.threshVal.textContent = e.target.value);
    document.getElementById('borderSize').addEventListener('input', e => document.getElementById('borderVal').textContent = e.target.value);

    // åŸ·è¡Œ
    els.runBtn.addEventListener('click', async () => {
        if(!els.imgIn.files[0] || !session) return;
        els.runBtn.disabled = true;
        els.runBtn.textContent = "è™•ç†ä¸­...";
        els.preview.innerHTML = "";
        
        try {
            const img = await loadImage(URL.createObjectURL(els.imgIn.files[0]));
            
            // AI å»èƒŒ
            els.status.textContent = "ğŸ¤– AI é‹ç®—ä¸­ (å¤§åœ–éœ€è¼ƒé•·æ™‚é–“)...";
            // ä½¿ç”¨ã€Œé˜²è®Šå½¢ã€ç¸®æ”¾
            const noBgImg = await runInferenceWithLetterbox(img);
            
            // åˆ‡å‰²
            els.status.textContent = "âœ‚ï¸ åˆ‡å‰²ä¸­...";
            const rows = +document.getElementById('rows').value;
            const cols = +document.getElementById('cols').value;
            const border = +document.getElementById('borderSize').value;
            
            processedStickers = await cutAndSticker(await loadImage(noBgImg), rows, cols, border);
            
            render(processedStickers);
            els.dlBtn.style.display = "block";
            els.status.textContent = "âœ… å®Œæˆï¼";

        } catch (err) {
            console.error(err);
            alert("éŒ¯èª¤: " + err.message);
        } finally {
            els.runBtn.disabled = false;
            els.runBtn.textContent = "å†æ¬¡è£½ä½œ";
        }
    });

    // ========== æ ¸å¿ƒï¼šLetterbox (è£œé»‘é‚Š) é è™•ç† ==========
    // è§£æ±ºé•·æ–¹å½¢åœ–ç‰‡è¢«å£“æ‰å°è‡´ AI å¤±æ•—çš„å•é¡Œ
    async function runInferenceWithLetterbox(img) {
        const size = 320; // æ¨¡å‹è¼¸å…¥å°ºå¯¸
        const cvs = document.createElement('canvas'); 
        cvs.width = size; cvs.height = size;
        const ctx = cvs.getContext('2d');
        
        // 1. è¨ˆç®—ç¸®æ”¾æ¯”ä¾‹ (ä¿æŒé•·å¯¬æ¯”)
        const scale = Math.min(size / img.width, size / img.height);
        const newW = img.width * scale;
        const newH = img.height * scale;
        const offsetX = (size - newW) / 2;
        const offsetY = (size - newH) / 2;

        // 2. å¡«æ»¿é»‘è‰²èƒŒæ™¯ (Padding)
        ctx.fillStyle = "black";
        ctx.fillRect(0, 0, size, size);
        
        // 3. ç•«ä¸Šç¸®æ”¾å¾Œçš„åœ– (ç½®ä¸­)
        ctx.drawImage(img, offsetX, offsetY, newW, newH);
        
        // 4. å–å¾—åƒç´ è³‡æ–™é€²è¡Œæ¨è«–
        const imgData = ctx.getImageData(0, 0, size, size);
        const inputData = new Float32Array(size * size * 3);
        
        for(let i=0; i<imgData.data.length; i+=4) {
            inputData[i/4] = (imgData.data[i]/255 - 0.485)/0.229;
            inputData[i/4 + size*size] = (imgData.data[i+1]/255 - 0.456)/0.224;
            inputData[i/4 + 2*size*size] = (imgData.data[i+2]/255 - 0.406)/0.225;
        }

        const tensor = new ort.Tensor('float32', inputData, [1, 3, size, size]);
        const results = await session.run({ [session.inputNames[0]]: tensor });
        const outputData = results[session.outputNames[0]].data;

        // 5. è™•ç†é®ç½©
        const maskCvs = document.createElement('canvas'); maskCvs.width = size; maskCvs.height = size;
        const maskCtx = maskCvs.getContext('2d');
        const maskImgData = maskCtx.createImageData(size, size);
        
        // è‡ªå‹•å¢å¼·
        let maxVal = 0;
        for(let i=0; i<outputData.length; i++) if(outputData[i] > maxVal) maxVal = outputData[i];
        const boost = maxVal > 0 ? (1/maxVal) : 1;
        const thresh = parseFloat(els.thresh.value);

        for(let i=0; i<outputData.length; i++) {
            let val = outputData[i] * boost;
            let alpha = 0;
            if(val > thresh) alpha = Math.min(255, (val - thresh) / (1 - thresh) * 255);
            maskImgData.data[i*4+3] = alpha;
        }
        maskCtx.putImageData(maskImgData, 0, 0);

        // 6. é‚„åŸå›åŸåœ–å°ºå¯¸ (Remove Padding)
        const finalCvs = document.createElement('canvas');
        finalCvs.width = img.width; finalCvs.height = img.height;
        const finalCtx = finalCvs.getContext('2d');
        
        // ç•«åŸåœ–
        finalCtx.drawImage(img, 0, 0);
        
        // æ‡‰ç”¨é®ç½© (éœ€å°‡é®ç½©ä¸­çš„æœ‰æ•ˆå€åŸŸåˆ‡å‡ºä¾†ï¼Œæ”¾å¤§å›åŸåœ–å¤§å°)
        finalCtx.globalCompositeOperation = 'destination-in';
        finalCtx.drawImage(
            maskCvs, 
            offsetX, offsetY, newW, newH, // ä¾†æºï¼šåªå–æœ‰æ•ˆå€åŸŸ
            0, 0, img.width, img.height   // ç›®çš„ï¼šå¡«æ»¿åŸåœ–
        );

        return finalCvs.toDataURL();
    }

    // åˆ‡å‰²èˆ‡åŠ æ¡† (ä¿æŒä¸è®Š)
    async function cutAndSticker(img, rows, cols, border) {
        const w = img.width; const h = img.height;
        const tileW = Math.floor(w/cols); const tileH = Math.floor(h/rows);
        const res = [];
        const cvs = document.createElement('canvas'); const ctx = cvs.getContext('2d');
        const sCvs = document.createElement('canvas'); sCvs.width=180; sCvs.height=180; const sCtx = sCvs.getContext('2d');

        for(let r=0; r<rows; r++) {
            for(let c=0; c<cols; c++) {
                cvs.width=tileW; cvs.height=tileH;
                ctx.clearRect(0,0,tileW,tileH);
                ctx.drawImage(img, c*tileW, r*tileH, tileW, tileH, 0, 0, tileW, tileH);
                sCtx.clearRect(0,0,180,180);
                const tImg = await loadImage(cvs.toDataURL());
                const scale = Math.min(180/tImg.width, 180/tImg.height);
                const dw = tImg.width*scale; const dh = tImg.height*scale;
                sCtx.drawImage(tImg, (180-dw)/2, (180-dh)/2, dw, dh);
                if(border > 0) {
                    sCtx.strokeStyle="white"; sCtx.lineWidth=border*2; sCtx.strokeRect(0,0,180,180);
                }
                res.push({ url: sCvs.toDataURL(), name: `${res.length+1}.png` });
            }
        }
        return res;
    }

    function render(list) { els.preview.innerHTML = list.map(s => `<div class="sticker"><img src="${s.url}"></div>`).join(''); }
    
    els.dlBtn.onclick = () => {
        const zip = new JSZip();
        processedStickers.forEach(s => zip.file(s.name, s.url.split(',')[1], {base64:true}));
        zip.generateAsync({type:"blob"}).then(b => saveAs(b, "LineStickers.zip"));
    };
    function loadImage(src) { return new Promise(r => { const i=new Image(); i.onload=()=>r(i); i.src=src; }); }

    // é è¨­è¼‰å…¥è¼•é‡ç‰ˆ
    loadSelectedModel();
</script>

</body>
</html>
